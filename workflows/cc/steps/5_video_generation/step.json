{
  "step_id": "video_generation",
  "name": "Step {step_number}: Video Generation",
  "description": "Select motion elements, generate video prompts, and create videos",
  "modules": [
    {
      "module_id": "user.select",
      "inputs": {
        "resolver_schema": {
          "type": "object",
          "properties": {
            "data": { "resolver": "server" }
          }
        },
        "data": {
          "detected": "{{ state.image_analysis.motion_elements.detected_elements }}"
        },
        "schema": {
          "$ref": "schemas/cc_motion_elements_display_schema.json",
          "type": "json"
        },
        "prompt": "Select motion elements to animate in your video",
        "multi_select": true,
        "mode": "select"
      },
      "outputs_to_state": {
        "selected_indices": "selected_motion_element_indices",
        "selected_data": "selected_motion_elements"
      },
      "name": "select_motion_elements"
    },
    {
      "module_id": "media.generateV2",
      "inputs": {
        "resolver_schema": {
          "type": "object",
          "properties": {
            "prompt_config": { "resolver": "server" },
            "display_schema": { "resolver": "server" },
            "source_image": { "resolver": "server" }
          }
        },
        "action_type": "img2vid",
        "providers": ["leonardo", "openai"],
        "prompt_config": {
          "resolver_schema": {
            "type": "object",
            "properties": {
              "system": { "resolver": "server" },
              "user": { "resolver": "server" },
              "shared_prompt": { "resolver": "server" },
              "provider_prompts": { "resolver": "server" },
              "metadata": { "resolver": "server" }
            }
          },
          "provider": "openai",
          "ai_config": {},
          "metadata": {
            "step_id": "{{ step.step_id }}"
          },
          "system": [
            {
              "$ref": "prompts/cc_role_motion_engineer.txt",
              "type": "text",
              "cache_ttl": 10800
            },
            {
              "$ref": "prompts/cc_video_prompts_system.txt",
              "type": "text",
              "cache_ttl": 10800
            }
          ],
          "user": {
            "$ref": "prompts/cc_video_prompts_user.txt",
            "type": "jinja2"
          },
          "shared_prompt": {
            "$ref": "prompts/cc_video_prompts_shared.txt",
            "type": "text"
          },
          "provider_prompts": {
            "leonardo": {
              "$ref": "prompts/cc_video_prompts_provider_leonardo.txt",
              "type": "text"
            },
            "openai": {
              "$ref": "prompts/cc_video_prompts_provider_openai.txt",
              "type": "text"
            }
          }
        },
        "display_schema": {
          "$ref": "schemas/cc_video_generation_display_schema.json",
          "type": "json"
        },
        "title": "Generate and Select Videos",
        "source_image": "{{ state.selected_image_data }}"
      },
      "outputs_to_state": {
        "selected_content_id": "selected_video_id",
        "selected_content": "selected_video_data",
        "generations": "video_generations",
        "generated_prompts": "video_prompts"
      },
      "sub_actions": [
        {
          "id": "video_generation",
          "label": "Generate Videos",
          "loading_label": "Generating...",
          "hidden": true,
          "actions": [
            {
              "type": "self_sub_action"
            }
          ]
        }
      ],
      "retryable": {
        "default_option": "continue",
        "options": [
          {
            "id": "continue",
            "mode": "continue",
            "label": "Accept and continue",
            "validations": [
              {
                "id": "warn_no_video_generation",
                "rule": "response_field_not_empty",
                "field": "generations",
                "severity": "warning",
                "message": "You haven't generated any videos yet. Continue without generating?",
                "validator": ["webui", "server"]
              }
            ]
          },
          {
            "id": "retry_prompts",
            "mode": "retry",
            "label": "Regenerate video prompts",
            "shortcut": "r",
            "target_module": "generate_and_select_videos_v2",
            "hidden": true,
            "feedback": {
              "enabled": true,
              "prompt": "What should be different?",
              "default_message": "Please generate different video prompts."
            }
          },
          {
            "id": "change_motion_elements",
            "mode": "jump",
            "label": "Change motion elements",
            "target_step": "video_generation",
            "hidden": true,
            "target_module": "select_motion_elements"
          },
          {
            "id": "change_image",
            "mode": "jump",
            "label": "Go back to image selection",
            "hidden": true,
            "target_step": "image_prompts",
            "target_module": "generate_and_select_images_v2"
          }
        ]
      },
      "name": "generate_and_select_videos_v2"
    }
  ]
}
