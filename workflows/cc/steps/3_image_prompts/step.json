{
  "step_id": "image_prompts",
  "name": "Step {step_number}: Generate Image Prompts",
  "description": "Generate optimized prompts for Midjourney, Leonardo Phoenix, Sora, and Stable Diffusion",
  "modules": [
    {
      "module_id": "api.llm",
      "inputs": {
        "resolver_schema": {
          "type": "object",
          "properties": {
            "input": {
              "resolver": "server"
            },
            "system": {
              "resolver": "server"
            },
            "metadata": {
              "resolver": "server"
            }
          }
        },
        "ai_config": {},
        "input": {
          "$ref": "prompts/cc_image_prompts_user.txt",
          "type": "jinja2"
        },
        "output_schema": {
          "$ref": "schemas/cc_image_prompts_schema.json",
          "type": "json"
        },
        "metadata": {
          "step_id": "{{ step.step_id }}"
        },
        "system": [
          {
            "$ref": "prompts/cc_role_prompt_engineer.txt",
            "type": "text",
            "cache_ttl": 10800
          },
          {
            "$ref": "prompts/cc_image_prompts_system.txt",
            "type": "text",
            "cache_ttl": 10800
          }
        ],
        "provider": "openai"
      },
      "outputs_to_state": {
        "response": "image_prompts"
      },
      "name": "generate_image_prompts"
    },
    {
      "module_id": "api.fetch",
      "inputs": {
        "url": "/wm-api/models/by_category",
        "base_url": "http://172.18.48.1:7860",
        "method": "GET",
        "extract_path": "categories",
        "error_on_failure": true
      },
      "outputs_to_state": {
        "response": "sd_model_categories"
      },
      "name": "fetch_sd_models"
    },
    {
      "module_id": "media.generate",
      "inputs": {
        "resolver_schema": {
          "type": "object",
          "properties": {
            "prompts": {
              "resolver": "server"
            },
            "schema": {
              "resolver": "server"
            }
          }
        },
        "prompts": "{{ state.image_prompts }}",
        "schema": {
          "$ref": "schemas/cc_image_prompts_display_schema.json",
          "type": "json"
        },
        "title": "Generate and Select Images"
      },
      "outputs_to_state": {
        "selected_content_id": "selected_image_id",
        "selected_content": "selected_image_data",
        "generations": "image_generations"
      },
      "sub_actions": [
        {
          "id": "generate",
          "label": "Generate Images",
          "action_type": "txt2img",
          "loading_label": "Generating...",
          "result_key": "generations"
        }
      ],
      "retryable": {
        "default_option": "continue",
        "options": [
          {
            "id": "continue",
            "mode": "continue",
            "label": "Accept and continue"
          },
          {
            "id": "retry",
            "mode": "retry",
            "label": "Regenerate prompts",
            "shortcut": "r",
            "target_module": "generate_image_prompts",
            "feedback": {
              "enabled": true,
              "prompt": "What should be different?",
              "default_message": "Please generate different image prompts with more variety in composition and mood."
            }
          },
          {
            "id": "change_scene",
            "mode": "jump",
            "label": "Choose different scene",
            "target_step": "scene_generation",
            "target_module": "select_scene"
          }
        ]
      },
      "name": "generate_and_select_images"
    }
  ]
}
