{
  "step_id": "scene_generation",
  "name": "Step {step_number}: Generate Scene Concepts",
  "description": "Generate and select a scene concept for your pet video",
  "modules": [
    {
      "module_id": "io.weighted_keywords",
      "inputs": {
        "resolver_schema": {
          "type": "object",
          "properties": {
            "pipeline": { "resolver": "server" }
          }
        },
        "mode": "load",
        "pipeline": [
          {"$match": {"category": {"$in": ["setting", "behavior", "object"]}}},
          {"$sort": {"weight": -1}},
          {"$limit": 50}
        ]
      },
      "outputs_to_state": {
        "weighted_keywords": "loaded_keywords",
        "count": "keyword_count"
      },
      "name": "load_keywords"
    },
    {
      "module_id": "transform.extract",
      "inputs": {
        "resolver_schema": {
          "type": "object",
          "properties": {
            "exclusion_list": { "resolver": "server" }
          }
        },
        "exclusion_list": "{% set kws = [] %}{% for kw in state.loaded_keywords %}{% set _ = kws.append(kw.keyword) %}{% endfor %}{{ kws }}"
      },
      "outputs_to_state": {
        "exclusion_list": "keyword_exclusion_list"
      },
      "name": "build_exclusion_list"
    },
    {
      "module_id": "api.llm",
      "inputs": {
        "resolver_schema": {
          "type": "object",
          "properties": {
            "input": { "resolver": "server" },
            "system": { "resolver": "server" },
            "metadata": { "resolver": "server" }
          }
        },
        "ai_config": {},
        "input": {
          "$ref": "prompts/scene_generation_user.txt",
          "type": "jinja2"
        },
        "output_schema": {
          "$ref": "schemas/scene_concepts_schema.json",
          "type": "json"
        },
        "metadata": {
          "step_id": "{{ step.step_id }}"
        },
        "system": [
          {
            "$ref": "prompts/role_pet_storyteller.txt",
            "type": "text",
            "cache_ttl": 10800
          },
          {
            "$ref": "prompts/scene_generation_system.txt",
            "type": "text",
            "cache_ttl": 10800
          }
        ],
        "provider": "openai"
      },
      "outputs_to_state": {
        "response": "scene_concepts"
      },
      "name": "generate_scenes"
    },
    {
      "module_id": "transform.query",
      "inputs": {
        "resolver_schema": {
          "type": "object",
          "properties": {
            "data": { "resolver": "server" }
          }
        },
        "data": "{{ state.scene_concepts.scenes }}",
        "pipeline": [
          {"$unwind": "$scene_keywords"},
          {"$replaceRoot": {"newRoot": "$scene_keywords"}},
          {"$addFields": {"source": "generated"}}
        ]
      },
      "outputs_to_state": {
        "result": "flattened_keywords"
      },
      "name": "flatten_keywords"
    },
    {
      "module_id": "io.weighted_keywords",
      "inputs": {
        "resolver_schema": {
          "type": "object",
          "properties": {
            "weighted_keywords": { "resolver": "server" }
          }
        },
        "mode": "save",
        "weighted_keywords": "{{ state.flattened_keywords }}"
      },
      "outputs_to_state": {
        "saved_count": "keywords_saved_count"
      },
      "name": "save_keywords"
    },
    {
      "module_id": "user.select",
      "inputs": {
        "resolver_schema": {
          "type": "object",
          "properties": {
            "data": { "resolver": "server" }
          }
        },
        "prompt": "Select a scene concept for your video",
        "data": "{{ state.scene_concepts }}",
        "schema": {
          "$ref": "schemas/scene_display_schema.json",
          "type": "json"
        },
        "multi_select": false,
        "mode": "select"
      },
      "outputs_to_state": {
        "selected_indices": "selected_scene_indices",
        "selected_data": "selected_scene"
      },
      "retryable": {
        "default_option": "continue",
        "options": [
          {
            "id": "continue",
            "mode": "continue",
            "label": "Continue"
          },
          {
            "id": "retry",
            "mode": "retry",
            "label": "Generate new scenes",
            "shortcut": "r",
            "target_module": "generate_scenes",
            "feedback": {
              "enabled": true,
              "prompt": "What would you like different in the new scenes?",
              "default_message": "Please generate 3 completely different scene concepts. Avoid similar themes or settings to the previous options."
            }
          }
        ]
      },
      "name": "select_scene"
    },
    {
      "module_id": "transform.extract",
      "inputs": {
        "resolver_schema": {
          "type": "object",
          "properties": {
            "scene": { "resolver": "server" }
          }
        },
        "scene": "{{ state.scene_concepts[state.selected_scene_indices[0]][state.selected_scene_indices[1]] }}"
      },
      "outputs_to_state": {
        "scene": "selected_scene"
      },
      "name": "store_selected_scene"
    },
    {
      "module_id": "transform.query",
      "inputs": {
        "resolver_schema": {
          "type": "object",
          "properties": {
            "data": { "resolver": "server" }
          }
        },
        "data": [{"scene": "{{ state.selected_scene }}"}],
        "pipeline": [
          {"$unwind": "$scene.scene_keywords"},
          {"$replaceRoot": {"newRoot": "$scene.scene_keywords"}},
          {"$addFields": {"source": "selected"}}
        ]
      },
      "outputs_to_state": {
        "result": "selected_keywords"
      },
      "name": "extract_selected_keywords"
    },
    {
      "module_id": "io.weighted_keywords",
      "inputs": {
        "resolver_schema": {
          "type": "object",
          "properties": {
            "weighted_keywords": { "resolver": "server" }
          }
        },
        "mode": "save",
        "weighted_keywords": "{{ state.selected_keywords }}",
        "accumulate_weight": false
      },
      "outputs_to_state": {
        "saved_count": "keywords_updated_count"
      },
      "name": "update_selected_keywords"
    }
  ]
}
