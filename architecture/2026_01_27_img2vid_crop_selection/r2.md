# Image Crop Selection for img2vid

## Summary

Add interactive crop selection when generating videos from images. Some video
generation providers (like Sora) require specific aspect ratios. This feature
allows users to select a region of the source image before generation, ensuring
the cropped area matches the target aspect ratio.

## User Flow

1. User is on video generation step (step 5 of CC workflow)
2. User configures generation parameters (model, duration, etc.)
3. User clicks "Generate Videos" button
4. **Crop Selection Modal appears** with:
   - Source image displayed large
   - Draggable/resizable crop overlay (unselected area darkened)
   - Aspect ratio selector dropdown (9:16, 16:9, 2:3, 3:2, 3:4, 4:3, 1:1, Free)
   - Checkbox: "Save selection for this session"
   - "Use Full Image" button (skip crop, use as-is)
   - "Generate with Selection" button
5. User selects crop region (locked to chosen aspect ratio unless "Free")
6. User clicks "Generate with Selection"
7. If "Save selection" checked:
   - Subsequent "Generate" clicks (any provider) skip the modal
   - Use saved crop region automatically
8. Generation proceeds with cropped image
9. If generation fails: auto-reset saved preference
10. User can:
    - Click "Reset crop" button in preview bar to clear preference
    - Click "View crop" button to open modal in view-only mode (no submit)

## Technical Design

### UI Components (WebUI)

#### New Component: `CropSelectionModal`

Location: `ui/webui/src/interactions/types/media-generation/CropSelectionModal.tsx`

```typescript
interface CropSelectionModalProps {
  open: boolean;
  onClose: () => void;
  imageUrl: string;
  imageDimensions: { width: number; height: number };
  onConfirm: (cropRegion: CropRegion | null) => void;
  initialCrop?: CropRegion;
  initialAspectRatio?: string;
  viewOnly?: boolean;  // When true, hide submit buttons (view-only mode)
}

interface CropRegion {
  x: number;       // pixels from left
  y: number;       // pixels from top
  width: number;   // crop width in pixels
  height: number;  // crop height in pixels
}
```

Features:
- Display source image at appropriate size (fit within modal)
- Overlay a draggable, resizable selection rectangle
- Darken unselected area (standard crop tool behavior)
- Lock selection to aspect ratio (unless "Free" selected)
- Calculate pixel coordinates relative to original image dimensions
- Support touch/mouse interactions
- View-only mode: show current selection without action buttons

#### State Management in MediaGenerationContext

Crop state is **global** (not per-provider) - when user makes a selection,
they want it applied to all providers.

Add to `MediaGenerationContext.tsx`:

```typescript
interface CropState {
  region: CropRegion;
  aspectRatio: string;
}

// In context value
interface MediaGenerationContextValue {
  // ... existing fields ...

  // Crop selection state (global, session-only)
  savedCrop: CropState | null;
  setSavedCrop: (crop: CropState | null) => void;
  clearSavedCrop: () => void;
}
```

#### Modified Generate Flow

In `MediaPanel.tsx`, modify `handleGenerate`:

```typescript
const handleGenerate = (action: SubActionConfig) => {
  // Only show crop modal for img2vid actions
  if (action.action_type === "img2vid") {
    if (savedCrop) {
      // Use saved crop, skip modal
      executeWithCrop(action, savedCrop.region);
    } else {
      // Show crop modal
      setPendingAction(action);
      setShowCropModal(true);
    }
  } else {
    // txt2img/img2img - no crop needed
    executeSubAction(path, action, params, { provider, promptId });
  }
};

const executeWithCrop = (action: SubActionConfig, cropRegion: CropRegion | null) => {
  const params = inputSchemaContext.getMappedValues();

  // Add crop region to params if provided
  if (cropRegion) {
    params.crop_region = cropRegion;
  }

  executeSubAction(path, action, params, { provider, promptId });
};
```

#### Preview Bar Updates

In the preview info bar (where Resolution/Credits are shown), add:

```typescript
{/* When crop is saved, show View/Reset buttons */}
{savedCrop && (
  <>
    <span className="text-muted-foreground/50">•</span>
    <span className="flex items-center gap-1.5">
      <span className="font-medium text-foreground">Crop:</span>
      {savedCrop.region.width} × {savedCrop.region.height}
      <Button variant="ghost" size="xs" onClick={openViewCropModal}>
        View
      </Button>
      <Button variant="ghost" size="xs" onClick={clearSavedCrop}>
        Reset
      </Button>
    </span>
  </>
)}
```

### Data Flow

#### Sub-Action Request

Add crop region to params:

```typescript
// In params sent to sub-action API
{
  prompt: "...",
  model: "sora-2",
  aspect_ratio: "9:16",
  duration: "4",
  source_image: { url: "...", local_path: "...", content_id: "..." },
  // NEW: crop region (optional)
  crop_region: {
    x: 100,
    y: 50,
    width: 720,
    height: 1280
  }
}
```

### Backend Changes

#### Image Cropping Utility

Location: `backend/server/modules/media/image_utils.py`

```python
from PIL import Image
from typing import Dict
import os
import tempfile


def crop_image(
    source_path: str,
    crop_region: Dict[str, int],
    output_format: str = "PNG"
) -> str:
    """
    Crop an image to the specified region.

    Args:
        source_path: Path to source image file
        crop_region: Dict with x, y, width, height in pixels
        output_format: Output format (PNG, JPEG, WEBP)

    Returns:
        Path to cropped image (temporary file)
    """
    x = crop_region["x"]
    y = crop_region["y"]
    width = crop_region["width"]
    height = crop_region["height"]

    with Image.open(source_path) as img:
        # Clamp crop region to image bounds
        img_width, img_height = img.size
        x = max(0, min(x, img_width - 1))
        y = max(0, min(y, img_height - 1))
        right = min(x + width, img_width)
        bottom = min(y + height, img_height)

        # PIL crop uses (left, upper, right, lower) box
        cropped = img.crop((x, y, right, bottom))

        # Preserve original format if possible
        original_format = img.format or output_format
        suffix = f".{original_format.lower()}"
        if suffix == ".jpeg":
            suffix = ".jpg"

        fd, temp_path = tempfile.mkstemp(suffix=suffix)
        os.close(fd)

        # Save with appropriate settings
        if original_format.upper() in ("JPEG", "JPG"):
            cropped.save(temp_path, format="JPEG", quality=95)
        else:
            cropped.save(temp_path, format=original_format)

        return temp_path
```

#### Modify `sub_action.py`

In `execute_media_sub_action`, before calling provider:

```python
# For img2vid with crop_region, crop the image first
if request.action_type == "img2vid":
    source_image = request.params.get("source_image")
    crop_region = request.params.get("crop_region")

    if crop_region and isinstance(source_image, dict):
        local_path = source_image.get("local_path")
        if local_path:
            from .image_utils import crop_image
            cropped_path = crop_image(local_path, crop_region)
            # Update source_image to use cropped version
            source_image = {**source_image, "local_path": cropped_path}
            request.params["source_image"] = source_image
```

#### Dependencies

Add to `requirements.txt`:
```
Pillow>=10.0.0
```

### Aspect Ratios

Standard ratios to support:

| Ratio | Label | Common Use |
|-------|-------|------------|
| 9:16  | 9:16 (Portrait) | TikTok, Reels, Shorts |
| 16:9  | 16:9 (Landscape) | YouTube, TV |
| 2:3   | 2:3 (Portrait) | Photos |
| 3:2   | 3:2 (Landscape) | Photos |
| 3:4   | 3:4 (Portrait) | Instagram |
| 4:3   | 4:3 (Landscape) | Classic TV |
| 1:1   | 1:1 (Square) | Instagram |
| Free  | Free Selection | Any ratio |

### Error Handling

1. **Generation failure**: Auto-reset saved crop preference
2. **Invalid crop region**: Clamp to image bounds (handled in `crop_image`)
3. **Missing source image**: Show error, don't open crop modal

### UI Library

Using `react-image-crop`:
- Well-maintained, TypeScript support
- Aspect ratio lock built-in
- Darkening of unselected area is default behavior
- Good touch support

Install: `npm install react-image-crop`

## Files to Modify

### New Files
- `ui/webui/src/interactions/types/media-generation/CropSelectionModal.tsx`
- `backend/server/modules/media/image_utils.py`

### Modified Files
- `ui/webui/src/interactions/types/media-generation/MediaPanel.tsx`
  - Modify handleGenerate to show modal for img2vid
  - Add View/Reset crop buttons in preview bar
- `ui/webui/src/interactions/types/media-generation/MediaGenerationContext.tsx`
  - Add global crop state (savedCrop, setSavedCrop, clearSavedCrop)
- `ui/webui/src/interactions/types/media-generation/MediaGeneration.tsx`
  - Initialize crop state
  - Clear crop on generation error
- `ui/webui/src/interactions/types/media-generation/types.ts`
  - Add CropRegion interface
  - Add CropState interface
- `backend/server/modules/media/sub_action.py`
  - Add crop processing before provider call
- `requirements.txt`
  - Add Pillow dependency
- `ui/webui/package.json`
  - Add react-image-crop dependency

## Summary of Design Decisions

1. **Crop preference is global** (not per-provider) - applies to all providers
2. **Session-only storage** - resets on page refresh
3. **Auto-reset on failure** - cleared when generation fails
4. **Darkened overlay** - unselected area darkened (react-image-crop default)
5. **View-only mode** - can view saved crop without submitting
6. **Preview bar buttons** - View/Reset in the Resolution/Credits bar
