# Image Crop Selection for img2vid

## Summary

Add interactive crop selection when generating videos from images. Some video
generation providers (like Sora) require specific aspect ratios. This feature
allows users to select a region of the source image before generation, ensuring
the cropped area matches the target aspect ratio.

## User Flow

1. User is on video generation step (step 5 of CC workflow)
2. User configures generation parameters (model, duration, etc.)
3. User clicks "Generate Videos" button
4. **Crop Selection Popup appears** with:
   - Source image displayed large
   - Draggable/resizable crop overlay on the image
   - Aspect ratio selector dropdown (9:16, 16:9, 2:3, 3:2, 3:4, 4:3, 1:1, Free)
   - Checkbox: "Save selection for this session"
   - "Use Full Image" button (skip crop, use as-is)
   - "Generate with Selection" button
5. User selects crop region (locked to chosen aspect ratio unless "Free")
6. User clicks "Generate with Selection"
7. If "Save selection" checked:
   - Subsequent "Generate" clicks skip the popup
   - Use saved crop region automatically
8. Generation proceeds with cropped image
9. If generation fails: auto-reset saved preference
10. User can reset preference via a "Reset crop selection" button

## Technical Design

### UI Components (WebUI)

#### New Component: `CropSelectionModal`

Location: `ui/webui/src/interactions/types/media-generation/CropSelectionModal.tsx`

```typescript
interface CropSelectionModalProps {
  open: boolean;
  onClose: () => void;
  imageUrl: string;
  imageDimensions: { width: number; height: number };
  onConfirm: (cropRegion: CropRegion | null) => void;
  initialAspectRatio?: string;
}

interface CropRegion {
  x: number;       // pixels from left
  y: number;       // pixels from top
  width: number;   // crop width in pixels
  height: number;  // crop height in pixels
}
```

Features:
- Display source image at appropriate size (fit within modal)
- Overlay a draggable, resizable selection rectangle
- Lock selection to aspect ratio (unless "Free" selected)
- Calculate pixel coordinates relative to original image dimensions
- Support touch/mouse interactions

#### State Management in MediaPanel

New state in `MediaPanel.tsx` or `MediaGenerationContext`:
```typescript
// Per-provider crop state (session only, not persisted)
const [savedCropByProvider, setSavedCropByProvider] = useState<
  Record<string, { region: CropRegion; aspectRatio: string } | null>
>({});
const [showCropModal, setShowCropModal] = useState(false);
const [pendingAction, setPendingAction] = useState<SubActionConfig | null>(null);
```

#### Modified Generate Flow

In `MediaPanel.tsx`, modify `handleGenerate`:

```typescript
const handleGenerate = (action: SubActionConfig) => {
  // Only show crop modal for img2vid actions
  if (action.action_type === "img2vid") {
    
    <!--lets not save crop by provider, almost in call cases, when use make
    selection, they want it applied to all providers-->

    const savedCrop = savedCropByProvider[provider];
    if (savedCrop) {
      // Use saved crop, skip modal
      executeWithCrop(action, savedCrop.region);
    } else {
      // Show crop modal
      setPendingAction(action);
      setShowCropModal(true);
    }
  } else {
    // txt2img/img2img - no crop needed
    executeSubAction(path, action, params, { provider, promptId });
  }
};
```

### Data Flow

#### Sub-Action Request (existing `SubActionRequest` type)

Add crop region to params:

```typescript
// In params sent to sub-action API
{
  prompt: "...",
  model: "sora-2",
  aspect_ratio: "9:16",
  duration: "4",
  source_image: { url: "...", local_path: "...", content_id: "..." },
  // NEW: crop region (optional)
  crop_region: {
    x: 100,
    y: 50,
    width: 720,
    height: 1280
  }
}
```

### Backend Changes

#### Image Cropping Utility

Location: `backend/server/modules/media/image_utils.py`

```python
from PIL import Image
from typing import Optional, Dict, Any
import os
import tempfile

def crop_image(
    source_path: str,
    crop_region: Dict[str, int],
    output_format: str = "PNG"
) -> str:
    """
    Crop an image to the specified region.

    Args:
        source_path: Path to source image file
        crop_region: Dict with x, y, width, height in pixels
        output_format: Output format (PNG, JPEG, WEBP)

    Returns:
        Path to cropped image (temporary file)
    """
    x = crop_region["x"]
    y = crop_region["y"]
    width = crop_region["width"]
    height = crop_region["height"]

    with Image.open(source_path) as img:
        # PIL crop uses (left, upper, right, lower) box
        cropped = img.crop((x, y, x + width, y + height))

        # Save to temp file
        suffix = f".{output_format.lower()}"
        fd, temp_path = tempfile.mkstemp(suffix=suffix)
        os.close(fd)

        cropped.save(temp_path, format=output_format)
        return temp_path
```

#### Modify `sub_action.py`

In `execute_media_sub_action`, before calling provider:

```python
# For img2vid with crop_region, crop the image first
if request.action_type == "img2vid":
    source_image = request.params.get("source_image")
    crop_region = request.params.get("crop_region")

    if crop_region and isinstance(source_image, dict):
        local_path = source_image.get("local_path")
        if local_path:
            from .image_utils import crop_image
            cropped_path = crop_image(local_path, crop_region)
            # Update source_image to use cropped version
            source_image = {**source_image, "local_path": cropped_path}
            request.params["source_image"] = source_image
```

#### Dependencies

Add to `requirements.txt`:
```
Pillow>=10.0.0
```

### Aspect Ratios

Standard ratios to support:

| Ratio | Label | Common Use |
|-------|-------|------------|
| 9:16  | 9:16 (Portrait) | TikTok, Reels, Shorts |
| 16:9  | 16:9 (Landscape) | YouTube, TV |
| 2:3   | 2:3 (Portrait) | Photos |
| 3:2   | 3:2 (Landscape) | Photos |
| 3:4   | 3:4 (Portrait) | Instagram |
| 4:3   | 4:3 (Landscape) | Classic TV |
| 1:1   | 1:1 (Square) | Instagram |
| Free  | Free Selection | Any ratio |

### Error Handling

1. **Generation failure**: Auto-reset saved crop preference for that provider
2. **Invalid crop region**: If crop extends beyond image bounds, clamp to image
3. **Missing source image**: Show error, don't open crop modal

### UI Library for Crop

Options for implementing the crop UI:
1. **react-image-crop**: Popular, maintained, supports aspect ratio lock
2. **react-easy-crop**: Simple API, good mobile support
3. **Custom implementation**: Full control, more work

<!--lets go with following-->
Recommendation: `react-image-crop` - well-maintained, TypeScript support,
aspect ratio lock built-in.

## Files to Modify

### New Files
- `ui/webui/src/interactions/types/media-generation/CropSelectionModal.tsx`
- `backend/server/modules/media/image_utils.py`

### Modified Files
- `ui/webui/src/interactions/types/media-generation/MediaPanel.tsx`
  - Add crop state management
  - Modify handleGenerate to show modal for img2vid
  - Add "Reset crop" button
- `ui/webui/src/interactions/types/media-generation/MediaGenerationContext.tsx`
  - Add crop-related state and callbacks to context
- `ui/webui/src/interactions/types/media-generation/types.ts`
  - Add CropRegion interface
- `backend/server/modules/media/sub_action.py`
  - Add crop processing before provider call
- `requirements.txt`
  - Add Pillow dependency

## Questions for Review

1. Should the crop modal have a preview of what the final cropped image looks
   like before confirming?

<!--I dont need hard preview, but something like darkening unselected area is
enough-->

2. For the "Reset crop" button location - should it be:
   - In the preview info bar (next to Resolution/Credits)?
   - As a small icon next to the Generate button?
   - Inside the crop modal only?

   <!--#1, we can change later if needed-->

3. Should we show the currently saved crop dimensions somewhere in the UI
   when a preference is saved?

   <!--we can have button to show modal and see the selection. in that mode,
   there's no button to submit to api-->
