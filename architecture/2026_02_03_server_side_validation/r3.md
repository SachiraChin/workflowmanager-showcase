# Server-Side Interaction Validation Architecture - Revision 3

## Summary

The current interaction system has no server-side validation for responses.
Validation logic (like "require image selection before continue") is either
hardcoded in frontend components or missing entirely. This document proposes
a generic validation system that:

1. Validates interaction responses on both client and server
2. Supports both hard errors (block action) and soft warnings (confirm popup)
3. Is configured via workflow step.json, not hardcoded in UI components
4. Works for any module type and any action (continue, retry, jump)

**Immediate Use Case**: CC workflow step 3 (images) should disable "Accept and
continue" until user selects an image. Steps 5 & 7 (videos/music) should show
a confirmation popup if user continues without generating content.

## Changes from R2

Based on feedback:

1. **Validator field**: Added `validator` field to specify which layers validate
   each rule: `["webui", "server"]` or just one of them.

2. **Error display**: Validation errors shown in footer area.

3. **Scope**: Focus on steps 3, 5, 7 continue actions only. Retry validations
   deferred until retry functionality is fixed.

## Final Design

### Validation Config Structure

```json
{
  "module_id": "media.generate",
  "retryable": {
    "default_option": "continue",
    "options": [
      {
        "id": "continue",
        "mode": "continue",
        "label": "Accept and continue",
        "validations": [
          {
            "id": "require_image_selection",
            "rule": "response_field_required",
            "field": "selected_content_id",
            "severity": "error",
            "message": "Please select an image before continuing",
            "validator": ["webui", "server"]
          }
        ]
      }
    ]
  }
}
```

### Validation Fields

| Field      | Type       | Required | Description                                   |
|------------|------------|----------|-----------------------------------------------|
| `id`       | string     | Yes      | Unique identifier for this validation         |
| `rule`     | string     | Yes      | Rule name from registry                       |
| `field`    | string     | Depends  | Response field to validate (rule-dependent)   |
| `severity` | string     | Yes      | `"error"` or `"warning"`                      |
| `message`  | string     | Yes      | Human-readable error message                  |
| `validator`| string[]   | No       | Which layers validate: `["webui", "server"]`  |
| `value`    | any        | No       | For `response_field_equals` rule              |
| `min`      | number     | No       | For `min_selections` rule                     |

Default for `validator` is `["webui", "server"]` (both validate).

### Validation Rules

| Rule Name                 | Description                              | Params           |
|---------------------------|------------------------------------------|------------------|
| `response_field_required` | Field must be present and non-null       | `field`          |
| `response_field_not_empty`| Field must have length > 0 (array/dict)  | `field`          |
| `response_field_equals`   | Field must equal specific value          | `field`, `value` |
| `min_selections`          | selected_indices length >= N             | `min`            |

### Severity Levels

| Severity  | Client Behavior                            | Server Behavior        |
|-----------|--------------------------------------------|------------------------|
| `error`   | Button disabled until valid                | Reject response        |
| `warning` | Button enabled, popup on click if invalid  | Accept if confirmed    |

### Step Configurations

**Step 3 - Images (require selection):**
```json
{
  "module_id": "media.generate",
  "retryable": {
    "default_option": "continue",
    "options": [
      {
        "id": "continue",
        "mode": "continue",
        "label": "Accept and continue",
        "validations": [
          {
            "id": "require_image_selection",
            "rule": "response_field_required",
            "field": "selected_content_id",
            "severity": "error",
            "message": "Please select an image before continuing",
            "validator": ["webui", "server"]
          }
        ]
      },
      {
        "id": "retry",
        "mode": "retry",
        "label": "Regenerate prompts",
        "shortcut": "r",
        "target_module": "generate_image_prompts",
        "hidden": true,
        "feedback": {
          "enabled": true,
          "prompt": "What should be different?",
          "default_message": "Please generate different image prompts with more variety in composition and mood."
        }
      },
      {
        "id": "change_scene",
        "mode": "jump",
        "hidden": true,
        "label": "Choose different scene",
        "target_step": "scene_generation",
        "target_module": "select_scene"
      }
    ]
  },
  "name": "generate_and_select_images"
}
```

**Step 5 - Videos (warn if no generation):**
```json
{
  "module_id": "media.generate",
  "retryable": {
    "default_option": "continue",
    "options": [
      {
        "id": "continue",
        "mode": "continue",
        "label": "Accept and continue",
        "validations": [
          {
            "id": "warn_no_video_generation",
            "rule": "response_field_not_empty",
            "field": "generations",
            "severity": "warning",
            "message": "You haven't generated any videos. Continue anyway?",
            "validator": ["webui", "server"]
          }
        ]
      },
      {
        "id": "retry_prompts",
        "mode": "retry",
        "label": "Regenerate video prompts",
        "shortcut": "r",
        "target_module": "generate_video_prompts",
        "hidden": true,
        "feedback": {
          "enabled": true,
          "prompt": "What should be different?",
          "default_message": "Please generate different video prompts."
        }
      },
      {
        "id": "change_motion_elements",
        "mode": "jump",
        "label": "Change motion elements",
        "target_step": "video_generation",
        "hidden": true,
        "target_module": "select_motion_elements"
      },
      {
        "id": "change_image",
        "mode": "jump",
        "label": "Go back to image selection",
        "hidden": true,
        "target_step": "image_prompts",
        "target_module": "generate_and_select_images"
      }
    ]
  },
  "name": "generate_and_select_videos"
}
```

**Step 7 - Music (warn if no generation):**
```json
{
  "module_id": "media.generate",
  "retryable": {
    "default_option": "continue",
    "options": [
      {
        "id": "continue",
        "mode": "continue",
        "label": "Accept and continue",
        "validations": [
          {
            "id": "warn_no_music_generation",
            "rule": "response_field_not_empty",
            "field": "generations",
            "severity": "warning",
            "message": "You haven't generated any music. Continue anyway?",
            "validator": ["webui", "server"]
          }
        ]
      },
      {
        "id": "retry",
        "mode": "retry",
        "label": "Regenerate music prompts",
        "shortcut": "r",
        "hidden": true,
        "target_module": "generate_music_prompts",
        "feedback": {
          "enabled": true,
          "prompt": "What should be different?",
          "default_message": "Please generate different music prompts."
        }
      }
    ]
  },
  "name": "generate_and_select_music"
}
```

### API Contract Changes

**Request - Add action_id and confirmed_warnings:**

```python
# contracts/interactions.py
@dataclass
class InteractionResponse:
    interaction_id: str
    # ... existing fields ...
    
    # NEW: Which action triggered this response
    action_id: Optional[str] = None
    
    # NEW: List of validation IDs user has confirmed to proceed despite warning
    confirmed_warnings: List[str] = field(default_factory=list)
```

**Response - Validation result in SSE:**

```python
# SSE Event when validation fails
event: validation_failed
data: {
    "errors": [
        {
            "id": "require_image_selection",
            "field": "selected_content_id",
            "rule": "response_field_required",
            "message": "Please select an image before continuing",
            "severity": "error"
        }
    ],
    "warnings": [
        {
            "id": "warn_no_video_generation",
            "field": "generations",
            "rule": "response_field_not_empty",
            "message": "You haven't generated any videos. Continue anyway?",
            "severity": "warning"
        }
    ]
}
```

## Implementation Plan

### Phase 1: Server-Side Validation

1. **contracts/interactions.py**: Add `action_id`, `confirmed_warnings` fields
2. **backend/server/models/interaction.py**: Add fields to Pydantic model
3. **backend/server/workflow/validation.py**: New file with validation rules
4. **backend/server/workflow/interaction.py**: Call validation before execute

### Phase 2: Frontend Validation

1. **ui/webui/src/core/types.ts**: Add validation types
2. **ui/webui/src/utils/validation.ts**: New file with client-side validation
3. **ui/webui/src/interactions/InteractionHost.tsx**: Add validation logic

### Phase 3: Step Configurations

1. **workflows/cc/steps/3_image_prompts/step.json**: Add validations
2. **workflows/cc/steps/5_video_generation/step.json**: Add validations
3. **workflows/cc/steps/7_music/step.json**: Add validations

## Files Affected

| File | Changes |
|------|---------|
| `contracts/interactions.py` | Add `action_id`, `confirmed_warnings` fields |
| `backend/server/models/interaction.py` | Add fields to Pydantic model |
| `backend/server/workflow/validation.py` | New file: validation rules and runner |
| `backend/server/workflow/interaction.py` | Call validation before execute |
| `workflows/cc/steps/3_image_prompts/step.json` | Add validations to continue |
| `workflows/cc/steps/5_video_generation/step.json` | Add validations to continue |
| `workflows/cc/steps/7_music/step.json` | Add validations to continue |
| `ui/webui/src/core/types.ts` | Add validation types |
| `ui/webui/src/utils/validation.ts` | New file: client-side validation |
| `ui/webui/src/interactions/InteractionHost.tsx` | Add validation logic, footer display |
