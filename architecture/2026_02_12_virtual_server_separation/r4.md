# Virtual Server Separation Architecture (Revision 4)

## Summary

Separate virtual endpoints from `backend/server` into a standalone 
`backend/virtual-server` package. Create `backend/workflow_engine/` by moving 
`engine/`, `models/`, `modules/`, and `workflow/` from `backend/server/` into 
it. Both servers import from `workflow_engine/`.

## Design Principles

1. **No cross-imports**: `server/`, `worker/`, and `virtual-server/` must never 
   import from each other.

2. **Preserve structure**: Move folders as-is into `workflow_engine/`. Don't 
   flatten or reorganize internally.

3. **Use `git mv`**: All file moves must preserve git history.

4. **1:1 endpoint mapping**: Virtual server uses `/workflow/*` prefix (same as 
   production).

## Current Structure

```
backend/
├── server/
│   ├── server.py
│   ├── api/
│   │   ├── app.py
│   │   └── routes/
│   │       ├── virtual.py      # TO BE MOVED to virtual-server
│   │       ├── execution.py
│   │       └── ...
│   ├── engine/                 # TO BE MOVED to workflow_engine/
│   │   ├── __init__.py
│   │   ├── module_interface.py
│   │   ├── workflow_resolver.py
│   │   ├── jinja2_resolver.py
│   │   ├── execution_groups.py
│   │   ├── interaction_handler.py
│   │   ├── module_registry.py
│   │   ├── context_utils.py
│   │   └── state_manager.py
│   ├── workflow/               # TO BE MOVED to workflow_engine/
│   │   ├── __init__.py
│   │   ├── processor.py
│   │   ├── executor.py
│   │   └── ...
│   ├── models/                 # TO BE MOVED to workflow_engine/
│   │   ├── __init__.py
│   │   └── ...
│   ├── modules/                # TO BE MOVED to workflow_engine/
│   │   ├── __init__.py
│   │   └── ...
│   └── utils/
│       └── ...
├── db/
├── providers/
└── worker/
```

## Proposed Structure

```
backend/
├── workflow_engine/            # NEW - contains the engine
│   ├── __init__.py             # Exports WorkflowProcessor, etc.
│   ├── engine/                 # MOVED from server/engine/
│   │   ├── __init__.py
│   │   ├── module_interface.py
│   │   ├── workflow_resolver.py
│   │   ├── jinja2_resolver.py
│   │   ├── execution_groups.py
│   │   ├── interaction_handler.py
│   │   ├── module_registry.py
│   │   ├── context_utils.py
│   │   └── state_manager.py
│   ├── workflow/               # MOVED from server/workflow/
│   │   ├── __init__.py
│   │   ├── processor.py
│   │   ├── executor.py
│   │   ├── interaction.py
│   │   ├── navigation.py
│   │   ├── sub_action.py
│   │   ├── streaming.py
│   │   ├── validation.py
│   │   ├── workflow_context.py
│   │   └── workflow_utils.py
│   ├── models/                 # MOVED from server/models/
│   │   ├── __init__.py
│   │   ├── workflow.py
│   │   ├── interaction.py
│   │   ├── sse.py
│   │   ├── requests.py
│   │   ├── responses.py
│   │   ├── sub_action.py
│   │   ├── execution.py
│   │   └── virtual.py
│   └── modules/                # MOVED from server/modules/
│       ├── __init__.py
│       ├── addons/
│       ├── api/
│       ├── db/
│       ├── io/
│       ├── media/
│       ├── prompt/
│       ├── transform/
│       └── user/
│
├── db/                         # UNCHANGED
├── providers/                  # UNCHANGED
│
├── server/                     # Production API only
│   ├── server.py
│   ├── api/
│   │   ├── app.py              # NO virtual_router
│   │   └── routes/
│   │       ├── execution.py
│   │       ├── streaming.py
│   │       └── ...             # NO virtual.py
│   └── utils/
│
├── worker/                     # UNCHANGED
│
└── virtual-server/             # NEW
    ├── server.py
    ├── api/
    │   ├── app.py
    │   ├── auth.py
    │   └── routes/
    │       └── workflow.py     # Virtual endpoints (prefix: /workflow)
    └── utils/
```

## Technical Specification

### 1. Workflow Engine Package (`backend/workflow_engine/`)

Top-level `__init__.py` re-exports key classes for convenience:

```python
# backend/workflow_engine/__init__.py
from .workflow import WorkflowProcessor, SubActionHandler, SubActionContext
from .models import (
    WorkflowStatus,
    WorkflowResponse,
    VirtualWorkflowResponse,
    # ... other commonly used models
)

__all__ = [
    'WorkflowProcessor',
    'SubActionHandler', 
    'SubActionContext',
    'WorkflowStatus',
    'WorkflowResponse',
    'VirtualWorkflowResponse',
    # ...
]
```

Internal packages remain unchanged - they just moved location.

### 2. Import Changes

```python
# BEFORE (relies on sys.path manipulation in server.py)
from workflow import WorkflowProcessor
from models import WorkflowResponse
from engine import StateManager
from modules.api import LLMCall

# AFTER (explicit package imports)
from backend.workflow_engine import WorkflowProcessor
from backend.workflow_engine.models import WorkflowResponse
from backend.workflow_engine.engine import StateManager
from backend.workflow_engine.modules.api import LLMCall

# OR via top-level re-export for common classes
from backend.workflow_engine import WorkflowProcessor, WorkflowResponse
```

### 3. Internal Import Updates

Files inside `workflow_engine/` need relative import updates:

```python
# BEFORE (in workflow_engine/workflow/processor.py)
from models import WorkflowStatus
from engine import StateManager

# AFTER
from ..models import WorkflowStatus
from ..engine import StateManager
```

### 4. Server Entry Point

Remove sys.path manipulation:

```python
# backend/server/server.py
# REMOVE: sys.path.insert(0, os.path.dirname(__file__))

# Imports now use full package paths
```

### 5. Production Server (`backend/server/`)

Remove virtual endpoint registration:

```python
# app.py - REMOVE:
# from .routes import virtual_router
# app.include_router(virtual_router)
```

### 6. Virtual Server (`backend/virtual-server/`)

```python
# backend/virtual-server/api/app.py
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from .routes.workflow import router as workflow_router

app = FastAPI(
    title="Virtual Workflow API",
    description="Endpoints for editor preview mode",
    version="1.0.0"
)

app.add_middleware(CORSMiddleware, ...)
app.include_router(workflow_router)

@app.get("/health")
async def health():
    return {"status": "healthy", "service": "virtual"}
```

### 7. Endpoint Mapping

| Current (in server) | New (in virtual-server) |
|---------------------|-------------------------|
| `/workflow/virtual/start` | `/workflow/start` |
| `/workflow/virtual/respond` | `/workflow/respond` |
| `/workflow/virtual/sub-action` | `/workflow/sub-action` |
| `/workflow/virtual/state` | `/workflow/state` |
| `/workflow/virtual/generations` | `/workflow/generations` |

### 8. Authentication

Virtual server has its own auth module, reads same user database:

```python
# backend/virtual-server/api/auth.py
from backend.db import Database

async def get_current_user_id(request: Request) -> str:
    # Same JWT/cookie validation logic
    # Reads from shared user database
    ...
```

### 9. Utils

Duplicated per server (like worker does):

```
backend/
├── server/utils/
├── worker/utils/
└── virtual-server/utils/
```

### 10. URL Configuration

#### Production
```
api.randomsitein.space/              → backend/server (port 9000)
virtual.randomsitein.space/          → backend/virtual-server (port 9001)
```

#### Development
```
localhost:9000  → backend/server
localhost:9001  → backend/virtual-server
```

### 11. Editor Configuration

```typescript
// ui/shared/src/core/config.ts
export const VIRTUAL_API_URL = import.meta.env.VITE_VIRTUAL_API_URL 
  ?? (isProduction 
    ? 'https://virtual.randomsitein.space' 
    : 'http://localhost:9001');
```

```typescript
// ui/editor/src/runtime/virtual-api.ts
import { VIRTUAL_API_URL } from '@wfm/shared';

export async function virtualStart(...) {
  return fetchResponse<VirtualStartResponse>(
    `${VIRTUAL_API_URL}/workflow/start`,
    ...
  );
}
```

## Migration Steps

### Phase 1: Create workflow_engine Package (git mv)

```bash
# Create the new package
mkdir -p backend/workflow_engine

# Move folders (preserves git history)
git mv backend/server/engine backend/workflow_engine/engine
git mv backend/server/models backend/workflow_engine/models
git mv backend/server/modules backend/workflow_engine/modules
git mv backend/server/workflow backend/workflow_engine/workflow

# Create __init__.py
touch backend/workflow_engine/__init__.py
```

### Phase 2: Update Imports

1. Update `backend/workflow_engine/workflow/*.py`:
   - Change `from models import` to `from ..models import`
   - Change `from modules import` to `from ..modules import`
   - Change `from engine import` to `from ..engine import`

2. Update `backend/workflow_engine/modules/**/*.py`:
   - Change `from models import` to `from ..models import`
   - Change `from engine import` to `from ..engine import`

3. Update `backend/workflow_engine/engine/*.py`:
   - Change `from models import` to `from ..models import`

4. Update `backend/server/api/**/*.py`:
   - Change `from workflow import` to `from backend.workflow_engine.workflow import`
   - Change `from models import` to `from backend.workflow_engine.models import`
   - Change `from modules import` to `from backend.workflow_engine.modules import`
   - Change `from engine import` to `from backend.workflow_engine.engine import`

5. Remove sys.path manipulation from `backend/server/server.py`

6. Verify server still works

### Phase 3: Create Virtual Server

1. Create `backend/virtual-server/` structure
2. Create `server.py` entry point
3. Create `api/app.py` with FastAPI setup
4. Create `api/auth.py`
5. Create `api/routes/workflow.py` from `server/api/routes/virtual.py`:
   - Change prefix from `/workflow/virtual` to `/workflow`
   - Update imports to use `backend.workflow_engine`
6. Copy needed utils to `virtual-server/utils/`

### Phase 4: Remove Virtual from Main Server

1. Remove `virtual_router` import and registration from `app.py`
2. Delete `backend/server/api/routes/virtual.py`
3. Remove route ordering comments

### Phase 5: Update Editor

1. Add `VITE_VIRTUAL_API_URL` to environment configs
2. Update `virtual-api.ts` paths and URL
3. Update `ui/shared/src/core/config.ts`

### Phase 6: Deploy

1. Update docker-compose.yml
2. Add nginx configuration for virtual subdomain
3. Deploy both services

## Import Dependency Diagram

```
┌─────────────────────────────────────────────────────────────┐
│                         backend/                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│              ┌───────────────────────────┐                 │
│              │     workflow_engine/      │                 │
│              │  ┌─────────┐ ┌─────────┐  │                 │
│              │  │workflow/│ │ engine/ │  │                 │
│              │  └────┬────┘ └────┬────┘  │                 │
│              │       │          │        │                 │
│              │       └────┬─────┘        │                 │
│              │            ▼              │                 │
│              │       ┌─────────┐         │                 │
│              │       │modules/ │         │                 │
│              │       └────┬────┘         │                 │
│              │            ▼              │                 │
│              │       ┌─────────┐         │                 │
│              │       │ models/ │         │                 │
│              │       └─────────┘         │                 │
│              └───────────┬───────────────┘                 │
│                          │                                  │
│        ┌─────────────────┼─────────────────┐               │
│        │                 │                 │               │
│        ▼                 ▼                 ▼               │
│   ┌─────────┐      ┌──────────┐     ┌────────────────┐    │
│   │ server/ │      │ worker/  │     │ virtual-server/│    │
│   └────┬────┘      └────┬─────┘     └───────┬────────┘    │
│        │                │                   │              │
│        └────────────────┼───────────────────┘              │
│                         │                                  │
│           ┌─────────────┴─────────────┐                   │
│           │                           │                   │
│           ▼                           ▼                   │
│      ┌────────┐                ┌────────────┐             │
│      │  db/   │                │ providers/ │             │
│      └────────┘                └────────────┘             │
│                                                             │
└─────────────────────────────────────────────────────────────┘

  ✗ server/ ←→ worker/ ←→ virtual-server/ (NO cross-imports)
```

## Docker Compose

```yaml
services:
  api:
    build:
      context: ..
      dockerfile: backend/server/Dockerfile
    ports:
      - "9000:9000"
    environment:
      - MONGODB_URI=mongodb://mongo:27017
      - MONGODB_DATABASE=workflow_db

  virtual-api:
    build:
      context: ..
      dockerfile: backend/virtual-server/Dockerfile
    ports:
      - "9001:9001"
    environment:
      - MONGODB_URI=mongodb://mongo:27017
      - MONGODB_VIRTUAL_URI=mongodb://mongo-virtual:27017
    depends_on:
      - mongo
      - mongo-virtual

  mongo:
    image: mongo:7
    volumes:
      - mongo-data:/data/db

  mongo-virtual:
    image: mongo:7
```

## Development Workflow

```bash
# Terminal 1: Main API
cd backend && python -m server.server --host 0.0.0.0 --port 9000 ...

# Terminal 2: Virtual API  
cd backend && python -m virtual-server.server --host 0.0.0.0 --port 9001 ...

# Terminal 3: Editor
cd ui/editor && VITE_VIRTUAL_API_URL=http://localhost:9001 npm run dev
```
