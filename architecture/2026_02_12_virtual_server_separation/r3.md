# Virtual Server Separation Architecture (Revision 3)

## Summary

Separate virtual endpoints from `backend/server` into a standalone 
`backend/virtual-server` package. The `workflow/` and `models/` folders inside 
`backend/server/` form the workflow engine - these will be moved out to become 
a shared package that both servers import.

## Design Principles

1. **No cross-imports**: `server/`, `worker/`, and `virtual-server/` must never 
   import from each other. If something needs to be shared, it belongs in a 
   shared package.

2. **Preserve structure**: Keep the internal structure of `workflow/` and 
   `models/` as-is. Don't flatten or reorganize - just move the folders.

3. **Use `git mv`**: All file moves must preserve git history.

4. **1:1 endpoint mapping**: Virtual server uses `/workflow/*` prefix (same as 
   production) for easy mental mapping.

## Current State

### How Imports Work Today

The server entry point (`backend/server/server.py`) adds `backend/server/` to 
`sys.path` (line 67):

```python
sys.path.insert(0, os.path.dirname(__file__))  # Adds backend/server/ to path
```

This allows imports like:
```python
from workflow import WorkflowProcessor  # Resolves to backend/server/workflow/
from models import WorkflowResponse     # Resolves to backend/server/models/
```

### Current Structure

```
backend/
├── server/
│   ├── server.py               # Entry point, modifies sys.path
│   ├── api/
│   │   ├── app.py              # Mounts ALL routers including virtual
│   │   └── routes/
│   │       ├── virtual.py      # Virtual endpoints (~943 lines)
│   │       ├── execution.py    # Production endpoints
│   │       └── ...
│   ├── workflow/               # THE WORKFLOW ENGINE
│   │   ├── __init__.py         # Exports WorkflowProcessor
│   │   ├── processor.py        # Main orchestrator
│   │   ├── executor.py         # Step/module execution
│   │   ├── interaction.py      # User interaction handling
│   │   ├── navigation.py       # Retry and jump logic
│   │   ├── sub_action.py       # Sub-action execution
│   │   ├── streaming.py        # SSE streaming
│   │   ├── validation.py       # Workflow validation
│   │   ├── workflow_context.py # Context management
│   │   └── workflow_utils.py   # Utilities
│   ├── models/                 # SHARED MODELS
│   │   ├── __init__.py         # Re-exports all models
│   │   ├── workflow.py
│   │   ├── interaction.py
│   │   ├── sse.py
│   │   ├── requests.py
│   │   ├── responses.py
│   │   ├── sub_action.py
│   │   ├── execution.py
│   │   └── virtual.py
│   ├── modules/                # Module implementations
│   │   └── ...
│   └── utils/
│       └── ...
├── db/
│   ├── database.py
│   └── virtual.py
├── providers/
│   └── ...
└── worker/
    └── ...
```

### Problems
1. **Route collision**: Virtual routes must be registered before streaming 
   routes due to `/{workflow_run_id}/sub-action` matching `/virtual/sub-action`
2. **Shared resources**: Editor preview traffic competes with production
3. **Deployment coupling**: Any virtual endpoint change requires full API 
   redeploy
4. **Code entanglement**: Virtual routes live inside `backend/server/api/routes`

## Proposed Structure

```
backend/
├── execution/                  # MOVED from server/workflow/ (renamed)
│   ├── __init__.py             # Exports WorkflowProcessor
│   ├── processor.py
│   ├── executor.py
│   ├── interaction.py
│   ├── navigation.py
│   ├── sub_action.py
│   ├── streaming.py
│   ├── validation.py
│   ├── workflow_context.py
│   └── workflow_utils.py
│
├── models/                     # MOVED from server/models/
│   ├── __init__.py
│   ├── workflow.py
│   ├── interaction.py
│   ├── sse.py
│   ├── requests.py
│   ├── responses.py
│   ├── sub_action.py
│   ├── execution.py
│   └── virtual.py
│
├── db/                         # UNCHANGED
│   ├── database.py
│   └── virtual.py
│
├── providers/                  # UNCHANGED
│   └── ...
│
├── server/                     # Production API only
│   ├── server.py               # Entry point (updated sys.path)
│   ├── api/
│   │   ├── app.py              # NO virtual_router
│   │   └── routes/
│   │       ├── execution.py
│   │       ├── streaming.py
│   │       └── ...             # NO virtual.py
│   ├── modules/                # STAYS HERE (server-specific)
│   │   └── ...
│   └── utils/                  # Server-specific utils
│       └── ...
│
├── worker/                     # UNCHANGED
│   └── ...
│
└── virtual-server/             # NEW
    ├── server.py               # Entry point (similar to server/server.py)
    ├── api/
    │   ├── app.py              # FastAPI app
    │   ├── auth.py             # Auth (reads same user DB)
    │   └── routes/
    │       └── workflow.py     # Virtual endpoints (prefix: /workflow)
    └── utils/                  # Virtual-specific utils
        └── ...
```

## Technical Specification

### 1. Execution Package (`backend/execution/`)

Moved from `backend/server/workflow/` and renamed to `execution/`. Internal 
structure preserved exactly:

```
git mv backend/server/workflow backend/execution
```

The `__init__.py` stays the same:
```python
from .processor import WorkflowProcessor
from .sub_action import SubActionHandler, SubActionContext

__all__ = ['WorkflowProcessor', 'SubActionHandler', 'SubActionContext']
```

### 2. Models Package (`backend/models/`)

Moved from `backend/server/models/`:

```
git mv backend/server/models backend/models
```

The `__init__.py` stays the same - no changes to exports.

### 3. Import Changes

After moving, imports change from path-based to package-based:

```python
# BEFORE (relies on sys.path manipulation)
from workflow import WorkflowProcessor
from models import WorkflowResponse

# AFTER (explicit package imports)
from backend.execution import WorkflowProcessor
from backend.models import WorkflowResponse
```

Files that need import updates:
- `backend/server/api/app.py`
- `backend/server/api/routes/*.py`
- `backend/execution/*.py` (internal imports stay relative)
- `backend/worker/` (if it imports workflow/models)

### 4. Server Entry Point Updates

```python
# backend/server/server.py
# REMOVE: sys.path.insert(0, os.path.dirname(__file__))
# Imports now use full package path: from backend.execution import ...
```

```python
# backend/virtual-server/server.py
# Similar structure, no sys.path manipulation needed
# Imports use: from backend.execution import ...
```

### 5. Virtual Server (`backend/virtual-server/`)

Standalone FastAPI application with `/workflow/*` prefix:

```python
# backend/virtual-server/api/app.py
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware

from .routes.workflow import router as workflow_router

app = FastAPI(
    title="Virtual Workflow API",
    description="Endpoints for editor preview mode",
    version="1.0.0"
)

app.add_middleware(CORSMiddleware, ...)

# /workflow/* prefix - mirrors production endpoint structure
app.include_router(workflow_router)

@app.get("/health")
async def health():
    return {"status": "healthy", "service": "virtual"}
```

### 6. Endpoint Mapping

| Current (in server) | New (in virtual-server) |
|---------------------|-------------------------|
| `/workflow/virtual/start` | `/workflow/start` |
| `/workflow/virtual/respond` | `/workflow/respond` |
| `/workflow/virtual/sub-action` | `/workflow/sub-action` |
| `/workflow/virtual/state` | `/workflow/state` |
| `/workflow/virtual/generations` | `/workflow/generations` |

### 7. Authentication

Virtual server has its own auth module but reads from the same user database:

```python
# backend/virtual-server/api/auth.py
from backend.db import Database

async def get_current_user_id(request: Request) -> str:
    # Same JWT/cookie validation logic as server
    # Reads from shared user database
    ...
```

Environment config:
```
MONGODB_URI=mongodb://mongo:27017          # For auth (shared)
MONGODB_VIRTUAL_URI=mongodb://mongo-virtual:27017  # For virtual execution
```

### 8. Utils Duplication

Like `worker/`, `virtual-server/` duplicates needed utils:

```
backend/
├── server/utils/           # Server-specific utils
├── worker/utils/           # Worker-specific utils (existing)
└── virtual-server/utils/   # Virtual-specific utils (duplicated)
```

### 9. URL Configuration

#### Production
```
api.randomsitein.space/              → backend/server (port 9000)
virtual.randomsitein.space/          → backend/virtual-server (port 9001)
```

#### Development
```
localhost:9000  → backend/server
localhost:9001  → backend/virtual-server
```

### 10. Editor Configuration

```typescript
// ui/shared/src/core/config.ts
export const VIRTUAL_API_URL = import.meta.env.VITE_VIRTUAL_API_URL 
  ?? (isProduction 
    ? 'https://virtual.randomsitein.space' 
    : 'http://localhost:9001');
```

```typescript
// ui/editor/src/runtime/virtual-api.ts
import { VIRTUAL_API_URL } from '@wfm/shared';

export async function virtualStart(...) {
  // New path: /workflow/start (not /workflow/virtual/start)
  return fetchResponse<VirtualStartResponse>(
    `${VIRTUAL_API_URL}/workflow/start`,
    ...
  );
}
```

## Migration Steps

### Phase 1: Move Shared Packages (git mv)
1. `git mv backend/server/workflow backend/execution`
2. `git mv backend/server/models backend/models`
3. Update all imports in `backend/server/` to use `backend.execution` and 
   `backend.models`
4. Update all imports in `backend/execution/` that reference `models` to use 
   `backend.models`
5. Remove sys.path manipulation from `backend/server/server.py`
6. Verify server still works

### Phase 2: Create Virtual Server
1. Create `backend/virtual-server/` structure
2. Create `server.py` entry point
3. Create `api/app.py` with FastAPI setup
4. Create `api/auth.py` (copy logic from server, adapt as needed)
5. Create `api/routes/workflow.py` from current `virtual.py`:
   - Copy logic from `server/api/routes/virtual.py`
   - Change prefix from `/workflow/virtual` to `/workflow`
   - Update imports to use `backend.execution` and `backend.models`
6. Copy needed utils to `virtual-server/utils/`
7. Create Dockerfile

### Phase 3: Remove Virtual from Main Server
1. Remove `virtual_router` import and registration from `app.py`
2. Delete `backend/server/api/routes/virtual.py`
3. Remove route ordering comments

### Phase 4: Update Editor
1. Add `VITE_VIRTUAL_API_URL` to environment configs
2. Update `virtual-api.ts`:
   - Use `VIRTUAL_API_URL` instead of `API_URL`
   - Change paths from `/workflow/virtual/*` to `/workflow/*`
3. Update `ui/shared/src/core/config.ts`

### Phase 5: Deploy
1. Update docker-compose.yml
2. Add nginx configuration for virtual subdomain
3. Deploy both services
4. Update DNS for `virtual.randomsitein.space`

## Import Dependency Diagram

```
┌─────────────────────────────────────────────────────────────┐
│                         backend/                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐    ┌─────────────┐                        │
│  │  execution/ │    │   models/   │                        │
│  │  (engine)   │───▶│  (shared)   │                        │
│  └──────┬──────┘    └──────┬──────┘                        │
│         │                  │                                │
│         └────────┬─────────┘                                │
│                  │                                          │
│    ┌─────────────┼─────────────┬─────────────┐             │
│    │             │             │             │             │
│    ▼             ▼             ▼             ▼             │
│ ┌───────┐   ┌────────┐   ┌────────────────┐               │
│ │server │   │ worker │   │ virtual-server │               │
│ └───┬───┘   └────┬───┘   └───────┬────────┘               │
│     │            │               │                         │
│     └────────────┼───────────────┘                         │
│                  │                                          │
│    ┌─────────────┴─────────────┐                           │
│    │                           │                           │
│    ▼                           ▼                           │
│ ┌──────┐                 ┌───────────┐                     │
│ │  db/ │                 │ providers/│                     │
│ └──────┘                 └───────────┘                     │
│                                                             │
└─────────────────────────────────────────────────────────────┘

Rules:
  ✓ execution/ imports from: models/, db/, providers/
  ✓ server/ imports from: execution/, models/, db/, providers/
  ✓ worker/ imports from: execution/, models/, db/, providers/
  ✓ virtual-server/ imports from: execution/, models/, db/, providers/
  ✗ server/ ←→ worker/ ←→ virtual-server/ (NO cross-imports)
```

## Docker Compose

```yaml
services:
  api:
    build:
      context: ..
      dockerfile: backend/server/Dockerfile
    ports:
      - "9000:9000"
    environment:
      - MONGODB_URI=mongodb://mongo:27017
      - MONGODB_DATABASE=workflow_db

  virtual-api:
    build:
      context: ..
      dockerfile: backend/virtual-server/Dockerfile
    ports:
      - "9001:9001"
    environment:
      - MONGODB_URI=mongodb://mongo:27017        # Auth DB (shared)
      - MONGODB_VIRTUAL_URI=mongodb://mongo-virtual:27017
    depends_on:
      - mongo
      - mongo-virtual

  mongo:
    image: mongo:7
    volumes:
      - mongo-data:/data/db

  mongo-virtual:
    image: mongo:7
    # No persistent volume - ephemeral
```

## Development Workflow

```bash
# Terminal 1: Main API
cd backend && python -m server.server --host 0.0.0.0 --port 9000 ...

# Terminal 2: Virtual API  
cd backend && python -m virtual-server.server --host 0.0.0.0 --port 9001 ...

# Terminal 3: Editor
cd ui/editor
VITE_VIRTUAL_API_URL=http://localhost:9001 npm run dev
```

## Questions Resolved

| Question | Resolution |
|----------|------------|
| WorkflowProcessor location | `backend/execution/` (moved from server/workflow/) |
| Models location | `backend/models/` (moved from server/models/) |
| Naming | `execution/` instead of `workflow_engine/` |
| Auth sharing | Same DB, separate auth module per server |
| URL prefix | `/workflow/*` (mirrors production) |
| Utils | Duplicate per server |
| File moves | All via `git mv` to preserve history |
