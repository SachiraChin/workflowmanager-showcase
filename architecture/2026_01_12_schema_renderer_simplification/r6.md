# SchemaRenderer Simplification Architecture - Revision 6

## Summary

This revision documents implementation progress and identifies remaining work after the January 13, 2026 implementation session.

**Status**: Phases 1-4 completed with issues. Phase 5-7 pending.

---

## Work Completed

### Phase 1: Foundation (COMPLETE)

#### 1.1 Types Updated
- `types.ts` - Added `DisplayMode` type and `normalizeDisplay()` helper function

#### 1.2 Layout Infrastructure Created
- `layouts/` folder structure:
  - `layouts/index.ts` - Registry exports and layout imports
  - `layouts/registry.tsx` - `registerLayout()` and `getLayout()` functions
  - `layouts/types.ts` - `LayoutProps` and `LayoutComponent` interfaces
  - `layouts/utils.ts` - Filter utilities (`filterByAttr`, `filterByAttrExists`, `filterExcludingRenderAs`, `childrenToArray`, `getAttr`, `getIndexFromPath`)

#### 1.3 Layout Components Created
- `layouts/DefaultLayout.tsx` - Simple container with spacing
- `layouts/CardStackLayout.tsx` - Vertical stack with gap
- `layouts/SectionListLayout.tsx` - Vertical list with gap
- `layouts/CardLayout.tsx` - Card with slot-based placement (title, subtitle, highlight, body)
- `layouts/SectionLayout.tsx` - Collapsible section with slots

---

### Phase 2: Core Renderers (COMPLETE)

#### 2.1 ArraySchemaRenderer Created
- `ArraySchemaRenderer.tsx` - Handles arrays with display mode checking and layout wrapping

#### 2.2 ObjectSchemaRenderer Created
- `ObjectSchemaRenderer.tsx` - Handles objects with:
  - Property iteration (regular, additionalProperties, computed)
  - Data-* attribute wrapping
  - Display mode checking

#### 2.3 SchemaRenderer Rewritten
- `SchemaRenderer.tsx` - Pure type-based router
  - Routes to ArraySchemaRenderer for arrays
  - Routes to ObjectSchemaRenderer for objects
  - Routes to TerminalRenderer for primitives
  - Handles `display_format` (when no `render_as`)

---

### Phase 3: Integration (COMPLETE)

- Old SchemaRenderer backed up to `SchemaRenderer.old.tsx`
- New system wired up via `index.ts`
- Backwards compatibility maintained for `display: true/false`

---

### Phase 4: Schema Migration (COMPLETE WITH ISSUES)

#### Schemas Updated (39 files):

**OMS Step 1:**
- `theme_display_schema.json` - Added `display: "visible"` at root
- `tone_display_schema.json` - Added `display: "visible"` at root
- `visual_style_display_schema.json` - Added `display: "visible"` at root
- `duration_display_schema.json` - Added `display: "visible"` at root
- `brightness_display_schema.json` - Added `display: "visible"` at root
- `motion_strength_display_schema.json` - Added `display: "visible"` at root
- `aesthetic_form_schema.json` - Added `display: "passthrough"` at root
- `aesthetic_display_schema.json` - Added `display: "passthrough"` at root, nested render_as

**OMS Step 2:**
- `model_groups_display_schema.json` - Added `display: "passthrough"`, additionalProperties config
- `prompts_display_wrapper_schema.json` - Fixed `prompts.display` from `false` to `"passthrough"`
- `leonardo_display_schema.json` - Added `display: "passthrough"` at root
- `midjourney_display_schema.json` - Added `display: "passthrough"` at root
- `sora_display_schema.json` - Added `display: "passthrough"` at root
- `stable_diffusion_display_schema.json` - Added `display: "passthrough"` at root

**OMS Step 4:**
- `video_prompts_display_wrapper_schema.json` - Fixed `prompts.display` from `false` to `"passthrough"`
- `motion_anchors_display_schema.json` - Added `display: "passthrough"`, `render_as: "card-stack"`, `render_as: "card"` on items
- `midjourney_animate_display_schema.json` - Added `display: "passthrough"` at root
- `motion_2_0_display_schema.json` - Added `display: "passthrough"` at root

**OMS Step 5:**
- `paragraph_display_schema.json` - Added `display: "passthrough"` at root

**OMS Step 6:**
- `titles_display_schema.json` - Added `display: "visible"` at root
- `descriptions_display_schema.json` - Added `display: "passthrough"`, nested `display: "visible"`

**OMS Step 7:**
- `color_display_schema.json` - Added `display: "passthrough"` at root
- `text_placement_schema.json` - Added `display: "visible"` at root

**OMS Step 8:**
- `music_options_display_schema.json` - Added `display: "visible"` at root

**CC Step 1:**
- `cc_aesthetic_display_schema.json` - Added `display: "visible"`, `render_as: "card-stack"`, items have `render_as: "card"`
- `cc_duration_display_schema.json` - Added `display: "visible"`, `render_as: "card-stack"`, items have `render_as: "card"`
- `pet_type_display_schema.json` - Added `display: "visible"`, `render_as: "card-stack"`, items have `render_as: "card"`

**CC Step 2:**
- `scene_display_schema.json` - Added `display: "passthrough"`, scenes array has `render_as: "card-stack"`, items have `render_as: "card"`

**CC Step 3:**
- `cc_image_prompts_display_schema.json` - Updated

**CC Step 4:**
- `cc_video_prompts_display_schema.json` - Updated

**CC Step 5:**
- `cc_text_overlays_display_schema.json` - Added `display: "passthrough"`, nested render_as

**CC Step 6:**
- `cc_titles_display_schema.json` - Added `display: "visible"`, `render_as: "card-stack"`
- `cc_descriptions_display_schema.json` - Added `display: "visible"`, `render_as: "card-stack"`, items have `render_as: "card"`

**CC Step 7:**
- `cc_music_options_display_schema.json` - Updated

---

## Known Issues / Remaining Work

### ISSUE 1: card-content with display_format Not Working

**Location**: OMS Step 2 - midjourney_display_schema.json

**Problem**: Fields with both `render_as: "card-content"` AND `display_format` don't render the formatted template.

**Root Cause Analysis**:

The architecture has TWO separate systems that aren't connected:

1. **Layouts** (`layouts/` folder):
   - Used by ObjectSchemaRenderer via `getLayout(render_as)`
   - CardLayout, CardStackLayout, SectionLayout, etc.
   - No `CardContentLayout` exists - falls back to `DefaultLayout`

2. **Renderers** (`renderers/layouts/` folder):
   - Registered via `registerRenderer()`
   - CardContentRenderer exists and DOES handle `display_format`
   - But it's never called because ObjectSchemaRenderer uses `getLayout()`, not `getRenderer()`

**Current Flow** for `prompt_a` (type: object, render_as: "card-content", display_format: "..."):
1. Parent CardLayout places child in body section based on `data-render-as="card-content"`
2. Child goes to SchemaRenderer
3. SchemaRenderer sees type: object → ObjectSchemaRenderer
4. ObjectSchemaRenderer calls `getLayout("card-content")` → DefaultLayout (fallback!)
5. `display_format` is never processed - properties are expanded instead

**Solutions** (pick one):

**Option A**: Create `CardContentLayout` in `layouts/` folder
- File: `layouts/CardContentLayout.tsx`
- Register: `registerLayout("card-content", CardContentLayout)`
- Implementation: Check `schema.display_format`, render template, otherwise render children

**Option B**: Handle `display_format` in ObjectSchemaRenderer BEFORE layout routing
- If `schema.display_format` exists, render as formatted terminal value
- Don't call `getLayout()` for objects with `display_format`

**Option C**: Merge the two systems
- Make `getLayout()` check `getRenderer()` as fallback
- Or use single registry for both

**Recommended**: Option A - cleanest separation, follows existing pattern.

**Files to Create**:
```
layouts/CardContentLayout.tsx
```

**Code Example**:
```tsx
// layouts/CardContentLayout.tsx
import { registerLayout } from "./registry";
import { renderTemplate } from "@/lib/template-service";
import { useWorkflowStateContext } from "@/contexts/WorkflowStateContext";

export const CardContentLayout: React.FC<LayoutProps> = ({ schema, data, children }) => {
  const { state: workflowState } = useWorkflowStateContext();
  const templateState = (workflowState.state_mapped || {}) as Record<string, unknown>;

  let content: React.ReactNode;

  if (schema.display_format) {
    // Schema has display_format - render template
    const formatted = renderTemplate(schema.display_format, data, templateState);
    content = (
      <div className="text-sm text-foreground whitespace-pre-wrap break-words">
        {formatted}
      </div>
    );
  } else if (typeof data === "string") {
    content = (
      <div className="text-sm text-foreground whitespace-pre-wrap break-words">
        {data}
      </div>
    );
  } else if (React.Children.count(children) > 0) {
    content = <div className="space-y-2">{children}</div>;
  } else {
    content = (
      <div className="text-sm text-muted-foreground italic">No content</div>
    );
  }

  return (
    <div className="rounded-lg border bg-card overflow-hidden shadow-sm">
      {schema.display_label && (
        <div className="px-4 py-2 bg-muted/50 border-b">
          <span className="font-medium text-sm">{schema.display_label}</span>
        </div>
      )}
      <div className="p-4">{content}</div>
    </div>
  );
};

registerLayout("card-content", CardContentLayout);
```

**Then add import** in `layouts/index.ts`:
```tsx
import "./CardContentLayout";
```

---

## Phases Remaining

### Phase 5: TUI Adapter (PENDING)

**Goal**: Make TUI work with new display values.

**Files to Create/Modify**:
- TUI display adapter for `DisplayMode` handling

**Tasks**:
- [ ] Create display adapter function
- [ ] Integrate into TUI schema traversal
- [ ] Test all OMS steps in TUI
- [ ] Test all CC steps in TUI

---

### Phase 6: Cleanup (PENDING)

**Goal**: Remove old code and unused files.

**Files to Delete**:

```
webui/src/components/workflow/interactions/schema-interaction/
├── SchemaRenderer.old.tsx                    # Old SchemaRenderer backup
├── renderers/layouts/CardRenderer.tsx        # Replaced by layouts/CardLayout.tsx
├── renderers/layouts/CardStackRenderer.tsx   # Replaced by layouts/CardStackLayout.tsx
├── renderers/layouts/SectionRenderer.tsx     # Replaced by layouts/SectionLayout.tsx
├── renderers/layouts/SectionListRenderer.tsx # Replaced by layouts/SectionListLayout.tsx
├── renderers/layouts/DefaultArrayRenderer.tsx # Replaced by ArraySchemaRenderer
├── renderers/layouts/DefaultObjectRenderer.tsx # Replaced by ObjectSchemaRenderer
├── renderers/layouts/CardContentRenderer.tsx # Move logic to layouts/CardContentLayout.tsx
└── helpers/getRenderer.ts                    # Replaced by layouts/registry.tsx
```

**After deleting, update**:
- `renderers/layouts/index.ts` - Remove deleted exports
- `renderers/index.ts` - Update exports
- `helpers/index.ts` - Remove getRenderer export if present

**Code to Remove**:
- `isWrapper` from `renderer-types.ts`
- `strictMode` references (already removed)
- `Field` from Renderer interface (if still present)

---

### Phase 7: Full Verification (PENDING)

**Goal**: Complete testing of all workflows.

**OMS Workflow Testing**:
- [ ] Step 1: user_input - All 6 select modules render
- [ ] Step 2: prompt_generation - Prompts display with formatted templates
- [ ] Step 4: video_prompt_generation - Motion anchors display
- [ ] Step 5: text_overlays - Paragraphs render
- [ ] Step 6: titles_descriptions - Titles/descriptions display
- [ ] Step 7: text_colors - Colors display
- [ ] Step 8: music_generation - Music options display

**CC Workflow Testing**:
- [ ] Step 1: user_input - Pet type, aesthetic, duration
- [ ] Step 2: scene_generation - Scenes display
- [ ] Step 3: image_prompts - Image prompts display
- [ ] Step 4: video_prompts - Video prompts display
- [ ] Step 5: text_overlays - Text overlays display
- [ ] Step 6: titles_social - Titles/descriptions display
- [ ] Step 7: music - Music options display

**Feature Testing**:
- [ ] Selection in CardLayout
- [ ] Selection in items with display_format (TerminalRenderer path)
- [ ] Expand/collapse in SectionLayout
- [ ] Highlight styling with custom colors
- [ ] Nested containers (section containing card-stack)
- [ ] additionalProperties rendering
- [ ] Computed fields

---

## Current File Structure

### New Files Created

```
webui/src/components/workflow/interactions/schema-interaction/
├── ArraySchemaRenderer.tsx           # NEW - Array handling
├── ObjectSchemaRenderer.tsx          # NEW - Object handling
├── SchemaRenderer.old.tsx            # BACKUP - Old SchemaRenderer
├── layouts/                          # NEW FOLDER
│   ├── index.ts                      # Registry exports
│   ├── registry.tsx                  # registerLayout, getLayout
│   ├── types.ts                      # LayoutProps, LayoutComponent
│   ├── utils.ts                      # Filter utilities
│   ├── DefaultLayout.tsx
│   ├── CardLayout.tsx
│   ├── CardStackLayout.tsx
│   ├── SectionLayout.tsx
│   └── SectionListLayout.tsx
```

### Modified Files

```
webui/src/components/workflow/interactions/schema-interaction/
├── SchemaRenderer.tsx                # Rewritten as pure router
├── types.ts                          # Added DisplayMode, normalizeDisplay
├── index.ts                          # Updated exports
└── renderers/layouts/CardStackRenderer.tsx  # Minor updates
```

### Files to Delete (Phase 6)

```
webui/src/components/workflow/interactions/schema-interaction/
├── SchemaRenderer.old.tsx
├── renderers/layouts/CardRenderer.tsx
├── renderers/layouts/CardStackRenderer.tsx
├── renderers/layouts/SectionRenderer.tsx
├── renderers/layouts/SectionListRenderer.tsx
├── renderers/layouts/DefaultArrayRenderer.tsx
├── renderers/layouts/DefaultObjectRenderer.tsx
├── renderers/layouts/CardContentRenderer.tsx
└── helpers/getRenderer.ts
```

---

## Summary

| Phase | Status | Notes |
|-------|--------|-------|
| Phase 1: Foundation | COMPLETE | Types, layouts, utilities created |
| Phase 2: Core Renderers | COMPLETE | Array/Object/SchemaRenderer created |
| Phase 3: Integration | COMPLETE | New system wired up |
| Phase 4: Schema Migration | COMPLETE* | *card-content issue remains |
| Phase 5: TUI Adapter | PENDING | |
| Phase 6: Cleanup | PENDING | Delete old files |
| Phase 7: Full Verification | PENDING | |

**Critical Issue**: card-content + display_format requires CardContentLayout to be created.
