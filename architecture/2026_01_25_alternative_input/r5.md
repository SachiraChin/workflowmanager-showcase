# Alternative Input Schema - R5 (Final)

## Summary

Add schema-driven alternative input mechanism allowing fields to have multiple input modes (e.g., dropdown OR custom width/height inputs). Everything is driven by schema - no hardcoded TypeScript types for specific value shapes.

---

## Decisions Summary

| Decision | Choice |
|----------|--------|
| Mode switching UI | Toggle button/icon |
| Value storage | Combined in primary field as object |
| Static elements | `_ux.render_as: "text"` with `content` |
| Validation | Number input type with min/max/step |
| Composition timing | Every keystroke, no debounce (local state only) |
| Controls interaction | Mutually exclusive with `alternative` |
| Type field | Keep as `"string"` - refers to submission type |
| Submission | Extract `value.text` (the string part) |
| Toggle back behavior | Reset to default if composed value not in options |

---

## Server API Change

Resolution options change from:
```json
[
  { "value": "512x768", "count": 10 }
]
```

To:
```json
[
  { "value": { "text": "512x768", "width": 512, "height": 768 }, "count": 10 }
]
```

Schema's `label_format` changes to: `"{value.text} (count: {count})"`

---

## Schema Design

### Resolution Field with Alternative

```json
{
  "resolution": {
    "type": "string",
    "title": "Resolution",
    "required": true,
    "_ux": {
      "input_type": "select"
    },
    "alternative": {
      "compose": {
        "text": "{width}x{height}"
      },
      "layout": "inline",
      "fields": [
        {
          "key": "width",
          "type": "integer",
          "title": "W",
          "minimum": 64,
          "maximum": 2048,
          "step": 64,
          "default": 512,
          "_ux": {
            "input_type": "number"
          }
        },
        {
          "content": "x",
          "_ux": {
            "render_as": "text"
          }
        },
        {
          "key": "height",
          "type": "integer",
          "title": "H",
          "minimum": 64,
          "maximum": 2048,
          "step": 64,
          "default": 768,
          "_ux": {
            "input_type": "number"
          }
        }
      ]
    }
  }
}
```

### Alternative Config Properties

| Property | Type | Required | Description |
|----------|------|----------|-------------|
| `compose` | object | Yes | Map of field paths to template strings. Templates use `{key}` syntax. |
| `layout` | string | No | `"inline"` (horizontal) or `"stack"` (vertical). Default: `"inline"` |
| `fields` | array | Yes | Ordered list of field definitions |

### Field Properties

| Property | Type | Required | Description |
|----------|------|----------|-------------|
| `key` | string | For inputs | Path into stored value object (e.g., `"width"` → `value.width`) |
| `content` | string | For static | Text to display (field without `key` = static element) |
| `type` | string | For inputs | `"integer"`, `"number"`, `"string"` |
| `title` | string | No | Label for input |
| `default` | any | No | Default when no prior value exists |
| `minimum` | number | No | Min constraint for number inputs |
| `maximum` | number | No | Max constraint for number inputs |
| `step` | number | No | Step increment for number inputs |
| `_ux.input_type` | string | For inputs | `"number"`, `"text"` |
| `_ux.render_as` | string | For static | `"text"` |

---

## Implementation Plan

### 1. New Component: InputRenderer

**Problem**: `TerminalRenderer` handles both display rendering (text, color, url, etc.) AND input rendering (select, textarea, slider, etc.). This mixes concerns and makes it awkward to add input-specific features like `alternative`.

**Solution**: Create `InputRenderer` as a dedicated component for input routing.

Location: `ui/webui/src/components/workflow/interactions/schema-interaction/InputRenderer.tsx`

Responsibilities:
- Route to specific input components (SelectInputRenderer, TextareaInputRenderer, etc.)
- Check for `alternative` config and wrap with `AlternativeInputWrapper` if present
- Handle input-specific concerns separate from display concerns

### 2. Routing Changes (SchemaRenderer)

Currently `SchemaRenderer` routes to `TerminalRenderer` for primitives, which then checks `input_type`.

New flow:
```
SchemaRenderer
    │
    ├── Has input_type? ──────► InputRenderer ──────► Input components
    │                                │
    │                                └── Has alternative? ► AlternativeInputWrapper
    │
    └── No input_type? ───────► TerminalRenderer ──► Display components
```

### 3. Context Changes (InputSchemaContext)

Add alternative mode tracking:

```typescript
// New state
alternativeMode: Record<string, boolean>  // fieldKey → isAlternativeActive

// New methods
isAlternativeMode: (key: string) => boolean
setAlternativeMode: (key: string, active: boolean) => void
```

### 4. New Component: AlternativeInputWrapper

Location: `ui/webui/src/components/workflow/interactions/schema-interaction/renderers/AlternativeInputWrapper.tsx`

Responsibilities:
- Render toggle button in field label area
- Conditionally render primary input OR alternative fields
- Handle mode switching logic
- Run compose template when alternative fields change

### 5. Compose Logic

When alternative field changes:
1. Get current value object from context
2. Update the changed field (e.g., `value.width = newWidth`)
3. For each key in `compose`:
   - Run template substitution: `"{width}x{height}"` → `"640x768"`
   - Update `value[key]` with result
4. Call `context.setValue(fieldKey, updatedValue)`

### 6. Submission (getMappedValues)

When building submission values:
- If value is object with `text` property, extract `value.text`
- Otherwise use value as-is

This handles both:
- Regular string values: `"512x768"` → `"512x768"`
- Object values from alternative: `{ text: "512x768", ... }` → `"512x768"`

---

## UI Mockup

```
┌─────────────────────────────────────────────────────────┐
│ Resolution                                    [⇄]      │
├─────────────────────────────────────────────────────────┤
│                                                         │
│ PRIMARY MODE (toggle off):                              │
│   ┌─────────────────────────────────────────┐          │
│   │ 512x768 (count: 10)                  ▼  │          │
│   └─────────────────────────────────────────┘          │
│                                                         │
│ ALTERNATIVE MODE (toggle on):                           │
│   ┌────────┐     ┌────────┐                            │
│   │  512   │  x  │  768   │                            │
│   └────────┘     └────────┘                            │
│   W              H                                      │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

Toggle icon: `⇄` or similar swap/switch icon

---

## Files to Modify/Create

| File | Change |
|------|--------|
| `InputRenderer.tsx` | **NEW** - Input routing component with alternative support |
| `AlternativeInputWrapper.tsx` | **NEW** - Toggle + conditional rendering + compose logic |
| `SchemaRenderer.tsx` | Route to `InputRenderer` when `input_type` present |
| `TerminalRenderer.tsx` | Remove input routing (moved to InputRenderer) |
| `InputSchemaContext.tsx` | Add `alternativeMode`, `isAlternativeMode`, `setAlternativeMode` |
| `InputSchemaComposer.tsx` | Initialize `alternativeMode` state, provide in context |
| `types.ts` | Add `AlternativeConfig` and `AlternativeField` interfaces |
| `cc_image_prompts_display_schema.json` | Add `alternative` to resolution field |

### Server-side
| File | Change |
|------|--------|
| SD API | Return `{ value: { text, width, height }, count }` for resolution options |

---

## Edge Cases

1. **No selection yet**: Use `default` values from alternative field schemas
2. **Toggle back with custom value**: Reset to default option if composed value doesn't match any dropdown option
3. **Value is string (not object)**: For backwards compatibility, if value is string, alternative mode extracts via compose pattern in reverse (or uses defaults)

---

## Technical Debt

| Item | Description | Priority |
|------|-------------|----------|
| Custom option on toggle back | When toggling from alternative back to primary with a custom value that doesn't match any option, add "Custom" as a virtual option instead of resetting | Medium |
| TerminalRenderer cleanup | After InputRenderer is created, audit TerminalRenderer to ensure clean separation of display vs input concerns | Low |
| Input routing in TerminalRenderer | The current pattern of having inputs in TerminalRenderer was not ideal from the start - InputRenderer addresses this | N/A (addressed) |
