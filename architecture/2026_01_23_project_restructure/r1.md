# Project Restructure: Backend/UI Separation with Editable Install

## Summary

Restructure the project to:
1. Group backend Python packages under `backend/`
2. Group UI applications under `ui/`
3. Use `pyproject.toml` with editable install for clean imports
4. Eliminate PYTHONPATH hacks in scripts

## Current Structure

```
wm-dev/
├── server/
│   ├── db/              # Database layer (PROBLEM: inside server)
│   ├── api/
│   ├── engine/
│   ├── modules/
│   └── workflow/
├── worker/              # Task queue worker
├── providers/           # Media providers (at root)
├── contracts/           # Shared types (tui ↔ server)
├── tui/                 # Terminal UI
├── webui/               # React frontend
├── workflows/           # JSON workflow definitions
├── shared/              # Legacy? (only template_validator.py)
├── scripts/             # Utility scripts
├── analysis/            # ?
├── legacy/              # Old code
├── status/              # ?
├── server-logs/         # Log files
├── deploy/              # Deployment configs
├── architecture/        # Design docs
└── issues/              # Issue tracking
```

**Problems:**
- `db/` inside `server/` but worker needs it → implicit coupling
- `providers/` at root, only used by backend
- Scripts use `sys.path` hacks to import
- No standard Python packaging

## Target Structure

```
wm-dev/
├── backend/
│   ├── __init__.py
│   ├── server/
│   │   ├── __init__.py
│   │   ├── api/
│   │   ├── engine/
│   │   ├── models/
│   │   ├── modules/
│   │   └── workflow/
│   ├── worker/
│   │   ├── __init__.py
│   │   ├── actors/
│   │   ├── loop.py
│   │   └── queue.py
│   ├── db/
│   │   ├── __init__.py
│   │   └── (repositories)
│   └── providers/
│       ├── __init__.py
│       └── media/
├── ui/
│   ├── webui/           # React app (no __init__.py)
│   └── tui/
│       ├── __init__.py
│       └── (strategies, handlers)
├── contracts/
│   ├── __init__.py
│   └── (interactions, events, etc.)
├── workflows/
├── scripts/
├── architecture/
├── issues/
├── deploy/
├── pyproject.toml       # NEW: Package definition
└── .python-version      # Optional: pin Python version
```

**Removed/Consolidated:**
- `shared/` → Move `template_validator.py` to appropriate location or delete if
  unused
<!--- template_validator is used by tui and server, lets move to contracts,
because it is a contract in loosest form of word -->
- `analysis/`, `legacy/`, `status/` → Archive or delete if unused <!--
- analysis is a tool used analyze code of server and tui to find if there're
  any shared code, i think this is out of date, its safe to delete
- status is UI client used with tui to track status of projects. we can move
  this to ui. -->
- `server-logs/` → Add to .gitignore, not part of structure
<!--this is an pretty annoying one, i want to delete this folder, and find
where we use it and then set logs folder to somewhere else-->

## Import Changes

### Before
```python
# server/api/app.py
from db import Database              # Works via PYTHONPATH hack

# worker/actors/media.py
from db import Database              # Works via PYTHONPATH hack
from providers.media import ...      # Works via PYTHONPATH hack

# server/api/routes/tasks.py
from worker.queue import TaskQueue   # Works via PYTHONPATH hack
```

### After
```python
# backend/server/api/app.py
from backend.db import Database

# backend/worker/actors/media.py
from backend.db import Database
from backend.providers.media import ...

# backend/server/api/routes/tasks.py
from backend.worker.queue import TaskQueue

# ui/tui/handler.py
from contracts import InteractionType
```

## Plan of Action (Commits)

### Phase 1: Setup pyproject.toml

**Commit 1: Add pyproject.toml**
- Create `pyproject.toml` with package configuration
- Create `backend/__init__.py`
- Update `.gitignore` for egg-info

### Phase 2: Create backend/ structure

**Commit 2: Create backend/ directory and move db/**
- Create `backend/` directory
- Move `server/db/` → `backend/db/`
- Add `backend/db/__init__.py` if needed

**Commit 3: Update db imports in server**
- Update all `from db import` → `from backend.db import` in server/
- Files affected:
  - `server/api/app.py`
  - `server/api/routes/management.py`
  - `server/api/routes/streaming.py`
  - `server/modules/media/sub_action.py`
  - `server/workflow/executor.py`
  - `server/workflow/interaction.py`
  - `server/workflow/navigation.py`
  - `server/workflow/processor.py`
  - `server/workflow/streaming.py`
  - `server/workflow/workflow_context.py`

**Commit 4: Move providers/ → backend/providers/**
- Move `providers/` → `backend/providers/`

**Commit 5: Update providers imports**
- Update all `from providers.` → `from backend.providers.` in server/
- Files affected:
  - `server/modules/media/sub_action.py`
  - `server/modules/media/__init__.py`

**Commit 6: Move server/ → backend/server/**
- Move `server/` → `backend/server/`
- Ensure `backend/server/__init__.py` exists

**Commit 7: Update server internal imports**
- Update any absolute imports within server that broke
- Update `from worker.` → `from backend.worker.` in server
- Files affected:
  - `backend/server/api/routes/streaming.py`
  - `backend/server/api/routes/tasks.py`

**Commit 8: Move worker/ → backend/worker/**
- Move `worker/` → `backend/worker/`
- Ensure `backend/worker/__init__.py` exists

**Commit 9: Update worker imports**
- Update `from db import` → `from backend.db import`
- Update `from providers.` → `from backend.providers.`
- Files affected:
  - `backend/worker/actors/media.py`

### Phase 3: Create ui/ structure

**Commit 10: Create ui/ and move webui/**
- Create `ui/` directory
- Move `webui/` → `ui/webui/`

**Commit 11: Move tui/ → ui/tui/**
- Move `tui/` → `ui/tui/`
- Ensure `ui/tui/__init__.py` exists

**Commit 12: Update tui imports (if any absolute paths)**
- Check for any hardcoded paths in tui
- Update if necessary

### Phase 4: Update scripts and configs

**Commit 13: Update start scripts**
- Update `scripts/start_server.sh`:
  - Remove PYTHONPATH hacks
  - Add `pip install -e .` if not installed
  - Update module path: `python -m backend.server`
- Update `scripts/start_worker.sh`:
  - Remove PYTHONPATH hacks
  - Update module path: `python -m backend.worker`
- Update `scripts/start_tui.sh`:
  - Update path to `ui/tui`

**Commit 14: Update utility scripts**
- Update `sys.path` hacks in dated scripts to use proper imports
- Or add note that they require `pip install -e .`

**Commit 15: Update worker __main__.py**
- Update `from .loop import WorkerLoop` (should still work)
- Verify relative imports work

**Commit 16: Update server entry point**
- Update uvicorn target path if needed
- `uvicorn backend.server.api.app:app`

### Phase 5: Cleanup

**Commit 17: Clean up legacy directories**
- Evaluate `shared/`, `analysis/`, `legacy/`, `status/`
- Move `shared/template_validator.py` if used, or delete
- Archive or delete unused directories

**Commit 18: Update documentation**
- Update `CLAUDE.md` with new structure
- Update any README files

### Phase 6: Verification

**Commit 19: Add/update import check script**
- Update pre-commit hook to check imports from new paths
- Verify all imports resolve correctly

## pyproject.toml Content

```toml
[project]
name = "wm-dev"
version = "0.1.0"
description = "Workflow Management System"
requires-python = ">=3.10"
dependencies = [
    # List runtime dependencies here or keep in requirements.txt
]

[build-system]
requires = ["setuptools>=61.0"]
build-backend = "setuptools.build_meta"

[tool.setuptools.packages.find]
where = ["."]
include = ["backend*", "contracts*"]
exclude = ["ui.webui*"]  # webui is not a Python package

[tool.setuptools.package-data]
"*" = ["*.json", "*.yaml", "*.yml"]
```

## Verification Checklist

After all commits:
- [ ] `pip install -e .` succeeds
- [ ] `python -m backend.server` starts the server
- [ ] `python -m backend.worker` starts the worker
- [ ] `python -c "from backend.db import Database"` works
- [ ] `python -c "from backend.providers.media import MediaProviderRegistry"` works
- [ ] `python -c "from contracts import InteractionType"` works
- [ ] TUI can start and connect to server
- [ ] WebUI can build and connect to server
- [ ] Worker can process media generation tasks
- [ ] All existing functionality works

## Rollback Plan

If issues arise:
1. Each commit is atomic and can be reverted individually
2. Keep a backup branch before starting: `git checkout -b backup/pre-restructure`
3. If critical issues, revert all commits: `git revert --no-commit HEAD~N..HEAD`

## Questions for Review

1. Should `shared/template_validator.py` move to `backend/` or be deleted?
2. Are `analysis/`, `legacy/`, `status/` directories still needed?
3. Should we keep `server-logs/` in the repo or gitignore it?
4. Do we want to add the tui package to pyproject.toml? (`ui.tui*`)
<!--no, no one should be able to import from it. same goes for status as well-->
