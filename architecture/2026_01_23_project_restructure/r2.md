# Project Restructure: Backend/UI Separation with Editable Install

## Summary

Restructure the project to:
1. Group backend Python packages under `backend/`
2. Group UI applications under `ui/`
3. Use `pyproject.toml` with editable install for clean imports
4. Eliminate PYTHONPATH hacks in scripts

## Current Structure

```
wm-dev/
├── server/
│   ├── db/              # Database layer (PROBLEM: inside server)
│   ├── api/
│   ├── engine/
│   ├── modules/
│   └── workflow/
├── worker/              # Task queue worker
├── providers/           # Media providers (at root)
├── contracts/           # Shared types (tui ↔ server)
├── tui/                 # Terminal UI
├── webui/               # React frontend
├── workflows/           # JSON workflow definitions
├── shared/              # template_validator.py (used by tui + server)
├── scripts/             # Utility scripts
├── analysis/            # Outdated analysis tool
├── legacy/              # Old code
├── status/              # Status UI client for tui
├── server-logs/         # Log files (hardcoded in server.py)
├── deploy/              # Deployment configs
├── architecture/        # Design docs
└── issues/              # Issue tracking
```

## Target Structure

```
wm-dev/
├── backend/
│   ├── __init__.py
│   ├── server/
│   │   ├── __init__.py
│   │   ├── api/
│   │   ├── engine/
│   │   ├── models/
│   │   ├── modules/
│   │   └── workflow/
│   ├── worker/
│   │   ├── __init__.py
│   │   ├── actors/
│   │   ├── loop.py
│   │   └── queue.py
│   ├── db/
│   │   ├── __init__.py
│   │   └── (repositories)
│   └── providers/
│       ├── __init__.py
│       └── media/
├── ui/
│   ├── webui/           # React app (no __init__.py needed)
│   ├── tui/             # Terminal UI (not importable)
│   └── status/          # Status tracking UI (moved from root)
├── contracts/
│   ├── __init__.py
│   ├── interactions.py
│   ├── events.py
│   ├── handlers.py
│   ├── validation.py
│   ├── capabilities.py
│   └── template_validator.py  # Moved from shared/
├── workflows/
├── scripts/
├── architecture/
├── issues/
├── deploy/
├── pyproject.toml       # NEW: Package definition
└── .python-version      # Optional: pin Python version
```

**Decisions:**
- `shared/template_validator.py` → Move to `contracts/` (it's a contract between tui and server)
- `analysis/` → Delete (outdated)
- `legacy/` → Delete (old code)
- `status/` → Move to `ui/status/`
- `server-logs/` → Delete, update `server.py` to use configurable log directory
- TUI and status are NOT in pyproject.toml (not importable packages)

## Import Changes

### Before
```python
# server/api/app.py
from db import Database              # Works via PYTHONPATH hack

# worker/actors/media.py
from db import Database              # Works via PYTHONPATH hack
from providers.media import ...      # Works via PYTHONPATH hack

# server/api/routes/tasks.py
from worker.queue import TaskQueue   # Works via PYTHONPATH hack

# server/engine/jinja2_resolver.py
from shared.template_validator import TemplateValidator

# tui/strategies/mixins.py
from shared.template_validator import TemplateValidator
```

### After
```python
# backend/server/api/app.py
from backend.db import Database

# backend/worker/actors/media.py
from backend.db import Database
from backend.providers.media import ...

# backend/server/api/routes/tasks.py
from backend.worker.queue import TaskQueue

# backend/server/engine/jinja2_resolver.py
from contracts.template_validator import TemplateValidator

# ui/tui/strategies/mixins.py
from contracts.template_validator import TemplateValidator
```

## Plan of Action (Commits)

### Phase 1: Preparation

**Commit 1: Add pyproject.toml and backend/__init__.py**
- Create `pyproject.toml` with package configuration
- Create `backend/__init__.py`
- Update `.gitignore` for egg-info, build artifacts

### Phase 2: Move shared to contracts

**Commit 2: Move template_validator to contracts**
- Move `shared/template_validator.py` → `contracts/template_validator.py`
- Update `contracts/__init__.py` to export it
- Delete `shared/` directory

**Commit 3: Update template_validator imports**
- Update `server/engine/jinja2_resolver.py`: `from shared.` → `from contracts.`
- Update `tui/strategies/mixins.py`: `from shared.` → `from contracts.`

### Phase 3: Create backend/ structure

**Commit 4: Move db/ to backend/db/**
- Move `server/db/` → `backend/db/`
- Add `backend/db/__init__.py` if needed

**Commit 5: Update db imports in server**
- Update all `from db import` → `from backend.db import` in server/
- Files:
  - `server/api/app.py`
  - `server/api/routes/management.py`
  - `server/api/routes/streaming.py`
  - `server/modules/media/sub_action.py`
  - `server/workflow/executor.py`
  - `server/workflow/interaction.py`
  - `server/workflow/navigation.py`
  - `server/workflow/processor.py`
  - `server/workflow/streaming.py`
  - `server/workflow/workflow_context.py`

**Commit 6: Move providers/ → backend/providers/**
- Move `providers/` → `backend/providers/`

**Commit 7: Update providers imports in server**
- Update `from providers.` → `from backend.providers.`
- Files:
  - `server/modules/media/sub_action.py`
  - `server/modules/media/__init__.py`

**Commit 8: Move server/ → backend/server/**
- Move `server/` → `backend/server/`

**Commit 9: Update server internal imports**
- Update `from worker.` → `from backend.worker.`
- Files:
  - `backend/server/api/routes/streaming.py`
  - `backend/server/api/routes/tasks.py`

**Commit 10: Move worker/ → backend/worker/**
- Move `worker/` → `backend/worker/`

**Commit 11: Update worker imports**
- Update `from db import` → `from backend.db import`
- Update `from providers.` → `from backend.providers.`
- Files:
  - `backend/worker/actors/media.py`

### Phase 4: Create ui/ structure

**Commit 12: Create ui/ and move webui/**
- Create `ui/` directory
- Move `webui/` → `ui/webui/`

**Commit 13: Move tui/ → ui/tui/**
- Move `tui/` → `ui/tui/`

**Commit 14: Update tui imports**
- Update `from contracts` paths if needed (should still work)
- Update any hardcoded paths

**Commit 15: Move status/ → ui/status/**
- Move `status/` → `ui/status/`

### Phase 5: Update scripts and entry points

**Commit 16: Fix server-logs and update server.py**
- Update `server.py` to use configurable log directory (env var or ./logs/)
- Delete `server-logs/` directory
- Add `logs/` to `.gitignore`

**Commit 17: Update start scripts**
- Update `scripts/start_server.sh`:
  - Remove PYTHONPATH hacks
  - Run `pip install -e .` if needed
  - Update: `uvicorn backend.server.api.app:app`
- Update `scripts/start_worker.sh`:
  - Remove PYTHONPATH hacks
  - Update: `python -m backend.worker`
- Update `scripts/start_tui.sh`:
  - Update path to `ui/tui`
- Update `scripts/start_webui.sh`:
  - Update path to `ui/webui`

**Commit 18: Update worker __main__.py**
- Update module path if needed
- Verify relative imports still work

### Phase 6: Cleanup

**Commit 19: Delete legacy directories**
- Delete `analysis/`
- Delete `legacy/`

**Commit 20: Update documentation**
- Update `CLAUDE.md` with new structure
- Update any README files

### Phase 7: Verification

**Commit 21: Update import check script**
- Update pre-commit hook paths
- Verify all imports resolve correctly

## pyproject.toml Content

```toml
[project]
name = "wm-dev"
version = "0.1.0"
description = "Workflow Management System"
requires-python = ">=3.10"

[build-system]
requires = ["setuptools>=61.0"]
build-backend = "setuptools.build_meta"

[tool.setuptools.packages.find]
where = ["."]
include = ["backend*", "contracts*"]
# ui/ packages are NOT included - they are applications, not libraries
```

## server-logs Fix

Current (`server.py`):
```python
log_dir = os.path.join(script_dir, 'server-logs')
```

New:
```python
log_dir = os.environ.get('LOG_DIR', os.path.join(script_dir, 'logs'))
```

## Verification Checklist

After all commits:
- [ ] `pip install -e .` succeeds
- [ ] `python -m backend.server.api.app` or uvicorn works
- [ ] `python -m backend.worker` starts the worker
- [ ] `python -c "from backend.db import Database"` works
- [ ] `python -c "from backend.providers.media import MediaProviderRegistry"` works
- [ ] `python -c "from contracts import InteractionType"` works
- [ ] `python -c "from contracts.template_validator import TemplateValidator"` works
- [ ] TUI can start and connect to server
- [ ] WebUI can build and connect to server
- [ ] Worker can process tasks
- [ ] Logs go to `logs/` directory

## Rollback Plan

If issues arise:
1. Each commit is atomic and can be reverted individually
2. Keep a backup branch before starting: `git checkout -b backup/pre-restructure`
3. If critical issues: `git revert --no-commit HEAD~N..HEAD`

## File Count Summary

| Change Type | Count |
|-------------|-------|
| Directories to move | 7 (db, providers, server, worker, webui, tui, status) |
| Directories to delete | 3 (shared, analysis, legacy, server-logs) |
| Files with import updates | ~20 |
| Scripts to update | 4 |
| Total commits | 21 |
