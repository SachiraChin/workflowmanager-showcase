# Workflow Files Panel - Architecture Document

## Summary

Add a side panel to the WebUI to display workflow files (API call logs) in a hierarchical tree view. This enables debugging of LLM requests/responses by showing all files generated during workflow execution.

## Background

When the server makes requests to LLM providers, `call_logger.py` writes request/response data as files to the `workflow_files` MongoDB collection. Currently, there's no UI to browse these files. This feature adds a panel similar to the existing "Workflow State" panel but for files.

## Design Decisions

### 1. Extend Existing State Stream (Not Create New Stream)

**Decision**: Add file tree data to the existing `/workflow/{id}/state/v2/stream` endpoint.

**Rationale**:
- Avoid proliferating SSE streams (state, files, future status)
- Files are logically part of workflow state
- Reuses existing change detection and connection management
- Single stream for all workflow state data

### 2. File Hierarchy Structure

Files displayed in hierarchy: `/{category}/[step_id]/[created_date]/[file_role]/{filename}`

Rules:
```
/{category}                                    # "api_calls" or "outputs"
<!--for below its not category has groups, its if give file has groups value or if its null/undefined-->
  /[step_id if category has groups]            # e.g., "user_input", "prompt_generation"
    /[created_date if step has multiple groups] # e.g., "2026-01-19 18:58" (user's TZ)
      <!--lets remove below, its not going work looking at your example.-->
      /[file_role if present]                   # e.g., "request", "response", "input", "output"
        /{filename}                             # e.g., "request.json", "message_0_content.txt"
```

Examples:
```
/api_calls
  /user_input
    /2026-01-19 18:58
      /request
        request.json
      /input
        input_0_content_0.txt
        input_1_content_0.txt
      /response
        response.json
      /output
        output_0_content_0.json
      /schema.json        (no file_role = at step level)
      /metadata.json
    /2026-01-19 19:05     (second API call for same step)
      /...
  /prompt_generation
    /request              (only one group, no date level)
      request.json
    /...
/outputs
  aesthetic_concepts.json   (no groups, flat list)
  scene_summary.json
```

### 3. File Content Loading Strategy

**Decision**: Stream file metadata only; load content on-demand via existing REST API.

**Rationale**:
- File content can be large (prompts, responses)
- Avoid bloating SSE stream
- Existing `/workflow/{id}/files/{file_id}` API provides content
- Lazy loading improves performance

### 4. Panel Visibility

**Current behavior (bug)**: `StateTreeView` only renders when `pageState === "running"` (WorkflowRunnerPage.tsx:220). This is incorrect - state should be viewable after workflow completes or errors for debugging purposes.

**Correct behavior**: Both StateTreeView and FilesTreeView should always be visible regardless of workflow status (running, completed, or error).

**Fix required**: Remove the conditional rendering:
```tsx
// Current (incorrect):
{pageState === "running" && <StateTreeView />}

// Fixed:
<StateTreeView />
<FilesTreeView />
```

## Technical Specification

### Backend Changes

#### 1. State Repository Extension

**File**: `backend/db/repos/state.py`

Add new method or extend `get_module_outputs_hierarchical()`:

```python
def get_workflow_state_with_files(
    self, workflow_run_id: str, branch_id: str = None
) -> Dict[str, Any]:
    """
    Get workflow state including file tree.

    Returns:
        {
            "steps": {...},        # existing hierarchical state
            "state_mapped": {...}, # existing state-mapped values
            "files": {...}         # NEW: file tree structure
        }
    """
    # Get existing state
    state = self.get_module_outputs_hierarchical(workflow_run_id, branch_id)

    # Add file tree
    state["files"] = self._build_file_tree(workflow_run_id, branch_id)

    return state

def _build_file_tree(
    self, workflow_run_id: str, branch_id: str = None
) -> Dict[str, Any]:
    """
    Build hierarchical file tree from workflow_files collection.

    Structure:
    {
        "api_calls": {
            "step_id": [
                {
                    "group_id": "user_input_openai_20260119_105840_004596",
                    "created_at": "2026-01-19T18:58:40.012000",
                    "files": [
                        {
                            "file_id": "wff_...",
                            "filename": "request.json",
                            "content_type": "json",
                            "file_role": "request"
                        },
                        ...
                    ]
                }
            ]
        },
        "outputs": [
            {
                "file_id": "wff_...",
                "filename": "aesthetic_concepts.json",
                "content_type": "json"
            }
        ]
    }
    """
```

#### 2. State API Routes Update

**File**: `backend/server/api/routes/state.py`

Update `/state/v2` and `/state/v2/stream` to use the new method:

```python
@router.get("/{workflow_run_id}/state/v2")
async def get_workflow_state_v2(...):
    # Change from:
    # state = db.state_repo.get_module_outputs_hierarchical(workflow_run_id)
    # To:
    <!--i dont think this method name going to work, let have something clearly 
    conveys this is meant to generate full state of a workflow. -->
    state = db.state_repo.get_workflow_state_with_files(workflow_run_id)
    return {"workflow_run_id": workflow_run_id, "state": state}
```

Same change for the streaming endpoint.

### Frontend Changes

#### 1. Types

**File**: `ui/webui/src/lib/types.ts`

```typescript
// File tree types
interface WorkflowFile {
  file_id: string;
  filename: string;
  content_type: "json" | "text";
  file_role?: string;  // "request" | "response" | "input" | "output" | "schema" | "metadata"
}

interface FileGroup {
  group_id: string;
  created_at: string;  // ISO timestamp
  files: WorkflowFile[];
}

interface FileTree {
  api_calls: Record<string, FileGroup[]>;  // step_id -> groups
  outputs: WorkflowFile[];
}
```

#### 2. Context Extension

**File**: `ui/webui/src/contexts/WorkflowStateContext.tsx`

Add file tree access:

```typescript
interface WorkflowStateContextValue {
  // ... existing
  files: FileTree | null;
  fetchFileContent: (fileId: string) => Promise<FileContent>;
}
```

#### 3. New Component: FilesTreeView

**File**: `ui/webui/src/components/workflow/state/FilesTreeView.tsx`

Similar structure to `StateTreeView.tsx`:
- Hierarchical tree with expand/collapse
- Category nodes (api_calls, outputs)
- Step nodes (under api_calls)
- Date nodes (if multiple groups per step)
- File role nodes (request, response, etc.)
- File leaf nodes

On file click:
1. Call `fetchFileContent(fileId)`
2. Display in dialog (reuse existing popup pattern)
3. Support JSON tree view for JSON files, pre-formatted text for text files

#### 4. Component Registration

**File**: `ui/webui/src/components/workflow/state/index.ts`

```typescript
export { FilesTreeView } from "./FilesTreeView";
```

#### 5. Page Integration

**File**: `ui/webui/src/pages/WorkflowRunnerPage.tsx`

```tsx
// Change from:
{pageState === "running" && <StateTreeView />}

// To:
<StateTreeView />
<FilesTreeView />
```

### API Contract

#### State Response (Extended)

```json
{
  "workflow_run_id": "wf_xxx",
  "state": {
    "steps": {
      "_metadata": {"node_type": "steps_container"},
      "user_input": {
        "_metadata": {"node_type": "step"},
        "extract_intent": {
          "_metadata": {"node_type": "module"},
          "module_completed": {...}
        }
      }
    },
    "state_mapped": {
      "user_intent": "..."
    },
    "files": {
      "api_calls": {
        "user_input": [
          {
            "group_id": "user_input_openai_20260119_105840_004596",
            "created_at": "2026-01-19T18:58:40.012000",
            "files": [
              {"file_id": "wff_019bd79f9b0c763a...", "filename": "request.json", "content_type": "json", "file_role": "request"},
              {"file_id": "wff_019bd79f9b0c763b...", "filename": "response.json", "content_type": "json", "file_role": "response"},
              {"file_id": "wff_019bd79f9b0c763c...", "filename": "input_0_content_0.txt", "content_type": "text", "file_role": "input"}
            ]
          }
        ]
      },
      "outputs": [
        {"file_id": "wff_019bd7a0...", "filename": "aesthetic_concepts.json", "content_type": "json"}
      ]
    }
  }
}
```

#### SSE Event (No Change to Format)

Event type remains `state_snapshot`:
```
event: state_snapshot
data: {"state": {...including files...}}
```

#### File Content Fetch (Existing API)

```
GET /workflow/{workflow_run_id}/files/{file_id}

Response:
{
  "file_id": "wff_...",
  "workflow_run_id": "wf_...",
  "category": "api_calls",
  "group_id": "user_input_openai_20260119_105840_004596",
  "filename": "request.json",
  "content_type": "json",
  "content": {...actual content...},
  "metadata": {"step_id": "user_input", "provider": "openai", "file_role": "request"}
}
```

## File Affected

### Backend
- `backend/db/repos/state.py` - Add file tree building
- `backend/server/api/routes/state.py` - Use extended state method

### Frontend
- `ui/webui/src/lib/types.ts` - Add file tree types
- `ui/webui/src/contexts/WorkflowStateContext.tsx` - Add files access
- `ui/webui/src/components/workflow/state/FilesTreeView.tsx` - NEW
- `ui/webui/src/components/workflow/state/index.ts` - Export new component
- `ui/webui/src/pages/WorkflowRunnerPage.tsx` - Add FilesTreeView, fix StateTreeView visibility bug (remove `pageState === "running"` condition)

## Open Questions

1. **Date formatting**: Should `created_at` be formatted in user's timezone on frontend, or should backend send pre-formatted string?
   - Recommendation: Send ISO timestamp, format on frontend using user's locale
   <!--sure-->

2. **Empty state**: What to show when no files exist yet?
   - Recommendation: "No files yet" message, same as StateTreeView
   <!--yes-->

3. **File icons**: Should we show different icons for json vs text files?
   - Recommendation: Yes, small visual distinction helps usability
   <!-- yes -->

4. **Search**: Should FilesTreeView have search like StateTreeView?
   - Recommendation: Yes, consistent UX, useful for finding specific files
   <--yes-->

5. **Maximizable**: Should FilesTreeView be maximizable like StateTreeView?
   - Recommendation: Yes, consistent UX
   <!--yes-->

## Implementation Order

1. Backend: Add `_build_file_tree()` method to state repository
2. Backend: Update `get_workflow_state_with_files()` to include files
3. Backend: Update state API routes
4. Frontend: Add types
5. Frontend: Update context
6. Frontend: Create FilesTreeView component
7. Frontend: Integrate into WorkflowRunnerPage - add FilesTreeView and fix StateTreeView visibility bug
