# Workflow Files Panel - Architecture Document (r2)

## Summary

Add a side panel to the WebUI to display workflow files (API call logs) in a hierarchical tree view. This enables debugging of LLM requests/responses by showing all files generated during workflow execution.

## Background

When the server makes requests to LLM providers, `call_logger.py` writes request/response data as files to the `workflow_files` MongoDB collection. Currently, there's no UI to browse these files. This feature adds a panel similar to the existing "Workflow State" panel but for files.

## Design Decisions

### 1. Extend Existing State Stream (Not Create New Stream)

**Decision**: Add file tree data to the existing `/workflow/{id}/state/v2/stream` endpoint.

**Rationale**:
- Avoid proliferating SSE streams (state, files, future status)
- Files are logically part of workflow state
- Reuses existing change detection and connection management
- Single stream for all workflow state data

### 2. File Hierarchy Structure

Files displayed in hierarchy: `/{category}/[step_id]/[created_date]/{filename}`

Rules:
```
/{category}                                     # "api_calls" or "outputs"
  /[step_id if file has group_id]               # e.g., "user_input", "prompt_generation"
    /[created_date if step has multiple groups] # e.g., "2026-01-19 18:58" (user's TZ)
      /{filename}                               # e.g., "request.json", "message_0_content.txt"
```

- `step_id` level: Only shown if the file has a `group_id` value (not null/undefined)
- `created_date` level: Only shown if a step has multiple groups (multiple API calls)
- Files without `group_id` appear directly under their category

Examples:
```
/api_calls
  /user_input
    /2026-01-19 18:58        (first API call)
      request.json
      response.json
      schema.json
      metadata.json
      input_0_content_0.txt
      output_0_content_0.json
    /2026-01-19 19:05        (second API call for same step)
      request.json
      response.json
      ...
  /prompt_generation         (only one group, no date level)
    request.json
    response.json
    ...
/outputs                     (no group_id, flat list)
  aesthetic_concepts.json
  scene_summary.json
```

### 3. File Content Loading Strategy

**Decision**: Stream file metadata only; load content on-demand via existing REST API.

**Rationale**:
- File content can be large (prompts, responses)
- Avoid bloating SSE stream
- Existing `/workflow/{id}/files/{file_id}` API provides content
- Lazy loading improves performance

### 4. Panel Visibility

**Current behavior (bug)**: `StateTreeView` only renders when `pageState === "running"` (WorkflowRunnerPage.tsx:220). This is incorrect - state should be viewable after workflow completes or errors for debugging purposes.

**Correct behavior**: Both StateTreeView and FilesTreeView should always be visible regardless of workflow status (running, completed, or error).

**Fix required**: Remove the conditional rendering:
```tsx
// Current (incorrect):
{pageState === "running" && <StateTreeView />}

// Fixed:
<StateTreeView />
<FilesTreeView />
```

## Technical Specification

### Backend Changes

#### 1. State Repository Extension

**File**: `backend/db/repos/state.py`

Add new method to build complete workflow state:

```python
def get_full_workflow_state(
    self, workflow_run_id: str, branch_id: str = None
) -> Dict[str, Any]:
    """
    Get complete workflow state including module outputs and file tree.

    Returns:
        {
            "steps": {...},        # hierarchical module state
            "state_mapped": {...}, # state-mapped values
            "files": {...}         # file tree structure
        }
    """
    # Get existing state
    state = self.get_module_outputs_hierarchical(workflow_run_id, branch_id)

    # Add file tree
    state["files"] = self._build_file_tree(workflow_run_id, branch_id)

    return state

def _build_file_tree(
    self, workflow_run_id: str, branch_id: str = None
) -> Dict[str, Any]:
    """
    Build hierarchical file tree from workflow_files collection.

    Structure:
    {
        "api_calls": {
            "step_id": [
                {
                    "group_id": "user_input_openai_20260119_105840_004596",
                    "created_at": "2026-01-19T18:58:40.012000",
                    "files": [
                        {
                            "file_id": "wff_...",
                            "filename": "request.json",
                            "content_type": "json"
                        },
                        ...
                    ]
                }
            ]
        },
        "outputs": [
            {
                "file_id": "wff_...",
                "filename": "aesthetic_concepts.json",
                "content_type": "json"
            }
        ]
    }
    """
```

#### 2. State API Routes Update

**File**: `backend/server/api/routes/state.py`

Update `/state/v2` and `/state/v2/stream` to use the new method:

```python
@router.get("/{workflow_run_id}/state/v2")
async def get_workflow_state_v2(...):
    # Change from:
    # state = db.state_repo.get_module_outputs_hierarchical(workflow_run_id)
    # To:
    state = db.state_repo.get_full_workflow_state(workflow_run_id)
    return {"workflow_run_id": workflow_run_id, "state": state}
```

Same change for the streaming endpoint.

### Frontend Changes

#### 1. Types

**File**: `ui/webui/src/lib/types.ts`

```typescript
// File tree types
interface WorkflowFile {
  file_id: string;
  filename: string;
  content_type: "json" | "text";
}

interface FileGroup {
  group_id: string;
  created_at: string;  // ISO timestamp
  files: WorkflowFile[];
}

interface FileTree {
  api_calls: Record<string, FileGroup[]>;  // step_id -> groups
  outputs: WorkflowFile[];
}
```

#### 2. Context Extension

**File**: `ui/webui/src/contexts/WorkflowStateContext.tsx`

Add file tree access:

```typescript
interface WorkflowStateContextValue {
  // ... existing
  files: FileTree | null;
  fetchFileContent: (fileId: string) => Promise<FileContent>;
}
```

#### 3. New Component: FilesTreeView

**File**: `ui/webui/src/components/workflow/state/FilesTreeView.tsx`

Similar structure to `StateTreeView.tsx`:
- Hierarchical tree with expand/collapse
- Category nodes (api_calls, outputs)
- Step nodes (if file has group_id)
- Date nodes (if multiple groups per step)
- File leaf nodes with icons (different for json vs text)
- Search functionality
- Maximize button
- Empty state: "No files yet"

On file click:
1. Call `fetchFileContent(fileId)` via existing API
2. Display in dialog (reuse existing popup pattern)
3. Support JSON tree view for JSON files, pre-formatted text for text files

#### 4. Component Registration

**File**: `ui/webui/src/components/workflow/state/index.ts`

```typescript
export { FilesTreeView } from "./FilesTreeView";
```

#### 5. Page Integration

**File**: `ui/webui/src/pages/WorkflowRunnerPage.tsx`

```tsx
// Remove conditional, add FilesTreeView:
<StateTreeView />
<FilesTreeView />
```

### API Contract

#### State Response (Extended)

```json
{
  "workflow_run_id": "wf_xxx",
  "state": {
    "steps": {
      "_metadata": {"node_type": "steps_container"},
      "user_input": {
        "_metadata": {"node_type": "step"},
        "extract_intent": {
          "_metadata": {"node_type": "module"},
          "module_completed": {...}
        }
      }
    },
    "state_mapped": {
      "user_intent": "..."
    },
    "files": {
      "api_calls": {
        "user_input": [
          {
            "group_id": "user_input_openai_20260119_105840_004596",
            "created_at": "2026-01-19T18:58:40.012000",
            "files": [
              {"file_id": "wff_019bd79f9b0c763a...", "filename": "request.json", "content_type": "json"},
              {"file_id": "wff_019bd79f9b0c763b...", "filename": "response.json", "content_type": "json"},
              {"file_id": "wff_019bd79f9b0c763c...", "filename": "input_0_content_0.txt", "content_type": "text"}
            ]
          }
        ]
      },
      "outputs": [
        {"file_id": "wff_019bd7a0...", "filename": "aesthetic_concepts.json", "content_type": "json"}
      ]
    }
  }
}
```

#### SSE Event (No Change to Format)

Event type remains `state_snapshot`:
```
event: state_snapshot
data: {"state": {...including files...}}
```

#### File Content Fetch (Existing API)

```
GET /workflow/{workflow_run_id}/files/{file_id}

Response:
{
  "file_id": "wff_...",
  "workflow_run_id": "wf_...",
  "category": "api_calls",
  "group_id": "user_input_openai_20260119_105840_004596",
  "filename": "request.json",
  "content_type": "json",
  "content": {...actual content...},
  "metadata": {"step_id": "user_input", "provider": "openai", "file_role": "request"}
}
```

## Files Affected

### Backend
- `backend/db/repos/state.py` - Add `get_full_workflow_state()` and `_build_file_tree()`
- `backend/server/api/routes/state.py` - Use `get_full_workflow_state()`

### Frontend
- `ui/webui/src/lib/types.ts` - Add file tree types
- `ui/webui/src/contexts/WorkflowStateContext.tsx` - Add files access
- `ui/webui/src/components/workflow/state/FilesTreeView.tsx` - NEW
- `ui/webui/src/components/workflow/state/index.ts` - Export new component
- `ui/webui/src/pages/WorkflowRunnerPage.tsx` - Add FilesTreeView, fix StateTreeView visibility bug

## Resolved Questions

1. **Date formatting**: ISO timestamp from backend, format on frontend using user's locale
2. **Empty state**: "No files yet" message
3. **File icons**: Yes, different icons for json vs text
4. **Search**: Yes, same as StateTreeView
5. **Maximizable**: Yes, same as StateTreeView

## Implementation Order

1. Backend: Add `_build_file_tree()` method to state repository
2. Backend: Add `get_full_workflow_state()` method
3. Backend: Update state API routes to use new method
4. Frontend: Add file tree types
5. Frontend: Update context with files access
6. Frontend: Create FilesTreeView component
7. Frontend: Integrate into WorkflowRunnerPage and fix StateTreeView visibility
