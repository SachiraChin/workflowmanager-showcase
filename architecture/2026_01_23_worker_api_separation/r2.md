# Worker-Server Separation via Shared Database Layer

## Summary

Decouple server and worker by extracting the database layer to a shared package (`backend/db/`). Both server and worker import from this shared package - neither imports from the other. The database (specifically TaskQueue) serves as the communication contract between the two processes.

## Background

### Original Problem

Server imports from worker, creating wrong-direction dependency:

```python
# backend/server/api/routes/tasks.py
from backend.worker.queue import TaskQueue  # Wrong direction

# backend/server/api/routes/streaming.py
from backend.worker.queue import TaskQueue  # Wrong direction
```

### Original Proposed Solution (r1)

Build an HTTP API on worker, have server call it instead of importing TaskQueue directly.

### Why That Approach Was Abandoned

During discussion, we identified a deeper problem:

**The stream cancellation issue:**
- User triggers media generation
- Server streams progress to user's browser
- User refreshes page → stream closes
- If storage depends on stream being open → data is lost

**Current solution (worker writes to DB):**
- Worker handles entire process independently
- Worker writes content data directly to MongoDB
- User refresh doesn't affect worker
- Data persists regardless of browser session

**The conflict with Worker API approach:**
- If worker exposes HTTP API, and server must call it to store data...
- When user refreshes, server's connection to worker API could also be affected
- We'd need a "sync loop" in server to poll completed tasks
- This creates convoluted coordination between real-time streaming and background sync

**Options considered:**

| Approach | Problem |
|----------|---------|
| Worker returns data in result, server stores | Sync loop needed, convoluted |
| Worker calls server API to store | Circular dependency |
| Shared DB with separate code | Just moving code around |
| Worker API + sync loop | Too complex, coordination issues |

**Conclusion:** The database IS the natural API between server and worker. Embrace it.

## Target Architecture

### Package Structure

```
backend/
├── db/                          # Shared data layer
│   ├── __init__.py              # Exports Database, TaskQueue, etc.
│   ├── README.md                # Package documentation
│   ├── database.py              # Database connection manager
│   ├── base.py                  # BaseRepository
│   ├── utils.py                 # Shared utilities (uuid7_str, etc.)
│   ├── queue/                   # Task queue
│   │   ├── __init__.py
│   │   └── task_queue.py        # TaskQueue class
│   ├── repos/                   # All repositories
│   │   ├── __init__.py
│   │   ├── content.py           # ContentRepository
│   │   ├── workflow.py          # WorkflowRepository
│   │   ├── event.py             # EventRepository
│   │   ├── user.py              # UserRepository
│   │   ├── branch.py            # BranchRepository
│   │   ├── file.py              # FileRepository
│   │   ├── state.py             # StateRepository
│   │   ├── token.py             # TokenRepository
│   │   └── version.py           # VersionRepository
│   ├── mixins/                  # Database mixins
│   │   ├── __init__.py
│   │   ├── config.py
│   │   ├── history.py
│   │   ├── migrations.py
│   │   └── recovery.py
│   └── migrations/              # Migration scripts
│       └── ...
├── server/                      # Server application
│   ├── api/
│   ├── engine/
│   ├── modules/
│   └── ...
├── worker/                      # Worker application
│   ├── actors/
│   ├── __main__.py
│   └── ...
└── providers/                   # Already shared
```

### Data Flow

```
Server Process                              Worker Process
      │                                           │
      │                                           │
      ├─── enqueue task ─────────────────────────►│
      │         │                                 │
      │         ▼                                 │
      │    ┌─────────┐                            │
      │    │TaskQueue│◄───── claim task ──────────┤
      │    └─────────┘                            │
      │         │                                 │
      │         │                                 ├─── process task
      │         │                                 │
      │         │                                 ├─── write content
      │         │                                 │         │
      │         │                                 │         ▼
      │    ┌─────────────┐                        │    ┌─────────────┐
      │    │ContentRepo  │◄───────────────────────┼────│ContentRepo  │
      │    └─────────────┘                        │    └─────────────┘
      │         │                                 │
      │◄─────── │ ◄────── complete task ──────────┤
      │         │                                 │
      ├─── read result                            │
      │                                           │
      ▼                                           ▼
┌──────────────────────────────────────────────────────────────┐
│                        backend/db/                           │
│                         (MongoDB)                            │
│                                                              │
│  ┌──────────┐  ┌──────────────┐  ┌────────────────────────┐  │
│  │  tasks   │  │   content_   │  │  workflows, events,    │  │
│  │          │  │  generation  │  │  branches, etc.        │  │
│  └──────────┘  └──────────────┘  └────────────────────────┘  │
└──────────────────────────────────────────────────────────────┘
```

### Import Structure

**Before (wrong direction):**
```
server ──imports──► worker.queue.TaskQueue
worker ──imports──► server.db.Database
```

**After (both import from shared):**
```
server ──imports──► db.Database, db.TaskQueue
worker ──imports──► db.Database, db.TaskQueue
```

No imports between server and worker in either direction.

## Implementation Plan

### Phase 1: Create backend/db/ Package

1. Create directory structure:
   ```
   backend/db/
   ├── __init__.py
   ├── README.md
   ├── database.py
   ├── base.py
   ├── utils.py
   ├── queue/
   ├── repos/
   ├── mixins/
   └── migrations/
   ```

2. Move files from `backend/server/db/`:
   - `database.py` → `backend/db/database.py` (rename class references)
   - `base.py` → `backend/db/base.py`
   - All repository files → `backend/db/repos/`
   - All mixin files → `backend/db/mixins/`
   - `migrations/` → `backend/db/migrations/`

3. Move `backend/worker/queue.py` → `backend/db/queue/task_queue.py`

4. Create `backend/db/utils.py` with shared utilities:
   - Copy `uuid7_str()` from `backend/server/utils.py`
   - Any other utilities needed by repositories

5. Create `backend/db/README.md` documenting the shared package

6. Update `backend/db/__init__.py` to export (using full paths):
   ```python
   from backend.db.database import Database
   from backend.db.queue import TaskQueue
   # ... other exports
   ```

### Phase 2: Update Server Imports

Update all files in `backend/server/` that import from `backend/server/db/`:

```python
# Before
from backend.server.db import Database, DbEventType

# After
from backend.db import Database, DbEventType
```

Files to update:
- `backend/server/api/app.py`
- `backend/server/api/dependencies.py`
- `backend/server/api/routes/*.py`
- `backend/server/engine/*.py`
- `backend/server/modules/**/*.py`
- Any other files importing from `backend/server/db`

For TaskQueue imports:
```python
# Before
from backend.worker.queue import TaskQueue

# After
from backend.db import TaskQueue
```

Files to update:
- `backend/server/api/routes/tasks.py`
- `backend/server/api/routes/streaming.py`

### Phase 3: Update Worker Imports

Update all files in `backend/worker/` that import from `backend/server/db/` or local queue:

```python
# Before
from backend.server.db import Database
from backend.worker.queue import TaskQueue

# After
from backend.db import Database, TaskQueue
```

Files to update:
- `backend/worker/actors/media.py`
- `backend/worker/__main__.py`
- `backend/worker/processor.py` (if exists)
- Any other files importing Database or TaskQueue

### Phase 4: Remove Old Locations

1. Delete `backend/server/db/` directory
2. Delete `backend/worker/queue.py`
3. Remove TODO comments about wrong-direction imports

### Phase 5: Update Imports Within db/ to Use Full Paths

Use absolute imports throughout the db package (no relative imports):
- Repository files: `from backend.db.base import BaseRepository`
- Repository files: `from backend.db.utils import uuid7_str`
- Database: `from backend.db.repos import ContentRepository, ...`
- Mixins: `from backend.db.base import ...`

## Files Summary

### New/Moved Files

| From | To |
|------|-----|
| `backend/server/db/__init__.py` | `backend/db/__init__.py` |
| `backend/server/db/database.py` | `backend/db/database.py` |
| `backend/server/db/base.py` | `backend/db/base.py` |
| `backend/server/db/*_repository.py` | `backend/db/repos/*.py` |
| `backend/server/db/mixins/*.py` | `backend/db/mixins/*.py` |
| `backend/server/db/migrations/` | `backend/db/migrations/` |
| `backend/worker/queue.py` | `backend/db/queue/task_queue.py` |
| (new) | `backend/db/utils.py` |
| (new) | `backend/db/README.md` |

### Files to Update (imports)

**Server:**
- `backend/server/api/app.py`
- `backend/server/api/dependencies.py`
- `backend/server/api/routes/tasks.py`
- `backend/server/api/routes/streaming.py`
- `backend/server/api/routes/workflow.py`
- `backend/server/api/routes/users.py`
- `backend/server/api/routes/content.py`
- `backend/server/engine/*.py`
- `backend/server/modules/**/*.py`

**Worker:**
- `backend/worker/__main__.py`
- `backend/worker/actors/media.py`
- `backend/worker/actors/base.py` (if imports db)

### Files to Delete

- `backend/server/db/` (entire directory)
- `backend/worker/queue.py`

## Testing Checklist

- [ ] Server starts without import errors
- [ ] Worker starts without import errors
- [ ] Server can enqueue tasks via TaskQueue
- [ ] Worker can claim and process tasks
- [ ] Worker can write content data (ContentRepository)
- [ ] Server can read content data
- [ ] User refresh during generation doesn't lose data
- [ ] Workflow execution works end-to-end
- [ ] All existing tests pass

## Migration Notes

This is a refactoring change with no database schema changes. The collections remain the same:
- `tasks` - TaskQueue data
- `content_generation_metadata` - Generation tracking
- `generated_content` - Content items
- All other collections unchanged

No data migration required.

## Decisions

1. **Utils**: `backend/db/` will have its own `utils.py` for shared utilities (like `uuid7_str`). This avoids db importing from server. Minor duplication is acceptable.

2. **Naming**: Use `backend/db/repos/` for repositories.

3. **Documentation**: Add `backend/db/README.md` documenting the shared package.

4. **Import style**: Use full paths throughout (e.g., `from backend.db.base import BaseRepository`), not relative imports. This is more resilient to future restructuring.
