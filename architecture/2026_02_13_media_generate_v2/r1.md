# media.generateV2

## Summary

Current CC flow splits image prompt generation and media generation into two
modules:

1. `api.llm` generates provider prompt payloads.
2. `media.generate` renders those prompts and executes media sub-actions.

This split creates a contract gap between modules. The editor and runtime must
coordinate schema and display layout across two modules, and users must update
both places to keep the flow valid.

`media.generateV2` combines prompt generation and media generation into one
interactive module with a single source of truth for:

- provider/action configuration
- prompt-output schema contract
- display schema contract
- retry and regeneration behavior

The goal is to remove cross-module drift and make configuration predictable in
both workflow JSON and editor UX.

## Design Decisions

### 1) Introduce additive module `media.generateV2`

We add a new module id (`media.generateV2`) instead of changing existing
`media.generate` behavior in place.

Reasons:

- keep existing workflows stable
- reduce migration risk
- allow side-by-side validation in real workflows

### 2) Prompt generation is internal to V2

V2 owns the LLM call phase and does not require a preceding `api.llm` module
for prompts.

<!--even thought v2 owns llm phase, it still has to follow all rules enforced
in api.llm module. we probably need to call it directly to make sure all
foundation rules are followed. this is where we need to dig more, how much of
api.llm calls would come here, and how we are going to invoke api.llm -->

V2 still reuses existing provider stack and mock behavior from `api.llm`
internals, but the orchestration boundary moves into one module.

### 3) Server controls output schema shape

User config can influence prompt templates, providers, and generation knobs,
but cannot arbitrarily redefine prompt output structure.

Server generates prompt schema from selected action/provider profile and uses
that schema for structured LLM output validation.

### 4) Display schema is generated, user-editable by override

V2 generates a default display schema from the same provider profile and
metadata conventions used by `media.generate` today.

Users can edit display schema in editor, but edits are constrained to display
concerns and cannot break required provider data contract.

### 5) Retry/regenerate stays inside one module

Retry options (`retry`, `continue`, `jump`) remain interaction-level concerns
inside V2. Regeneration no longer jumps to another module to regenerate prompts.

### 6) Mock preview remains first-class

V2 must support mock mode end-to-end:

- mock structured prompt output generation
- mock sub-action output (placeholder assets)
- same interaction shape as real mode

## Technical Specification

### Backend module

Add:

- `backend/workflow_engine/modules/media/generate_v2.py`

Module type:

- `InteractiveModule`

Execution stages:

1. Resolve V2 inputs (templates, selected providers, action type).
2. Build canonical prompt output schema for those providers.
3. Execute LLM stage for structured prompt payload.
4. Enrich prompt payload with provider metadata (`_provider_metadata`) and
   generation placeholders (`_generations`) using existing media logic.
5. Build interaction request with generated-or-overridden display schema.
6. Process response exactly like current `media.generate` for
   `selected_content*` and `generations` outputs.

Sub-actions:

- reuse current media task queue pathway for real mode
- reuse current mock placeholder generation in mock mode

### V2 input contract (proposed)

Required:

- `action_type`: `txt2img | img2vid | txt2audio`
- `providers`: ordered list of provider ids
- `prompt_config`: <!--note on following, make sure we use standard structure,
  with with notes below about per provider prompts.-->
  - `provider`: llm provider
  - `model`: optional model override
  - `system`: template(s)
  - `user`: template
  - `ai_config`: optional generation config

Optional:

- `title`
- `source_image` (for `img2vid`)
- `display_schema` (editor-authored override)
- `retryable`
- `sub_actions`

### V2 output contract

- `selected_content_id`
- `selected_content`
- `generations`
- `generated_prompts` (new, useful for audit/debug and downstream reuse)

### Prompt schema synthesis

V2 generates a strict schema per action type + providers. Example for
`txt2img`:

- top-level scene context fields (if configured)
- `prompts.<provider>.<required_fields>` for each provider
- required provider keys equal to selected provider set

This replaces fragile cross-module `$ref` coupling for prompt schema.

### Display schema synthesis

V2 generates default display schema from provider profiles, following current
patterns in `cc_image_prompts_display_schema.json`:

- `prompts` rendered as tabs
- provider tab `_ux` includes `render_as` + `input_schema`
- field-level `_ux` controls for source mapping and controls

If user provides `display_schema`, V2 applies safe merge rules:

- allow display labels, ordering, visibility, formatting
- allow input layout/editor hints
- reject mutations that remove required provider data paths

### Editor changes

Add a new editor node type:

- `ui/editor/src/modules/media/generateV2/*`

UI model:

- one module editor for action type, provider set, prompt templates,
  and display schema
- remove two-module mental model for new workflows
- keep runtime preview behavior from current embedded preview pattern

### Workflow authoring/migration

No immediate breaking migration.

Short term:

- new workflows use `media.generateV2`
- existing workflows continue with `api.llm + media.generate`

Later optional migration tooling:

- detect adjacent pair (`api.llm` -> `media.generate`) and convert to V2
  config when safe

## Database Schema

No required DB schema migration for V2 introduction.

Task queue, content metadata, and generation persistence remain unchanged.
V2 reuses current media generation persistence pathways.

## API Contracts

### Workflow module JSON

New module id:

- `module_id: "media.generateV2"`

Server module registry must map this id to new backend implementation.

### Runtime interaction payload

Interaction type remains media-generation oriented. Existing web UI renderer can
be reused if payload keeps current shape:

- `display_data.data`
- `display_data.schema`
- `display_data.sub_actions`
- `display_data.generations`
- `display_data.retryable`

### Mock mode

No contract change needed to virtual endpoints. V2 follows existing mock flag
behavior and must return same interaction shape in both modes.

## Cross-Module Impact

### Backend

- New module in media package.
- Possible shared helper extraction from `api.llm` and `media.generate` to
  avoid duplication.
- Workflow processor retry behavior updated for V2-local regeneration.

### Editor

- Add new module registration and node implementation.
- Keep existing `media.generate` node for backward compatibility.
- Update new-workflow templates/defaults to emit V2.

### Workflows

- CC and similar workflows can be simplified by replacing two-module chain
  with one V2 module in prompt/media step.

## Rollout Plan

1. Implement backend `media.generateV2` with parity behavior.
2. Add editor node for V2 (create/edit/preview).
3. Add one workflow pilot (CC image prompts step) using V2.
4. Validate mock mode, retry loop, and media sub-actions.
5. Decide migration strategy for legacy workflows.

## Questions for Review

1. Should V2 always expose `generated_prompts` in outputs, or only when
   debug/audit flag is enabled?

   <!--always expose, its users data, they can use it later if needed. user has
   to define state variable name as it does in all other places. -->

2. Do we want provider-specific prompt templates in config
   (e.g., per-provider user template), or a single template that returns
   full provider object?

   <!--I think its smart to have provider specific prompts and also have shared
   one. but user only get to add prompts based on selected providers, and we
   need to update data schema based on selections as well. we will also enforce
   that, user can have only 1 instance of given providers, no multiple
   instanced of same provider-->

3. For display-schema override safety, should invalid override fail execution,
   or should server log warning and fall back to generated default?

   <!--what i thought was, when user create thie module in ui, we will give
   standard display schema, but if they change and fail, its on them, at least
   at the moment.-->

4. Do we want `media.generateV2` to support non-LLM prompt sources in future
   (manual prompt input mode), or keep LLM prompt generation mandatory?

   <!--no, for now, lets have it tightly coupled with internal llm.-->
