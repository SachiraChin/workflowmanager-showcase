# Workflow Editor - Visual Node-Based Editor

## Summary

This document outlines the architecture for a visual node-based workflow editor
accessible at `/editor` in the webui. Users can create new workflows or edit
existing workflow versions from the `workflow_versions` collection. Each save
creates a new immutable version.

## Entry Points

1. **Header navigation** - "Create Workflow" button (to be added)
2. **Template selector** - "Edit" button next to each workflow version

## Key Decisions Needed

### 1. Node-Based Library Selection

Options for React-based node editors:

| Library | Pros | Cons |
|---------|------|------|
| **React Flow** | Most popular, excellent docs, MIT license, built-in minimap/controls, TypeScript native | Larger bundle (~150kb) |
| **Xyflow (React Flow v12)** | Same as above, newer version | Same as above |
| **Flume** | Simpler API, built-in node editor UI | Less flexible, smaller community |
| **rete.js** | Very flexible, framework agnostic | Steeper learning curve, older patterns |
| **Beautiful-react-diagrams** | Lightweight | Limited features, less maintained |

**Recommendation:** React Flow (or Xyflow) - industry standard, excellent 
TypeScript support, active maintenance, extensive examples.
<!--lets go with your reccomendation, i went to Xyflow website, it sent me to
React Flow, are these separate libs or not?-->

### 2. Editor Layout Structure

```
+------------------------------------------------------------------+
|  Header (breadcrumb, save, version info)                         |
+------------------------------------------------------------------+
|        |                                      |                  |
|  Step  |                                      |    Properties    |
|  List  |         Canvas (React Flow)          |      Panel       |
|        |                                      |                  |
| (left) |         (center, main area)          |     (right)      |
|        |                                      |                  |
+------------------------------------------------------------------+
```

- **Left panel**: Step list/tree - shows all steps, click to focus on canvas
- **Center canvas**: Visual node editor where modules are placed and connected
- **Right panel**: Properties/config panel for selected node (step or module)

**Questions for operator:**
- Should steps be visualized as containers holding module nodes?
- Or should steps be separate from the module canvas (e.g., step tabs)?

<!-- #1 to reduce confusion, and also to show connectivity between steps -->

### 3. Node Hierarchy: Steps vs Modules

The workflow structure is: `Workflow -> Steps -> Modules`

**Option A: Two-level canvas**
- Steps shown as large container nodes (groups)
- Modules shown as nodes inside step containers
- Connections between modules cross step boundaries

**Option B: Step-scoped canvas**
- Left panel shows step list
- Canvas shows modules for selected step only
- Step-to-step connections shown separately (or inferred from state flow)

**Option C: Flat canvas with step grouping**
- All modules on one canvas
- Steps are visual groupings/colors/regions
- User can collapse/expand step groups

**Questions for operator:**
- Which visualization approach fits your mental model? <!-- C -->
- How important is seeing the entire workflow (all steps) at once?
<!-- its not very high in the list, but i guess if its better to zoom out 
and see whole picture -->

### 4. Connection Model

Workflows use state-based data flow:
- Modules read from `state` via Jinja2 templates in `inputs`
- Modules write to `state` via `outputs_to_state` mapping

**Option A: Explicit connection lines**
- User drags connections between module output ports and input ports
- System generates the Jinja2 template and outputs_to_state automatically

**Option B: State-based (implicit) connections**
- Show which state keys a module reads/writes
- Connections rendered automatically based on state dependencies
- User configures inputs via forms, system infers connections

**Option C: Hybrid**
- Visual connections for explicit dependencies
- State panel shows full state flow
- User can connect visually OR configure via state references

**Questions for operator:**
- Should connections be explicit (user draws them) or inferred from state? <!-- C -->
- How do we handle Jinja2 template complexity in visual form?
<!-- current plan is to take advantage of ai tools to generate any complex
tooling, if possible, I wan to be able to create modules themselves using ai,
but for now, we will dont touch jinja2 templates -->

### 5. Module Configuration

When a module node is selected, the right panel shows its configuration.

Module inputs vary by `module_id`:
- `api.llm`: model, system_prompt, user_prompt, schema, etc.
- `user.select`: data, prompt, display template, etc.
- `transform.query`: data, query expression, etc.

**Questions for operator:**
- Should we build custom form renderers for each module type?
- Or use a generic JSON editor with schema validation?
- Or a hybrid (known modules get custom UI, unknown get JSON)?
<!-- #3 -->

### 6. Preview Functionality

**What should preview show?**
- Static preview: How the step/module UI will look to end users
- Runtime preview: Execute with sample data to see actual output

**Questions for operator:**
- What level of preview do you want in v1?
<!-- basic preview. we will define examples for each structure and render is
using current rendering engine in webui -->

- Should preview be live (updates as you type) or on-demand?
<!-- not for v1 -->

### 7. Saving and Versioning

Since versions are immutable:
1. User edits workflow in editor (local state)
2. User clicks "Save" 
3. System creates new `workflow_version` with new `content_hash`
4. New version linked to same `workflow_template_id`

**Questions for operator:**
- Should there be auto-save to localStorage (crash recovery)? <!-- yes -->
- Should we show diff between current edits and last saved version? <!-- not in v1 -->
- Version naming/tagging - just auto-increment or user-provided labels? <!-- for v1, we will save versions same way we save versions now. -->

### 8. New Workflow Creation

When creating from scratch:
1. User clicks "Create Workflow" in header
2. Editor opens with empty canvas
3. User adds steps, then modules within steps
4. First save creates new `workflow_template` + first `workflow_version`

**Questions for operator:**
- Should there be workflow templates/presets to start from? <!-- not in v1 -->
- Required fields for new workflow: just name, or more metadata? 
<!-- we will give user module templates and in some case step templates, but
all these will be simplaer in v1 -->

---

## Technical Considerations

### State Management

Editor state is complex:
- Workflow definition (steps, modules, connections)
- UI state (selected node, panel sizes, zoom level)
- Dirty state (unsaved changes)

Options:
- Extend existing Zustand store
- Separate Zustand store for editor
- React Flow's built-in state + Zustand for metadata

<!--this is something I want to discuss, I want to use curent workflow engine
to show preview, but in the same time, current webui is so complex, I dont want
to put editor inside it. I want to discuss possibilities of making editor a
separte application but still have access to ui rendering engine in webui-->

### File Structure (Proposed)

```
ui/webui/src/
  features/
    editor/
      components/
        EditorCanvas.tsx
        StepPanel.tsx
        PropertiesPanel.tsx
        nodes/
          StepNode.tsx
          ModuleNode.tsx
        edges/
          ConnectionEdge.tsx
      hooks/
        useEditorState.ts
        useWorkflowSave.ts
      types/
        editor.types.ts
      utils/
        workflowToNodes.ts
        nodesToWorkflow.ts
      EditorPage.tsx
  pages/
    WorkflowEditorPage.tsx  (route wrapper)
```

### API Endpoints Needed

| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/workflow-version/{id}` | GET | Load version for editing |
| `/workflow-version` | POST | Save new version |
| `/workflow-template` | POST | Create new template |
| `/module-registry` | GET | List available module types |

**Questions for operator:**
- Do these endpoints exist or need to be created?
- Is there a module registry/catalog we can query?

---

## Open Questions Summary

1. **Library**: Confirm React Flow is acceptable choice?
2. **Step visualization**: Containers on canvas vs step-scoped view vs flat?
3. **Connections**: Explicit drawing vs state-inferred vs hybrid?
4. **Module config**: Custom forms vs JSON editor vs hybrid?
5. **Preview scope**: Static mockup vs runtime execution?
6. **Auto-save**: localStorage crash recovery needed?
7. **Version labels**: Auto-increment vs user-provided?
8. **New workflow**: Templates/presets available?
9. **Module registry**: Does it exist? Where?

---

## Next Steps (After Decisions)

1. Set up React Flow with basic canvas
2. Implement node types for steps and modules
3. Build properties panel with module configuration
4. Implement save/load with workflow_versions API
5. Add navigation entry points (header + template selector)
6. Build preview functionality
