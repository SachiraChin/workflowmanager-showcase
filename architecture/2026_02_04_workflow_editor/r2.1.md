# Shared Package Migration Plan (r2.1)

## Overview

Extract reusable rendering components from `ui/webui` into `ui/shared` package.
Both `webui` and the new `editor` app will import from `@wfm/shared`.

## Phase 1: Workspace Setup

### 1.1 Create Root package.json

Create `ui/package.json`:

```json
{
  "name": "workflow-manager-ui",
  "private": true,
  "workspaces": ["shared", "webui", "editor"]
}
```

### 1.2 Create Shared Package Structure

```
ui/shared/
  package.json
  tsconfig.json
  vite.config.ts
  src/
    index.ts
```

`ui/shared/package.json`:
```json
{
  "name": "@wfm/shared",
  "version": "0.0.1",
  "type": "module",
  "main": "./src/index.ts",
  "types": "./src/index.ts",
  "exports": {
    ".": "./src/index.ts",
    "./components/*": "./src/components/*",
    "./utils": "./src/utils/index.ts"
  },
  "peerDependencies": {
    "react": "^19.0.0",
    "react-dom": "^19.0.0"
  },
  "dependencies": {
    "@radix-ui/react-accordion": "^1.2.12",
    "@radix-ui/react-checkbox": "^1.3.3",
    "@radix-ui/react-collapsible": "^1.1.12",
    "@radix-ui/react-dialog": "^1.1.15",
    "@radix-ui/react-dropdown-menu": "^2.1.16",
    "@radix-ui/react-label": "^2.1.8",
    "@radix-ui/react-popover": "^1.1.15",
    "@radix-ui/react-progress": "^1.1.8",
    "@radix-ui/react-radio-group": "^1.3.8",
    "@radix-ui/react-scroll-area": "^1.2.10",
    "@radix-ui/react-select": "^2.2.6",
    "@radix-ui/react-separator": "^1.1.8",
    "@radix-ui/react-slider": "^1.3.6",
    "@radix-ui/react-slot": "^1.2.4",
    "@radix-ui/react-switch": "^1.2.6",
    "@radix-ui/react-tabs": "^1.1.13",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "lucide-react": "^0.562.0",
    "nunjucks": "^3.2.4",
    "tailwind-merge": "^3.4.0"
  },
  "devDependencies": {
    "@types/nunjucks": "^3.2.6",
    "@types/react": "^19.2.5",
    "typescript": "~5.9.3"
  }
}
```

### 1.3 Update webui package.json

Add dependency on shared:

```json
{
  "dependencies": {
    "@wfm/shared": "workspace:*",
    // ... rest unchanged, but remove duplicated deps now in shared
  }
}
```

Remove from webui dependencies (now in shared):
- All `@radix-ui/*` packages
- `class-variance-authority`
- `clsx`
- `lucide-react`
- `nunjucks`
- `tailwind-merge`

---

## Phase 2: File Migration

### 2.1 Types (Move)

| Source | Destination | Action |
|--------|-------------|--------|
| `webui/src/core/types.ts` | `shared/src/types/index.ts` | Move |
| `webui/src/interactions/types.ts` | `shared/src/types/interactions.ts` | Move |
| `webui/src/interactions/schema/types.ts` | `shared/src/types/schema.ts` | Move |
| `webui/src/interactions/layouts/types.ts` | `shared/src/types/layouts.ts` | Move |

### 2.2 Utils (Move)

| Source | Destination | Action |
|--------|-------------|--------|
| `webui/src/core/utils.ts` | `shared/src/utils/cn.ts` | Move |
| `webui/src/lib/template-service.ts` | `shared/src/utils/template-service.ts` | Move |
| `webui/src/interactions/schema/ux-utils.ts` | `shared/src/utils/ux-utils.ts` | Move |
| `webui/src/interactions/schema/schema-utils.ts` | `shared/src/utils/schema-utils.ts` | Move |
| `webui/src/interactions/layouts/utils.ts` | `shared/src/utils/layout-utils.ts` | Move |

### 2.3 UI Components (Move)

Move entire `components/ui/` folder:

| Source | Destination |
|--------|-------------|
| `webui/src/components/ui/*` | `shared/src/components/ui/*` |

Files to move (22 files):
- accordion.tsx
- alert.tsx
- badge.tsx
- button.tsx
- card.tsx
- checkbox.tsx
- collapsible.tsx
- dialog.tsx
- dropdown-menu.tsx
- input.tsx
- json-editor-dialog.tsx
- json-tree-view.tsx
- label.tsx
- magnetic-scroll-container.tsx
- popover.tsx
- progress.tsx
- radio-group.tsx
- scroll-area.tsx
- select.tsx
- separator.tsx
- skeleton.tsx
- slider.tsx
- switch.tsx
- table.tsx
- tabs.tsx
- textarea.tsx

Also move:
| Source | Destination |
|--------|-------------|
| `webui/src/components/theme-provider.tsx` | `shared/src/components/theme-provider.tsx` |

### 2.4 Renderers (Move)

| Source | Destination |
|--------|-------------|
| `webui/src/interactions/renderers/*` | `shared/src/renderers/*` |

Files (14 files):
- index.ts
- TextRenderer.tsx
- ColorRenderer.tsx
- UrlRenderer.tsx
- DateTimeRenderer.tsx
- NumberRenderer.tsx
- ImageRenderer.tsx
- ErrorRenderer.tsx
- SelectInputRenderer.tsx
- SliderInputRenderer.tsx
- TextareaInputRenderer.tsx
- NumberInputRenderer.tsx
- CheckboxInputRenderer.tsx
- TagInputRenderer.tsx
- AlternativeInputWrapper.tsx
- DecoratorBadges.tsx
- nudges/index.ts
- nudges/CopyButton.tsx
- nudges/ColorSwatch.tsx
- nudges/ExternalLink.tsx

### 2.5 Layouts (Move)

| Source | Destination |
|--------|-------------|
| `webui/src/interactions/layouts/*` | `shared/src/layouts/*` |

Files (8 files):
- index.ts
- registry.tsx
- DefaultLayout.tsx
- CardLayout.tsx
- CardStackLayout.tsx
- SectionLayout.tsx
- SectionListLayout.tsx
- TabsLayout.tsx

### 2.6 Schema Core (Move)

| Source | Destination |
|--------|-------------|
| `webui/src/interactions/schema/index.ts` | `shared/src/schema/index.ts` |
| `webui/src/interactions/schema/selection/*` | `shared/src/schema/selection/*` |
| `webui/src/interactions/schema/input/*` | `shared/src/schema/input/*` |
| `webui/src/interactions/schema/tabs/*` | `shared/src/schema/tabs/*` |
| `webui/src/interactions/schema/ObjectSchemaRenderer.tsx` | `shared/src/schema/ObjectSchemaRenderer.tsx` |
| `webui/src/interactions/schema/ArraySchemaRenderer.tsx` | `shared/src/schema/ArraySchemaRenderer.tsx` |
| `webui/src/interactions/schema/TableSchemaRenderer.tsx` | `shared/src/schema/TableSchemaRenderer.tsx` |
| `webui/src/interactions/schema/ContentPanelSchemaRenderer.tsx` | `shared/src/schema/ContentPanelSchemaRenderer.tsx` |

---

## Phase 3: Import Updates

### 3.1 Shared Package Exports

Create `shared/src/index.ts`:

```typescript
// Types
export * from './types';
export * from './types/interactions';
export * from './types/schema';
export * from './types/layouts';

// Utils
export { cn } from './utils/cn';
export { renderTemplate } from './utils/template-service';
export * from './utils/ux-utils';
export * from './utils/schema-utils';
export * from './utils/layout-utils';

// Components
export * from './components/ui/button';
export * from './components/ui/card';
// ... all UI components

// Renderers
export * from './renderers';

// Layouts
export * from './layouts';

// Schema
export * from './schema';
```

### 3.2 Update webui Imports

Replace all imports from moved files:

| Old Import | New Import |
|------------|------------|
| `@/core/types` | `@wfm/shared` |
| `@/core/utils` | `@wfm/shared` |
| `@/lib/template-service` | `@wfm/shared` |
| `@/components/ui/*` | `@wfm/shared/components/ui/*` or `@wfm/shared` |
| `@/interactions/renderers/*` | `@wfm/shared` |
| `@/interactions/layouts/*` | `@wfm/shared` |
| `@/interactions/schema/*` | `@wfm/shared` |

### 3.3 Files Requiring Import Updates in webui

These files import from moved locations and need updates:

**State files:**
- `state/workflow-store.ts`
- `state/interaction-context.tsx`
- `state/validation-context.tsx`
- `state/sub-action-context.tsx`
- `state/WorkflowStateContext.tsx`
- `state/interaction-state.ts`
- `state/hooks/useDebugMode.ts`
- `state/hooks/useWorkflowState.ts`
- `state/hooks/useWorkflowExecution.ts`

**Interaction files (staying in webui):**
- `interactions/InteractionHost.tsx`
- `interactions/index.ts`

<!--you cant render modules with all below. those are simply entry points to
render everything. what you mentioned importing ealier simply are end nodes
which doesnt have any value as is. actual rendering is controlled by components
below. in a way, they themselves are modules. the SchemaRenderer is simply
access point to everything, if you want to render anything, you render
SchemaRenderer, it will route everything. I feel like this will be hard to
migrate as well as they probably have state access throughout them. please come
up with solution to how to handle shared state.-->

- `interactions/InputRenderer.tsx`
- `interactions/TerminalRenderer.tsx`
- `interactions/SchemaRenderer.tsx`
- `interactions/SchemaInteractionHost.tsx`
- `interactions/types/text-input/*`
- `interactions/types/file-input/*`
- `interactions/types/file-download/*`
- `interactions/types/structured-select/*`
- `interactions/types/review-grouped/*`
- `interactions/types/form-input/*`
- `interactions/types/media-generation/*`

<!-- end of last statement -->

**Feature files:**
- All files in `features/*`

**Page files:**
- All files in `pages/*`

**Other:**
- `App.tsx`
- `components/layout/header.tsx`
- `components/layout/theme-toggle.tsx`
- `components/AccessDeniedView.tsx`
- `lib/capabilities.ts`
- `lib/interaction-utils.ts`
- `core/api.ts`
- `core/config.ts`
- `core/validation.ts`

---

## Phase 4: Configuration

### 4.1 Shared tsconfig.json

```json
{
  "compilerOptions": {
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "isolatedModules": true,
    "moduleDetection": "force",
    "noEmit": true,
    "jsx": "react-jsx",
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true,
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"]
    }
  },
  "include": ["src"]
}
```

### 4.2 Shared vite.config.ts

```typescript
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import path from 'path'

export default defineConfig({
  plugins: [react()],
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
    },
  },
  build: {
    lib: {
      entry: path.resolve(__dirname, 'src/index.ts'),
      name: 'WfmShared',
      formats: ['es'],
    },
    rollupOptions: {
      external: ['react', 'react-dom'],
    },
  },
})
```

### 4.3 Tailwind Configuration

Shared package needs Tailwind config. Options:

**Option A: Shared CSS file**
- Shared exports base styles
- Consumers import and extend

**Option B: Tailwind preset**
- Shared exports Tailwind preset
- Consumers use preset in their config

**Recommendation:** Option A for simplicity. Shared has its own `index.css` 
with Tailwind directives, consumers import it.
<!--agreed to reccommendation -->

### 4.4 Update webui vite.config.ts

Add alias for shared package (for dev mode):

```typescript
resolve: {
  alias: {
    '@': path.resolve(__dirname, './src'),
    '@wfm/shared': path.resolve(__dirname, '../shared/src'),
  },
},
```

---

## Phase 5: Verification

### 5.1 Build Shared

```bash
cd ui/shared
npm run build  # or just tsc for type checking
```

### 5.2 Build webui

```bash
cd ui/webui
npm run build
```

### 5.3 Test webui

```bash
cd ui/webui
npm run dev
# Manually test that rendering still works
```

---

## Migration Order (Recommended)

Execute in this order to minimize breakage:

1. **Create workspace structure** (Phase 1)
   - Root package.json
   - Shared package skeleton
   - Run `npm install` from ui/ root

2. **Move types first** (Phase 2.1)
   - These have no dependencies on other moved files
   - Update imports immediately after each move

3. **Move utils** (Phase 2.2)
   - Depends only on types
   - Update imports

4. **Move UI components** (Phase 2.3)
   - Depends on utils (cn)
   - Update imports

5. **Move renderers** (Phase 2.4)
   - Depends on types, utils, UI components
   - Update imports

6. **Move layouts** (Phase 2.5)
   - Depends on types, utils, UI components
   - Update imports

7. **Move schema core** (Phase 2.6)
   - Depends on all above
   - Update imports

8. **Final verification** (Phase 5)

---

## Files Summary

### Moving to shared (total ~60 files)

- Types: 4 files
- Utils: 5 files
- UI Components: 27 files
- Renderers: 17 files
- Layouts: 8 files
- Schema: ~12 files

### Staying in webui

- State: 9 files
- Interaction orchestration: 6 files
- Interaction types: ~20 files
- Features: ~15 files
- Pages: 3 files
- Other: ~10 files

---

## Questions Before Proceeding

1. Should we do this migration now before building the editor, or build editor
   first with Option D and migrate later?
<!--we will do the migration first-->

2. For Tailwind, prefer Option A (shared CSS) or Option B (preset)?
<!--answered above-->

3. Any files I should NOT move that you want to keep webui-only?
<!--added comment inline above-->
