<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schema-Driven UI Architecture - Complete Data Flow</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: #1a1a2e;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }
        h1, h2, h3, h4 { color: #00d4ff; margin-top: 1.5em; }
        h1 { border-bottom: 2px solid #00d4ff; padding-bottom: 10px; }

        .container { max-width: 1400px; margin: 0 auto; }

        /* Flow diagram styles */
        .flow-section {
            background: #16213e;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .flow-row {
            display: flex;
            gap: 20px;
            align-items: stretch;
            margin: 15px 0;
        }

        .flow-box {
            background: #1f4068;
            border: 2px solid #00d4ff;
            border-radius: 8px;
            padding: 15px;
            flex: 1;
            min-width: 200px;
        }

        .flow-box.server { border-color: #ff6b6b; }
        .flow-box.server h4 { color: #ff6b6b; }

        .flow-box.webui { border-color: #4ade80; }
        .flow-box.webui h4 { color: #4ade80; }

        .flow-box.workflow { border-color: #fbbf24; }
        .flow-box.workflow h4 { color: #fbbf24; }

        .arrow {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #666;
            min-width: 40px;
        }

        /* Code blocks */
        pre {
            background: #0f0f23;
            border-radius: 6px;
            padding: 12px;
            overflow-x: auto;
            font-size: 12px;
            border: 1px solid #333;
        }

        code {
            font-family: 'Fira Code', 'Consolas', monospace;
            color: #a0e0a0;
        }

        .highlight { color: #ffcc00; }
        .keyword { color: #ff79c6; }
        .string { color: #50fa7b; }
        .comment { color: #6272a4; }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 14px;
        }

        th, td {
            border: 1px solid #333;
            padding: 10px;
            text-align: left;
        }

        th {
            background: #1f4068;
            color: #00d4ff;
        }

        tr:nth-child(even) { background: #16213e; }

        /* Tree structure */
        .tree {
            font-family: 'Fira Code', monospace;
            font-size: 13px;
            background: #0f0f23;
            padding: 15px;
            border-radius: 6px;
            white-space: pre;
            overflow-x: auto;
        }

        .tree .file { color: #fbbf24; }
        .tree .component { color: #4ade80; }
        .tree .function { color: #ff79c6; }
        .tree .note { color: #6272a4; font-style: italic; }

        /* Naming clarification */
        .naming-table {
            margin: 20px 0;
        }

        .naming-table td:first-child {
            font-family: monospace;
            color: #ff79c6;
            white-space: nowrap;
        }

        .toc {
            background: #16213e;
            padding: 15px 25px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .toc ul { margin: 0; padding-left: 20px; }
        .toc a { color: #00d4ff; text-decoration: none; }
        .toc a:hover { text-decoration: underline; }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 5px;
        }
        .badge.server { background: #ff6b6b; color: #000; }
        .badge.webui { background: #4ade80; color: #000; }
        .badge.workflow { background: #fbbf24; color: #000; }

        /* Line numbers gutter */
        .container {
            position: relative;
            padding-left: 50px;
        }

        .line-numbers {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 45px;
            background: #0f0f1a;
            border-right: 1px solid #333;
            padding-top: 20px;
            font-family: 'Fira Code', monospace;
            font-size: 11px;
            color: #555;
            text-align: right;
            padding-right: 8px;
            overflow-y: auto;
            z-index: 100;
        }

        .line-numbers div {
            height: 21px;
            line-height: 21px;
        }

        .line-numbers div:hover {
            color: #00d4ff;
            cursor: pointer;
        }

        /* Highlight line on hover */
        .line-wrapper {
            display: block;
            min-height: 21px;
        }

        .line-wrapper:hover {
            background: rgba(0, 212, 255, 0.05);
        }

        .line-wrapper:target {
            background: rgba(255, 204, 0, 0.15);
        }
    </style>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const container = document.querySelector('.container');

            // Create line numbers gutter
            const gutter = document.createElement('div');
            gutter.className = 'line-numbers';
            document.body.insertBefore(gutter, document.body.firstChild);

            // Get all block-level content and wrap in line-wrapper
            let lineNum = 1;
            const elements = container.querySelectorAll('h1, h2, h3, h4, p, li, tr, pre, .tree, .flow-box, .arrow, table, hr');

            elements.forEach(function(el) {
                // Add line number to gutter
                const lineDiv = document.createElement('div');
                lineDiv.textContent = lineNum;
                lineDiv.id = 'L' + lineNum;
                lineDiv.onclick = function() {
                    window.location.hash = 'line-' + lineNum;
                };
                gutter.appendChild(lineDiv);

                // Add id to element for linking
                if (!el.id) {
                    el.id = 'line-' + lineNum;
                }
                el.setAttribute('data-line', lineNum);

                lineNum++;

                // For pre/tree blocks, count internal lines
                if (el.tagName === 'PRE' || el.classList.contains('tree')) {
                    const lines = el.textContent.split('\n').length - 1;
                    for (let i = 0; i < lines; i++) {
                        const extraLine = document.createElement('div');
                        extraLine.textContent = lineNum + i;
                        gutter.appendChild(extraLine);
                    }
                    lineNum += lines;
                }
            });

            // Sync scroll
            window.addEventListener('scroll', function() {
                gutter.scrollTop = window.scrollY;
            });
        });
    </script>
</head>
<body>
    <div class="container">
        <h1>Schema-Driven UI Architecture</h1>
        <p>Complete data flow from workflow JSON â†’ server modules â†’ webui components</p>

        <div class="toc">
            <h3 style="margin-top:0">Contents</h3>
            <ul>
                <li><a href="#end-to-end">End-to-End Transformation (Workflow â†’ Server â†’ WebUI)</a></li>
                <li><a href="#interaction-types">All Interaction Types</a></li>
                <li><a href="#full-flow">Complete Data Flow</a></li>
                <li><a href="#module-mapping">Workflow Module â†’ Interaction Type Mapping</a></li>
                <li><a href="#component-hierarchy">WebUI Component Hierarchy (All Components)</a></li>
                <li><a href="#parse-schema-data">Deep Dive: parseSchemaData (groups vs flatItems)</a></li>
                <li><a href="#revised-architecture">Revised Architecture (from Discussion)</a></li>
                <li><a href="#summary">Summary: What Needs to Change</a></li>
            </ul>
            <p style="font-size:12px;color:#666;margin-top:10px;">Line numbers shown on left. Click to jump, or reference as L1, L50, etc.</p>
        </div>

        <!-- ============================================= -->
        <h2 id="end-to-end">End-to-End Transformation</h2>
        <!-- ============================================= -->

        <div class="flow-section">
            <p>This section shows exactly what transforms at each stage from workflow JSON to rendered component.</p>

            <h3>Stage 1: Workflow JSON (Static Definition)</h3>
            <div class="flow-box workflow" style="max-width: 100%;">
                <h4>ğŸ“„ What you write in step.json</h4>
<pre><code>{
  <span class="highlight">"module_id"</span>: <span class="string">"user.select"</span>,         <span class="comment">// â† Determines which Python class to load</span>
  <span class="string">"name"</span>: <span class="string">"review_elevenlabs"</span>,
  <span class="string">"inputs"</span>: {
    <span class="highlight">"mode"</span>: <span class="string">"review"</span>,                  <span class="comment">// â† KEY: This determines InteractionType</span>
    <span class="highlight">"data"</span>: <span class="string">"{{ state.elevenlabs_prompts_response }}"</span>,  <span class="comment">// â† Jinja2 template</span>
    <span class="highlight">"schema"</span>: {                         <span class="comment">// â† Passed through to webui</span>
      <span class="string">"type"</span>: <span class="string">"object"</span>,
      <span class="string">"display_mode"</span>: <span class="string">"review"</span>,
      <span class="string">"properties"</span>: {
        <span class="string">"track_title"</span>: { <span class="string">"type"</span>: <span class="string">"string"</span>, <span class="string">"display"</span>: <span class="keyword">true</span>, <span class="string">"display_label"</span>: <span class="string">"Track Title"</span> }
      }
    },
    <span class="string">"prompt"</span>: <span class="string">"Review ElevenLabs prompts"</span>
  }
}</code></pre>
                <p style="margin-top:10px;color:#fbbf24;"><strong>Key fields that matter:</strong></p>
                <ul style="color:#e0e0e0;">
                    <li><code>module_id</code> â†’ Which Python module class to instantiate</li>
                    <li><code>inputs.mode</code> â†’ Determines InteractionType (for user.select)</li>
                    <li><code>inputs.data</code> â†’ Jinja2 template, resolved by server</li>
                    <li><code>inputs.schema</code> â†’ Passed through to webui unchanged</li>
                </ul>
            </div>

            <div class="arrow" style="font-size:32px;margin:20px 0;">â¬‡ï¸</div>

            <h3>Stage 2: Server Transformations</h3>
            <div class="flow-box server" style="max-width: 100%;">
                <h4>ğŸ What server does (workflow_processor.py + module)</h4>

                <p><strong>Step 2a: Load module class</strong></p>
<pre><code><span class="comment"># workflow_processor.py loads module by module_id</span>
module = ModuleRegistry.create(<span class="string">"user.select"</span>)  <span class="comment">â†’ SelectModule instance</span></code></pre>

                <p><strong>Step 2b: Resolve Jinja2 templates in inputs</strong></p>
<pre><code><span class="comment"># Jinja2Resolver replaces templates with actual values from state</span>
inputs[<span class="string">"data"</span>] = <span class="string">"{{ state.elevenlabs_prompts_response }}"</span>
        â¬‡ï¸ <span class="comment">resolved to</span>
inputs[<span class="string">"data"</span>] = {
  <span class="string">"track_title"</span>: <span class="string">"Starwell Reverie"</span>,
  <span class="string">"elevenlabs_prompt_precise"</span>: <span class="string">"Delicate nostalgic..."</span>
}</code></pre>

                <p><strong>Step 2c: Module creates InteractionRequest</strong></p>
<pre><code><span class="comment"># server/modules/user/select.py:172-195</span>
<span class="keyword">def</span> <span class="function">get_interaction_request</span>(self, inputs, context):
    mode = inputs.get(<span class="string">'mode'</span>)   <span class="comment"># "review"</span>

    <span class="comment"># THIS IS THE KEY TRANSFORMATION:</span>
    <span class="keyword">if</span> mode == <span class="string">"review"</span>:
        interaction_type = <span class="highlight">InteractionType.REVIEW_GROUPED</span>
    <span class="keyword">else</span>:
        interaction_type = <span class="highlight">InteractionType.SELECT_FROM_STRUCTURED</span>

    <span class="keyword">return</span> InteractionRequest(
        <span class="highlight">interaction_type</span>=interaction_type,  <span class="comment"># â† Created here, not in workflow JSON!</span>
        interaction_id=<span class="string">"select_12345"</span>,
        prompt=inputs[<span class="string">"prompt"</span>],
        <span class="highlight">display_data</span>={                       <span class="comment"># â† Bundled for webui</span>
            <span class="string">"data"</span>: inputs[<span class="string">"data"</span>],          <span class="comment"># Resolved values</span>
            <span class="string">"schema"</span>: inputs[<span class="string">"schema"</span>],      <span class="comment"># Passed through</span>
            <span class="string">"mode"</span>: mode,
            <span class="string">"retryable"</span>: context.retryable
        }
    )</code></pre>

                <p style="margin-top:10px;color:#ff6b6b;"><strong>Server transformations:</strong></p>
                <ul style="color:#e0e0e0;">
                    <li><code>module_id</code> â†’ Python class instance</li>
                    <li><code>inputs.data</code> (Jinja2) â†’ resolved actual values</li>
                    <li><code>inputs.mode</code> â†’ <code>interaction_type</code> enum</li>
                    <li>Everything bundled into <code>InteractionRequest</code> object</li>
                </ul>
            </div>

            <div class="arrow" style="font-size:32px;margin:20px 0;">â¬‡ï¸</div>

            <h3>Stage 3: API Response (JSON over HTTP)</h3>
            <div class="flow-box" style="max-width: 100%; border-color: #a78bfa;">
                <h4 style="color:#a78bfa;">ğŸ“¡ What API sends to WebUI</h4>
<pre><code>{
  <span class="string">"workflow_run_id"</span>: <span class="string">"abc123"</span>,
  <span class="string">"status"</span>: <span class="string">"awaiting_input"</span>,
  <span class="string">"interaction_request"</span>: {
    <span class="highlight">"interaction_type"</span>: <span class="string">"review_grouped"</span>,   <span class="comment">// â† Routes to component</span>
    <span class="string">"interaction_id"</span>: <span class="string">"select_12345"</span>,
    <span class="string">"prompt"</span>: <span class="string">"Review ElevenLabs prompts"</span>,
    <span class="highlight">"display_data"</span>: {
      <span class="string">"data"</span>: {                              <span class="comment">// â† Resolved values</span>
        <span class="string">"track_title"</span>: <span class="string">"Starwell Reverie"</span>,
        <span class="string">"elevenlabs_prompt_precise"</span>: <span class="string">"Delicate nostalgic..."</span>
      },
      <span class="string">"schema"</span>: {                            <span class="comment">// â† Unchanged from workflow</span>
        <span class="string">"type"</span>: <span class="string">"object"</span>,
        <span class="string">"display_mode"</span>: <span class="string">"review"</span>,
        <span class="string">"properties"</span>: {
          <span class="string">"track_title"</span>: { <span class="string">"type"</span>: <span class="string">"string"</span>, <span class="string">"display"</span>: <span class="keyword">true</span>, ... }
        }
      },
      <span class="string">"mode"</span>: <span class="string">"review"</span>,
      <span class="string">"retryable"</span>: { ... }
    }
  }
}</code></pre>
            </div>

            <div class="arrow" style="font-size:32px;margin:20px 0;">â¬‡ï¸</div>

            <h3>Stage 4: WebUI Component Routing</h3>
            <div class="flow-box webui" style="max-width: 100%;">
                <h4>âš›ï¸ InteractionHost routes by interaction_type</h4>
<pre><code><span class="comment">// InteractionHost.tsx:1704-1787</span>
<span class="keyword">function</span> <span class="function">InteractionHost</span>({ request }) {
  <span class="keyword">switch</span> (request.<span class="highlight">interaction_type</span>) {       <span class="comment">// â† Uses the enum value</span>
    <span class="keyword">case</span> <span class="string">"review_grouped"</span>:
      <span class="keyword">return</span> &lt;<span class="component">ReviewGroupedHost</span> request={request} /&gt;;
      <span class="comment">//       â†“</span>
      <span class="comment">//  ReviewGroupedHost reads request.display_data.schema</span>
      <span class="comment">//  and request.display_data.data to render</span>
  }
}</code></pre>

                <p><strong>Component receives:</strong></p>
<pre><code>request = {
  interaction_type: <span class="string">"review_grouped"</span>,
  display_data: {
    data: { track_title: <span class="string">"Starwell Reverie"</span>, ... },
    schema: { type: <span class="string">"object"</span>, properties: { ... } }
  }
}</code></pre>
            </div>

            <h3 style="margin-top: 30px;">Complete Hierarchy: All Workflow Modules â†’ All WebUI Components</h3>
            <div class="tree">
<span class="file">step.json</span> (any workflow step)
â”‚
â””â”€â”€ <span class="highlight">module_id</span> â†’ <span class="note">[SERVER: ModuleRegistry]</span> â†’ <span class="note">[MODULE: get_interaction_request()]</span> â†’ <span class="note">[API]</span> â†’ <span class="note">[WEBUI: InteractionHost]</span>
    â”‚
    â”‚
    â”œâ”€â”€ <span class="highlight">"user.select"</span>
    â”‚   â”‚
    â”‚   â””â”€â”€ <span class="note">[SERVER: server/modules/user/select.py]</span>
    â”‚       â”‚
    â”‚       â”œâ”€â”€ inputs.mode == "select" (default)
    â”‚       â”‚   â”‚
    â”‚       â”‚   â””â”€â”€ interaction_type = <span class="highlight">SELECT_FROM_STRUCTURED</span>
    â”‚       â”‚       â”‚
    â”‚       â”‚       â””â”€â”€ <span class="note">[WEBUI: InteractionHost.tsx:1704 switch]</span>
    â”‚       â”‚           â”‚
    â”‚       â”‚           â””â”€â”€ <span class="component">StructuredSelectHost</span> <span class="note">(line 852)</span>
    â”‚       â”‚               â”œâ”€â”€ State: StructuredSelectState
    â”‚       â”‚               â”œâ”€â”€ Variants: [cards, list]
    â”‚       â”‚               â”‚
    â”‚       â”‚               â”œâ”€â”€ <span class="component">StructuredSelectCardsControlled</span>
    â”‚       â”‚               â”‚   â”œâ”€â”€ Props: request, state, onStateChange
    â”‚       â”‚               â”‚   â”œâ”€â”€ <span class="function">parseSchemaData(data, schema)</span> <span class="note">â† schema-utils.ts:63</span>
    â”‚       â”‚               â”‚   â”‚   â””â”€â”€ Returns: { groups: SelectableGroup[], flatItems: SelectableItem[] }
    â”‚       â”‚               â”‚   â”‚
    â”‚       â”‚               â”‚   â””â”€â”€ For each group â†’ For each item:
    â”‚       â”‚               â”‚       â””â”€â”€ <span class="component">SchemaFields</span> <span class="note">â† schema-renderer.tsx:39</span>
    â”‚       â”‚               â”‚           â”œâ”€â”€ Reads: schema.properties
    â”‚       â”‚               â”‚           â”œâ”€â”€ Filters: display === true
    â”‚       â”‚               â”‚           â”‚
    â”‚       â”‚               â”‚           â””â”€â”€ For each displayable field:
    â”‚       â”‚               â”‚               â””â”€â”€ <span class="component">SchemaField</span> <span class="note">â† schema-renderer.tsx:217</span>
    â”‚       â”‚               â”‚                   â”œâ”€â”€ type="array" â†’ <span class="component">ArrayField</span>
    â”‚       â”‚               â”‚                   â”‚   â””â”€â”€ Renders array items
    â”‚       â”‚               â”‚                   â”œâ”€â”€ type="object" â†’ recurse <span class="component">SchemaFields</span>
    â”‚       â”‚               â”‚                   â””â”€â”€ primitive â†’ &lt;span&gt;{value}&lt;/span&gt;
    â”‚       â”‚               â”‚
    â”‚       â”‚               â””â”€â”€ <span class="component">StructuredSelectListControlled</span>
    â”‚       â”‚                   â”œâ”€â”€ Props: request, state, onStateChange
    â”‚       â”‚                   â”œâ”€â”€ <span class="function">parseSchemaData(data, schema)</span> <span class="note">â† schema-utils.ts:63</span>
    â”‚       â”‚                   â”‚   â””â”€â”€ Returns: { groups: SelectableGroup[], flatItems: SelectableItem[] }
    â”‚       â”‚                   â”‚
    â”‚       â”‚                   â”œâ”€â”€ <span class="component">GroupSection</span>
    â”‚       â”‚                   â”‚   â”œâ”€â”€ Shows group header with label
    â”‚       â”‚                   â”‚   â””â”€â”€ <span class="component">SchemaFields</span> for parentData
    â”‚       â”‚                   â”‚
    â”‚       â”‚                   â””â”€â”€ <span class="component">SelectableListItem</span>
    â”‚       â”‚                       â”œâ”€â”€ <span class="component">DisplayComponents</span> <span class="note">â† if schema.display_components present</span>
    â”‚       â”‚                       â”‚   â””â”€â”€ <span class="component">DisplayComponentItem</span>
    â”‚       â”‚                       â”‚       â”œâ”€â”€ type="color" â†’ <span class="component">ColorSwatch</span>
    â”‚       â”‚                       â”‚       â”œâ”€â”€ type="image" â†’ &lt;span&gt;
    â”‚       â”‚                       â”‚       â”œâ”€â”€ type="url" â†’ &lt;a href&gt;
    â”‚       â”‚                       â”‚       â””â”€â”€ default â†’ &lt;span&gt;{value}&lt;/span&gt;
    â”‚       â”‚                       â”‚
    â”‚       â”‚                       â”œâ”€â”€ OR: <span class="function">renderTemplate(displayFormat)</span> <span class="note">â† if schema.display_format present</span>
    â”‚       â”‚                       â”‚
    â”‚       â”‚                       â””â”€â”€ OR: <span class="component">SchemaFields</span> <span class="note">â† fallback to display:true fields</span>
    â”‚       â”‚                           â””â”€â”€ (same as above)
    â”‚       â”‚
    â”‚       â””â”€â”€ inputs.mode == "review"
    â”‚           â”‚
    â”‚           â””â”€â”€ interaction_type = <span class="highlight">REVIEW_GROUPED</span>
    â”‚               â”‚
    â”‚               â””â”€â”€ <span class="note">[WEBUI: InteractionHost.tsx:1704 switch]</span>
    â”‚                   â”‚
    â”‚                   â””â”€â”€ <span class="component">ReviewGroupedHost</span> <span class="note">(line 1126)</span>
    â”‚                       â”œâ”€â”€ State: ReviewGroupedState (feedbackByGroup, retryGroups)
    â”‚                       â”œâ”€â”€ Variants: [cards, list]
    â”‚                       â”‚
    â”‚                       â”œâ”€â”€ <span class="component">ReviewGroupedCardsControlled</span>
    â”‚                       â”‚   â”œâ”€â”€ Props: request, state, onStateChange
    â”‚                       â”‚   â”œâ”€â”€ <span class="function">parseGroups(data, schema)</span> <span class="note">â† LOCAL function line 42-84</span>
    â”‚                       â”‚   â”‚   â””â”€â”€ Returns: GroupData[]
    â”‚                       â”‚   â”‚
    â”‚                       â”‚   â””â”€â”€ For each group:
    â”‚                       â”‚       â”œâ”€â”€ <span class="component">Card</span>
    â”‚                       â”‚       â”‚   â”œâ”€â”€ <span class="component">CardHeader</span> with group.label
    â”‚                       â”‚       â”‚   â””â”€â”€ <span class="component">CardContent</span>
    â”‚                       â”‚       â”‚       â””â”€â”€ <span class="component">SchemaFields</span>(group.data, group.schema)
    â”‚                       â”‚       â”‚           â””â”€â”€ (same as above)
    â”‚                       â”‚       â”‚
    â”‚                       â”‚       â””â”€â”€ Feedback section (if retryable.feedback.per_group)
    â”‚                       â”‚           â”œâ”€â”€ <span class="component">Textarea</span> for feedback
    â”‚                       â”‚           â””â”€â”€ Save/Cancel buttons
    â”‚                       â”‚
    â”‚                       â””â”€â”€ <span class="component">ReviewGroupedListControlled</span>
    â”‚                           â”œâ”€â”€ Props: request, state, onStateChange
    â”‚                           â”œâ”€â”€ <span class="function">parseGroups(data, schema)</span> <span class="note">â† LOCAL function line 38-78</span>
    â”‚                           â”‚   â””â”€â”€ Returns: GroupData[]
    â”‚                           â”‚
    â”‚                           â””â”€â”€ For each group:
    â”‚                               â”œâ”€â”€ <span class="component">Separator</span> (if not first)
    â”‚                               â”œâ”€â”€ Group header with group.label
    â”‚                               â”œâ”€â”€ <span class="component">SchemaFields</span>(group.data, group.schema)
    â”‚                               â”‚   â””â”€â”€ (same as above)
    â”‚                               â”‚
    â”‚                               â””â”€â”€ Feedback section (if retryable.feedback.per_group)
    â”‚                                   â”œâ”€â”€ <span class="component">Textarea</span> for feedback
    â”‚                                   â””â”€â”€ Save/Cancel buttons
    â”‚
    â”‚
    â”œâ”€â”€ <span class="highlight">"user.text_input"</span>
    â”‚   â”‚
    â”‚   â””â”€â”€ <span class="note">[SERVER: server/modules/user/text_input.py]</span>
    â”‚       â”‚
    â”‚       â””â”€â”€ interaction_type = <span class="highlight">TEXT_INPUT</span>
    â”‚           â”‚
    â”‚           â””â”€â”€ <span class="note">[WEBUI: InteractionHost.tsx:1704 switch]</span>
    â”‚               â”‚
    â”‚               â””â”€â”€ <span class="component">TextInputHost</span> <span class="note">(line 344)</span>
    â”‚                   â”œâ”€â”€ State: TextInputState
    â”‚                   â”œâ”€â”€ Variants: [simple, enhanced]
    â”‚                   â”‚
    â”‚                   â”œâ”€â”€ <span class="component">TextInputSimpleControlled</span>
    â”‚                   â”‚   â”œâ”€â”€ Props: request, state, onStateChange
    â”‚                   â”‚   â”œâ”€â”€ Uses: request.default_value, request.allow_empty, request.multiline
    â”‚                   â”‚   â”œâ”€â”€ Renders: &lt;Textarea&gt; or &lt;Input&gt;
    â”‚                   â”‚   â””â”€â”€ Submit button
    â”‚                   â”‚
    â”‚                   â””â”€â”€ <span class="component">TextInputEnhancedControlled</span>
    â”‚                       â”œâ”€â”€ Props: request, state, onStateChange
    â”‚                       â”œâ”€â”€ Uses: request.default_value, request.allow_empty
    â”‚                       â”œâ”€â”€ Renders: &lt;Input&gt; with history/suggestions
    â”‚                       â””â”€â”€ Submit button
    â”‚
    â”‚
    â”œâ”€â”€ <span class="highlight">"user.pause"</span>
    â”‚   â”‚
    â”‚   â””â”€â”€ <span class="note">[SERVER: server/modules/user/pause.py]</span>
    â”‚       â”‚
    â”‚       â””â”€â”€ interaction_type = <span class="highlight">TEXT_INPUT</span> (with allow_empty=true)
    â”‚           â”‚
    â”‚           â””â”€â”€ <span class="note">[WEBUI: InteractionHost.tsx:1704 switch]</span>
    â”‚               â”‚
    â”‚               â””â”€â”€ <span class="component">TextInputHost</span> <span class="note">(same as user.text_input)</span>
    â”‚                   â””â”€â”€ (same hierarchy as above)
    â”‚
    â”‚
    â”œâ”€â”€ <span class="highlight">"user.file_input"</span>
    â”‚   â”‚
    â”‚   â””â”€â”€ <span class="note">[SERVER: server/modules/user/file_input.py]</span>
    â”‚       â”‚
    â”‚       â””â”€â”€ interaction_type = <span class="highlight">FILE_INPUT</span>
    â”‚           â”‚
    â”‚           â””â”€â”€ <span class="note">[WEBUI: InteractionHost.tsx:1704 switch]</span>
    â”‚               â”‚
    â”‚               â””â”€â”€ <span class="component">FileInputHost</span> <span class="note">(line 1391)</span>
    â”‚                   â”œâ”€â”€ State: FileInputState
    â”‚                   â”œâ”€â”€ Variants: [dropzone, text]
    â”‚                   â”‚
    â”‚                   â”œâ”€â”€ <span class="component">FileInputDropzoneControlled</span>
    â”‚                   â”‚   â”œâ”€â”€ Props: request, state, onStateChange
    â”‚                   â”‚   â”œâ”€â”€ Uses: request.accepted_types, request.multiple_files
    â”‚                   â”‚   â””â”€â”€ Renders: drag-drop zone with file preview
    â”‚                   â”‚
    â”‚                   â””â”€â”€ <span class="component">FileInputTextControlled</span>
    â”‚                       â”œâ”€â”€ Props: request, state, onStateChange
    â”‚                       â”œâ”€â”€ Uses: request.base_path
    â”‚                       â””â”€â”€ Renders: text input for file path
    â”‚
    â”‚
    â”œâ”€â”€ <span class="highlight">"io.client_write"</span>
    â”‚   â”‚
    â”‚   â””â”€â”€ <span class="note">[SERVER: server/modules/io/client_write.py]</span>
    â”‚       â”‚
    â”‚       â””â”€â”€ interaction_type = <span class="highlight">FILE_DOWNLOAD</span>
    â”‚           â”‚
    â”‚           â””â”€â”€ <span class="note">[WEBUI: InteractionHost.tsx:1704 switch]</span>
    â”‚               â”‚
    â”‚               â””â”€â”€ <span class="component">FileDownloadHost</span> <span class="note">(line 1633)</span>
    â”‚                   â”œâ”€â”€ State: FileDownloadState
    â”‚                   â”‚
    â”‚                   â””â”€â”€ <span class="component">FileDownloadControlled</span>
    â”‚                       â”œâ”€â”€ Props: request, state, onStateChange
    â”‚                       â”œâ”€â”€ Uses: request.file_content, request.file_name, request.file_content_type
    â”‚                       â”œâ”€â”€ Auto-writes file to project folder
    â”‚                       â””â”€â”€ Shows confirmation or error
    â”‚
    â”‚
    â””â”€â”€ <span class="note">(unused interaction types - defined but no module creates them)</span>
        â”‚
        â”œâ”€â”€ <span class="highlight">CONFIRM</span>
        â”‚   â”‚
        â”‚   â””â”€â”€ <span class="note">[WEBUI: InteractionHost.tsx:1704 switch]</span>
        â”‚       â”‚
        â”‚       â””â”€â”€ <span class="component">ConfirmHost</span> <span class="note">(line 599)</span>
        â”‚           â”œâ”€â”€ State: ConfirmState
        â”‚           â”œâ”€â”€ Variants: [buttons, cards]
        â”‚           â”‚
        â”‚           â”œâ”€â”€ <span class="component">ConfirmButtonsControlled</span>
        â”‚           â”‚   â”œâ”€â”€ Props: request, state, onStateChange
        â”‚           â”‚   â”œâ”€â”€ Uses: request.yes_label, request.no_label, request.default_confirm
        â”‚           â”‚   â””â”€â”€ Renders: Yes/No buttons
        â”‚           â”‚
        â”‚           â””â”€â”€ <span class="component">ConfirmCardsControlled</span>
        â”‚               â”œâ”€â”€ Props: request, state, onStateChange
        â”‚               â”œâ”€â”€ Uses: request.yes_label, request.no_label
        â”‚               â””â”€â”€ Renders: clickable cards for Yes/No
        â”‚
        â””â”€â”€ <span class="highlight">SELECT_FROM_LIST</span>
            â”‚
            â””â”€â”€ <span class="note">[WEBUI: InteractionHost.tsx:1704 switch]</span>
                â”‚
                â””â”€â”€ <span class="component">SelectListHost</span> <span class="note">(line 104)</span>
                    â”œâ”€â”€ State: SelectListState
                    â”œâ”€â”€ Variants: [checkbox, cards, chips, dropdown]
                    â”‚
                    â”œâ”€â”€ <span class="component">SelectListCheckboxControlled</span>
                    â”‚   â”œâ”€â”€ Props: request, state, onStateChange
                    â”‚   â”œâ”€â”€ Uses: request.options[] <span class="note">(NOT schema - just SelectOption[])</span>
                    â”‚   â””â”€â”€ Renders: checkbox list of options
                    â”‚
                    â”œâ”€â”€ <span class="component">SelectListCardsControlled</span>
                    â”‚   â”œâ”€â”€ Props: request, state, onStateChange
                    â”‚   â”œâ”€â”€ Uses: request.options[]
                    â”‚   â””â”€â”€ Renders: card grid of options
                    â”‚
                    â”œâ”€â”€ <span class="component">SelectListChipsControlled</span>
                    â”‚   â”œâ”€â”€ Props: request, state, onStateChange
                    â”‚   â”œâ”€â”€ Uses: request.options[]
                    â”‚   â””â”€â”€ Renders: chip/badge list
                    â”‚
                    â””â”€â”€ <span class="component">SelectListDropdownControlled</span>
                        â”œâ”€â”€ Props: request, state, onStateChange
                        â”œâ”€â”€ Uses: request.options[]
                        â””â”€â”€ Renders: dropdown/combobox
            </div>

            <h3 style="margin-top: 30px;">Data Flow for Schema-Based Interactions</h3>
            <div class="tree">
<span class="file">step.json inputs</span>
â”‚
â”œâ”€â”€ <span class="highlight">data</span>: "{{ state.some_response }}" <span class="note">(Jinja2 template)</span>
â”‚   â”‚
â”‚   â””â”€â”€ <span class="note">[SERVER: Jinja2Resolver in workflow_processor.py]</span>
â”‚       â”‚
â”‚       â””â”€â”€ Resolved to actual values from workflow state
â”‚           â”‚
â”‚           â””â”€â”€ <span class="note">[API: response.interaction_request.display_data.data]</span>
â”‚               â”‚
â”‚               â””â”€â”€ <span class="note">[WEBUI: request.display_data.data]</span>
â”‚                   â”‚
â”‚                   â”œâ”€â”€ StructuredSelect: â†’ <span class="function">parseSchemaData(data, schema)</span>
â”‚                   â”‚   â””â”€â”€ Extracts selectable items based on schema.selectable
â”‚                   â”‚
â”‚                   â””â”€â”€ ReviewGrouped: â†’ <span class="function">parseGroups(data, schema)</span>
â”‚                       â””â”€â”€ Extracts groups (currently only handles nested objects)
â”‚
â”œâ”€â”€ <span class="highlight">schema</span>: { type, properties, display, display_label, ... }
â”‚   â”‚
â”‚   â””â”€â”€ <span class="note">[SERVER: Passed through unchanged]</span>
â”‚       â”‚
â”‚       â””â”€â”€ <span class="note">[API: response.interaction_request.display_data.schema]</span>
â”‚           â”‚
â”‚           â””â”€â”€ <span class="note">[WEBUI: request.display_data.schema]</span>
â”‚               â”‚
â”‚               â””â”€â”€ <span class="component">SchemaFields</span>
â”‚                   â”‚
â”‚                   â”œâ”€â”€ Reads: schema.properties
â”‚                   â”œâ”€â”€ Filters: propSchema.display === true
â”‚                   â”œâ”€â”€ Sorts by: propSchema.display_order (if present)
â”‚                   â”‚
â”‚                   â””â”€â”€ For each displayable property:
â”‚                       â”‚
â”‚                       â””â”€â”€ <span class="component">SchemaField</span>(key, value, propSchema)
â”‚                           â”‚
â”‚                           â”œâ”€â”€ propSchema.type === "array"
â”‚                           â”‚   â””â”€â”€ <span class="component">ArrayField</span> <span class="note">â† schema-renderer.tsx:312</span>
â”‚                           â”‚       â”œâ”€â”€ display_format === "join" â†’ single line: "item1 item2 item3"
â”‚                           â”‚       â””â”€â”€ else â†’ numbered list: [1] item1, [2] item2
â”‚                           â”‚       â””â”€â”€ <span style="color:#ff6b6b">âš ï¸ Only String(item) - NO recursion for objects!</span>
â”‚                           â”‚
â”‚                           â”œâ”€â”€ propSchema.type === "object"
â”‚                           â”‚   â””â”€â”€ Recurse: <span class="component">SchemaFields</span>(value, propSchema)
â”‚                           â”‚
â”‚                           â””â”€â”€ primitive (string, number, boolean)
â”‚                               â”‚
â”‚                               â”œâ”€â”€ If propSchema.display_format:
â”‚                               â”‚   â””â”€â”€ <span class="function">renderTemplate(display_format, {value, ...})</span>
â”‚                               â”‚
â”‚                               â””â”€â”€ Else:
â”‚                                   â””â”€â”€ &lt;span&gt;{String(value)}&lt;/span&gt;
â”‚
â”œâ”€â”€ <span class="highlight">prompt</span>: "Select an option"
â”‚   â”‚
â”‚   â””â”€â”€ <span class="note">[SERVER: Passed through]</span>
â”‚       â””â”€â”€ <span class="note">[API: response.interaction_request.prompt]</span>
â”‚           â””â”€â”€ <span class="note">[WEBUI: request.prompt]</span>
â”‚               â””â”€â”€ Rendered as &lt;h3&gt; or &lt;p&gt; heading in component
â”‚
â””â”€â”€ <span class="highlight">retryable</span>: { options: [...], default_option: "..." } <span class="note">(from step.json module config)</span>
    â”‚
    â””â”€â”€ <span class="note">[SERVER: Added by workflow_processor from module_config.get('retryable')]</span>
        â””â”€â”€ <span class="note">[API: response.interaction_request.display_data.retryable]</span>
            â””â”€â”€ <span class="note">[WEBUI: request.display_data.retryable]</span>
                â””â”€â”€ Renders action buttons based on options[].mode
            </div>

            <h3 style="margin-top: 30px;">Retryable Options: Response Flow (Continue / Retry / Jump)</h3>
            <div class="tree">
<span class="file">step.json module config</span>
â”‚
â””â”€â”€ <span class="highlight">retryable</span>: {
    â”‚   default_option: "continue",
    â”‚   options: [...]
    â”‚ }
    â”‚
    â””â”€â”€ options[] - each option has a <span class="highlight">mode</span> that determines behavior
        â”‚
        â”‚
        â”œâ”€â”€ <span class="highlight">mode: "continue"</span>
        â”‚   â”‚
        â”‚   â”œâ”€â”€ <span class="note">[WORKFLOW JSON]</span>
        â”‚   â”‚   {
        â”‚   â”‚     "id": "continue",
        â”‚   â”‚     "mode": "continue",
        â”‚   â”‚     "label": "Accept and continue"
        â”‚   â”‚   }
        â”‚   â”‚
        â”‚   â”œâ”€â”€ <span class="note">[WEBUI: User clicks Continue button]</span>
        â”‚   â”‚   â””â”€â”€ Sends response with selected option
        â”‚   â”‚
        â”‚   â””â”€â”€ <span class="note">[SERVER: workflow_processor.py]</span>
        â”‚       â””â”€â”€ Normal flow - stores outputs, continues to next module
        â”‚
        â”‚
        â”œâ”€â”€ <span class="highlight">mode: "retry"</span>
        â”‚   â”‚
        â”‚   â”œâ”€â”€ <span class="note">[WORKFLOW JSON]</span>
        â”‚   â”‚   {
        â”‚   â”‚     "id": "retry",
        â”‚   â”‚     "mode": "retry",
        â”‚   â”‚     "label": "Regenerate prompts",
        â”‚   â”‚     "shortcut": "r",
        â”‚   â”‚     "target_module": "generate_prompts_api",  <span class="note">â† Module to re-run</span>
        â”‚   â”‚     "feedback": {
        â”‚   â”‚       "enabled": true,
        â”‚   â”‚       "per_group": true,                      <span class="note">â† Per-group feedback in ReviewGrouped</span>
        â”‚   â”‚       "prompt": "What to change?",
        â”‚   â”‚       "default_message": "..."
        â”‚   â”‚     }
        â”‚   â”‚   }
        â”‚   â”‚
        â”‚   â”œâ”€â”€ <span class="note">[WEBUI: User clicks Retry button]</span>
        â”‚   â”‚   â”‚
        â”‚   â”‚   â”œâ”€â”€ ReviewGroupedHost: May include per-group feedback
        â”‚   â”‚   â”‚   â””â”€â”€ state.feedbackByGroup: { group_key: "feedback text" }
        â”‚   â”‚   â”‚
        â”‚   â”‚   â””â”€â”€ Sends response:
        â”‚   â”‚       {
        â”‚   â”‚         retry_requested: true,
        â”‚   â”‚         retry_groups: ["group1", "group2"],
        â”‚   â”‚         retry_feedback: "combined feedback"
        â”‚   â”‚       }
        â”‚   â”‚
        â”‚   â””â”€â”€ <span class="note">[SERVER: workflow_processor.py:908-928]</span>
        â”‚       â”‚
        â”‚       â”œâ”€â”€ Checks: outputs.get('retry_requested')
        â”‚       â”‚
        â”‚       â”œâ”€â”€ Finds target_module from retryable.options where mode == 'retry'
        â”‚       â”‚
        â”‚       â”œâ”€â”€ Stores feedback in state (for LLM to use)
        â”‚       â”‚
        â”‚       â””â”€â”€ Calls: <span class="function">self.retry(workflow_run_id, target_module, feedback)</span>
        â”‚           â”‚
        â”‚           â””â”€â”€ <span class="note">[database_provider.py]</span>
        â”‚               â”œâ”€â”€ Creates new branch
        â”‚               â”œâ”€â”€ Stores RETRY_REQUESTED event
        â”‚               â””â”€â”€ Re-executes from target_module
        â”‚
        â”‚
        â””â”€â”€ <span class="highlight">mode: "jump"</span>
            â”‚
            â”œâ”€â”€ <span class="note">[WORKFLOW JSON]</span>
            â”‚   {
            â”‚     "id": "restart_aesthetic",
            â”‚     "mode": "jump",
            â”‚     "label": "Go back to aesthetic selection",
            â”‚     "target_step": "user_input",              <span class="note">â† Step to jump to</span>
            â”‚     "target_module": "select_concept"         <span class="note">â† Module within step</span>
            â”‚   }
            â”‚
            â”œâ”€â”€ <span class="note">[WEBUI: User clicks Jump button]</span>
            â”‚   â”‚
            â”‚   â””â”€â”€ Sends response:
            â”‚       {
            â”‚         jump_back_requested: true,
            â”‚         jump_back_target: "select_concept"    <span class="note">â† target_module value</span>
            â”‚       }
            â”‚
            â””â”€â”€ <span class="note">[SERVER: workflow_processor.py:931-952]</span>
                â”‚
                â”œâ”€â”€ Checks: outputs.get('jump_back_requested')
                â”‚
                â”œâ”€â”€ Finds matching option in retryable.options where:
                â”‚   - opt.mode == 'jump'
                â”‚   - opt.target_module == jump_back_target
                â”‚
                â”œâ”€â”€ Extracts: target_step, target_module
                â”‚
                â””â”€â”€ Calls: <span class="function">self.jump(workflow_run_id, target_step, target_module)</span>
                    â”‚
                    â””â”€â”€ <span class="note">[database_provider.py]</span>
                        â”œâ”€â”€ Creates new branch
                        â”œâ”€â”€ Stores JUMP_REQUESTED event
                        â””â”€â”€ Re-executes from target_step/target_module
            </div>

            <h3 style="margin-top: 30px;">Retryable in WebUI Components</h3>
            <div class="tree">
<span class="component">ReviewGroupedListControlled</span> / <span class="component">ReviewGroupedCardsControlled</span>
â”‚
â”œâ”€â”€ Receives: request.display_data.retryable
â”‚   {
â”‚     options: [
â”‚       { id: "continue", mode: "continue", label: "Accept" },
â”‚       { id: "retry", mode: "retry", label: "Regenerate", feedback: { per_group: true } },
â”‚       { id: "jump_1", mode: "jump", label: "Go back to X" }
â”‚     ]
â”‚   }
â”‚
â”œâ”€â”€ State: ReviewGroupedState
â”‚   {
â”‚     feedbackByGroup: { [groupKey]: string },  <span class="note">â† Per-group feedback text</span>
â”‚     retryGroups: string[],                    <span class="note">â† Groups marked for retry</span>
â”‚     isDirty: boolean,
â”‚     isValid: boolean
â”‚   }
â”‚
â”œâ”€â”€ Renders per-group feedback UI (if retryable.options[].feedback.per_group)
â”‚   â”‚
â”‚   â””â”€â”€ For each group:
â”‚       â”œâ”€â”€ "Add feedback" button
â”‚       â”œâ”€â”€ <span class="component">Textarea</span> for feedback text
â”‚       â””â”€â”€ Save/Cancel buttons
â”‚       â””â”€â”€ Updates state.feedbackByGroup[group.key]
â”‚
â””â”€â”€ Renders action buttons
    â”‚
    â””â”€â”€ For each option in retryable.options:
        â”‚
        â”œâ”€â”€ mode == "continue"
        â”‚   â””â”€â”€ <span class="component">Button</span> variant="default"
        â”‚       â””â”€â”€ onClick: onSubmit() with normal response
        â”‚
        â”œâ”€â”€ mode == "retry"
        â”‚   â””â”€â”€ <span class="component">Button</span> variant="outline" (highlighted if has feedback)
        â”‚       â””â”€â”€ onClick: onSubmit() with { retry_requested: true, ... }
        â”‚
        â””â”€â”€ mode == "jump"
            â””â”€â”€ <span class="component">Button</span> variant="outline"
                â””â”€â”€ onClick: onSubmit() with { jump_back_requested: true, jump_back_target: option.target_module }
            </div>
        </div>

        <!-- ============================================= -->
        <h2 id="interaction-types">All Interaction Types</h2>
        <!-- ============================================= -->

        <div class="flow-section">
            <p>Defined in <code>contracts/interactions.py:16-28</code></p>

            <table>
                <tr>
                    <th>InteractionType</th>
                    <th>Created By Module</th>
                    <th>WebUI Host</th>
                    <th>Uses Schema?</th>
                </tr>
                <tr>
                    <td><code>text_input</code></td>
                    <td>user.text_input, user.pause</td>
                    <td>TextInputHost</td>
                    <td>No</td>
                </tr>
                <tr>
                    <td><code>confirm</code></td>
                    <td>(not used by modules currently)</td>
                    <td>ConfirmHost</td>
                    <td>No</td>
                </tr>
                <tr>
                    <td><code>select_from_list</code></td>
                    <td>(not used - use select_from_structured)</td>
                    <td>SelectListHost</td>
                    <td>No (uses options[])</td>
                </tr>
                <tr>
                    <td><code>select_from_structured</code></td>
                    <td>user.select (mode="select")</td>
                    <td>StructuredSelectHost</td>
                    <td><strong>Yes</strong></td>
                </tr>
                <tr>
                    <td><code>review_grouped</code></td>
                    <td>user.select (mode="review")</td>
                    <td>ReviewGroupedHost</td>
                    <td><strong>Yes (broken)</strong></td>
                </tr>
                <tr>
                    <td><code>file_input</code></td>
                    <td>user.file_input</td>
                    <td>FileInputHost</td>
                    <td>No</td>
                </tr>
                <tr>
                    <td><code>file_download</code></td>
                    <td>io.client_write</td>
                    <td>FileDownloadHost</td>
                    <td>No</td>
                </tr>
            </table>
        </div>

        <!-- ============================================= -->
        <h2 id="full-flow">Complete Data Flow</h2>
        <!-- ============================================= -->

        <div class="flow-section">
            <h3>Step 1: Workflow JSON defines module with inputs</h3>
            <div class="flow-row">
                <div class="flow-box workflow">
                    <h4>ğŸ“„ workflows/oms/steps/8_music_generation/step.json</h4>
<pre><code>{
  <span class="string">"module_id"</span>: <span class="string">"user.select"</span>,       <span class="comment">// â† Which module to use</span>
  <span class="string">"inputs"</span>: {
    <span class="string">"data"</span>: <span class="string">"{{ state.elevenlabs_prompts_response }}"</span>,
    <span class="string">"schema"</span>: {
      <span class="string">"type"</span>: <span class="string">"object"</span>,
      <span class="string">"display_mode"</span>: <span class="string">"review"</span>,        <span class="comment">// â† Hint for webui layout</span>
      <span class="string">"properties"</span>: {
        <span class="string">"track_title"</span>: {
          <span class="string">"type"</span>: <span class="string">"string"</span>,           <span class="comment">// â† JSON Schema type</span>
          <span class="string">"display"</span>: <span class="keyword">true</span>,            <span class="comment">// â† Show this field</span>
          <span class="string">"display_label"</span>: <span class="string">"Track Title"</span>  <span class="comment">// â† Label to display</span>
        }
      }
    },
    <span class="string">"mode"</span>: <span class="string">"review"</span>                 <span class="comment">// â† Determines InteractionType</span>
  }
}</code></pre>
                </div>
            </div>

            <h3>Step 2: Server module creates InteractionRequest</h3>
            <div class="flow-row">
                <div class="flow-box server">
                    <h4>ğŸ server/modules/user/select.py:150-195</h4>
<pre><code><span class="keyword">def</span> <span class="function">get_interaction_request</span>(self, inputs, context):
    mode = inputs.get(<span class="string">'mode'</span>)

    <span class="comment"># Mode determines InteractionType</span>
    <span class="keyword">if</span> mode == <span class="string">"review"</span>:
        interaction_type = <span class="highlight">InteractionType.REVIEW_GROUPED</span>
    <span class="keyword">else</span>:
        interaction_type = <span class="highlight">InteractionType.SELECT_FROM_STRUCTURED</span>

    <span class="keyword">return</span> InteractionRequest(
        interaction_type=interaction_type,
        <span class="highlight">display_data</span>={
            <span class="string">"data"</span>: data,      <span class="comment"># Raw data from workflow</span>
            <span class="string">"schema"</span>: schema,  <span class="comment"># Schema from workflow</span>
            <span class="string">"mode"</span>: mode,
            <span class="string">"retryable"</span>: retryable
        }
    )</code></pre>
                </div>
            </div>

            <h3>Step 3: WebUI receives InteractionRequest via API</h3>
            <div class="flow-row">
                <div class="flow-box webui">
                    <h4>ğŸ“¡ API Response (JSON over HTTP)</h4>
<pre><code>{
  <span class="string">"interaction_request"</span>: {
    <span class="string">"interaction_type"</span>: <span class="string">"review_grouped"</span>,  <span class="comment">// â† Routes to component</span>
    <span class="string">"interaction_id"</span>: <span class="string">"select_12345"</span>,
    <span class="string">"prompt"</span>: <span class="string">"Review ElevenLabs prompts"</span>,
    <span class="string">"display_data"</span>: {
      <span class="string">"data"</span>: { <span class="comment">/* actual values */</span> },
      <span class="string">"schema"</span>: { <span class="comment">/* with display: true fields */</span> },
      <span class="string">"mode"</span>: <span class="string">"review"</span>
    }
  }
}</code></pre>
                </div>
            </div>

            <h3>Step 4: InteractionHost routes to specific Host</h3>
            <div class="flow-row">
                <div class="flow-box webui">
                    <h4>âš›ï¸ webui/src/components/workflow/interactions/InteractionHost.tsx:1704-1787</h4>
<pre><code><span class="keyword">function</span> <span class="function">InteractionHost</span>({ request, onSubmit }) {
  <span class="keyword">switch</span> (request.<span class="highlight">interaction_type</span>) {
    <span class="keyword">case</span> <span class="string">"select_from_list"</span>:
      <span class="keyword">return</span> &lt;<span class="component">SelectListHost</span> .../&gt;;

    <span class="keyword">case</span> <span class="string">"text_input"</span>:
      <span class="keyword">return</span> &lt;<span class="component">TextInputHost</span> .../&gt;;

    <span class="keyword">case</span> <span class="string">"confirm"</span>:
      <span class="keyword">return</span> &lt;<span class="component">ConfirmHost</span> .../&gt;;

    <span class="keyword">case</span> <span class="string">"select_from_structured"</span>:
      <span class="keyword">return</span> &lt;<span class="component">StructuredSelectHost</span> .../&gt;;  <span class="comment">// â† Uses schema</span>

    <span class="keyword">case</span> <span class="string">"review_grouped"</span>:
      <span class="keyword">return</span> &lt;<span class="component">ReviewGroupedHost</span> .../&gt;;      <span class="comment">// â† Uses schema (broken)</span>

    <span class="keyword">case</span> <span class="string">"file_input"</span>:
      <span class="keyword">return</span> &lt;<span class="component">FileInputHost</span> .../&gt;;

    <span class="keyword">case</span> <span class="string">"file_download"</span>:
      <span class="keyword">return</span> &lt;<span class="component">FileDownloadHost</span> .../&gt;;
  }
}</code></pre>
                </div>
            </div>
        </div>

        <!-- ============================================= -->
        <h2 id="module-mapping">Workflow Module â†’ InteractionType Mapping</h2>
        <!-- ============================================= -->

        <div class="flow-section">
            <table>
                <tr>
                    <th>Workflow module_id</th>
                    <th>Input that controls type</th>
                    <th>Resulting InteractionType</th>
                </tr>
                <tr>
                    <td><code>user.select</code></td>
                    <td><code>mode: "select"</code> (default)</td>
                    <td><code>select_from_structured</code></td>
                </tr>
                <tr>
                    <td><code>user.select</code></td>
                    <td><code>mode: "review"</code></td>
                    <td><code>review_grouped</code></td>
                </tr>
                <tr>
                    <td><code>user.text_input</code></td>
                    <td>(always)</td>
                    <td><code>text_input</code></td>
                </tr>
                <tr>
                    <td><code>user.pause</code></td>
                    <td>(always)</td>
                    <td><code>text_input</code> (with allow_empty=true)</td>
                </tr>
                <tr>
                    <td><code>user.file_input</code></td>
                    <td>(always)</td>
                    <td><code>file_input</code></td>
                </tr>
                <tr>
                    <td><code>io.client_write</code></td>
                    <td>(always)</td>
                    <td><code>file_download</code></td>
                </tr>
            </table>

            <p><strong>Note:</strong> <code>confirm</code> and <code>select_from_list</code> types exist in contracts but are not currently used by any server module.</p>
        </div>

        <!-- ============================================= -->
        <h2 id="component-hierarchy">WebUI Component Hierarchy (All Components)</h2>
        <!-- ============================================= -->

        <div class="flow-section">
            <div class="tree">
<span class="component">InteractionHost</span> <span class="note">(router at InteractionHost.tsx:1704)</span>
â”‚
â”œâ”€â”€ interaction_type=<span class="string">"select_from_list"</span>
â”‚   â””â”€â”€ <span class="component">SelectListHost</span> <span class="note">(line 104)</span>
â”‚       â”œâ”€â”€ State: SelectListState
â”‚       â”œâ”€â”€ Variants: [checkbox, cards, chips, dropdown]
â”‚       â”‚
â”‚       â”œâ”€â”€ <span class="component">SelectListCheckboxControlled</span>
â”‚       â”‚   â”œâ”€â”€ Props: request, state, onStateChange
â”‚       â”‚   â”œâ”€â”€ Uses: request.options[] <span class="note">(NOT schema)</span>
â”‚       â”‚   â””â”€â”€ Renders: checkbox list of options
â”‚       â”‚
â”‚       â”œâ”€â”€ <span class="component">SelectListCardsControlled</span>
â”‚       â”‚   â”œâ”€â”€ Props: request, state, onStateChange
â”‚       â”‚   â”œâ”€â”€ Uses: request.options[]
â”‚       â”‚   â””â”€â”€ Renders: card grid of options
â”‚       â”‚
â”‚       â”œâ”€â”€ <span class="component">SelectListChipsControlled</span>
â”‚       â”‚   â”œâ”€â”€ Props: request, state, onStateChange
â”‚       â”‚   â”œâ”€â”€ Uses: request.options[]
â”‚       â”‚   â””â”€â”€ Renders: chip/badge list
â”‚       â”‚
â”‚       â””â”€â”€ <span class="component">SelectListDropdownControlled</span>
â”‚           â”œâ”€â”€ Props: request, state, onStateChange
â”‚           â”œâ”€â”€ Uses: request.options[]
â”‚           â””â”€â”€ Renders: dropdown/combobox
â”‚
â”œâ”€â”€ interaction_type=<span class="string">"text_input"</span>
â”‚   â””â”€â”€ <span class="component">TextInputHost</span> <span class="note">(line 344)</span>
â”‚       â”œâ”€â”€ State: TextInputState
â”‚       â”œâ”€â”€ Variants: [simple, enhanced]
â”‚       â”‚
â”‚       â”œâ”€â”€ <span class="component">TextInputSimpleControlled</span>
â”‚       â”‚   â”œâ”€â”€ Props: request, state, onStateChange
â”‚       â”‚   â”œâ”€â”€ Uses: request.default_value, request.allow_empty
â”‚       â”‚   â””â”€â”€ Renders: textarea or input
â”‚       â”‚
â”‚       â””â”€â”€ <span class="component">TextInputEnhancedControlled</span>
â”‚           â”œâ”€â”€ Props: request, state, onStateChange
â”‚           â””â”€â”€ Renders: input with history/suggestions
â”‚
â”œâ”€â”€ interaction_type=<span class="string">"confirm"</span>
â”‚   â””â”€â”€ <span class="component">ConfirmHost</span> <span class="note">(line 599)</span>
â”‚       â”œâ”€â”€ State: ConfirmState
â”‚       â”œâ”€â”€ Variants: [buttons, cards]
â”‚       â”‚
â”‚       â”œâ”€â”€ <span class="component">ConfirmButtonsControlled</span>
â”‚       â”‚   â”œâ”€â”€ Props: request, state, onStateChange
â”‚       â”‚   â”œâ”€â”€ Uses: request.yes_label, request.no_label
â”‚       â”‚   â””â”€â”€ Renders: Yes/No buttons
â”‚       â”‚
â”‚       â””â”€â”€ <span class="component">ConfirmCardsControlled</span>
â”‚           â”œâ”€â”€ Props: request, state, onStateChange
â”‚           â””â”€â”€ Renders: clickable cards for Yes/No
â”‚
â”œâ”€â”€ interaction_type=<span class="string">"select_from_structured"</span>
â”‚   â””â”€â”€ <span class="component">StructuredSelectHost</span> <span class="note">(line 852)</span>
â”‚       â”œâ”€â”€ State: StructuredSelectState
â”‚       â”œâ”€â”€ Variants: [cards, list]
â”‚       â”‚
â”‚       â”œâ”€â”€ <span class="component">StructuredSelectCardsControlled</span>
â”‚       â”‚   â”œâ”€â”€ Props: request, state, onStateChange
â”‚       â”‚   â”œâ”€â”€ <span class="function">parseSchemaData(data, schema)</span> <span class="note">â† schema-utils.ts:63</span>
â”‚       â”‚   â”‚   â””â”€â”€ Returns: { groups[], flatItems[] }
â”‚       â”‚   â”‚
â”‚       â”‚   â””â”€â”€ For each item:
â”‚       â”‚       â””â”€â”€ <span class="component">SchemaFields</span> <span class="note">â† schema-renderer.tsx:39</span>
â”‚       â”‚           â”œâ”€â”€ Checks: schema.properties[key].display === true
â”‚       â”‚           â””â”€â”€ <span class="component">SchemaField</span> <span class="note">â† schema-renderer.tsx:217</span>
â”‚       â”‚               â”œâ”€â”€ type="array" â†’ <span class="component">ArrayField</span>
â”‚       â”‚               â”œâ”€â”€ type="object" â†’ recurse <span class="component">SchemaFields</span>
â”‚       â”‚               â””â”€â”€ primitive â†’ &lt;span&gt;{value}&lt;/span&gt;
â”‚       â”‚
â”‚       â””â”€â”€ <span class="component">StructuredSelectListControlled</span>
â”‚           â”œâ”€â”€ Props: request, state, onStateChange
â”‚           â”œâ”€â”€ <span class="function">parseSchemaData(data, schema)</span> <span class="note">â† same utility</span>
â”‚           â”‚   â””â”€â”€ Returns: { groups[], flatItems[] }
â”‚           â”‚
â”‚           â”œâ”€â”€ <span class="component">GroupSection</span>
â”‚           â”‚   â”œâ”€â”€ Shows group header with label
â”‚           â”‚   â””â”€â”€ <span class="component">SchemaFields</span> for parentData
â”‚           â”‚
â”‚           â””â”€â”€ <span class="component">SelectableListItem</span>
â”‚               â”œâ”€â”€ <span class="component">DisplayComponents</span> <span class="note">â† if display_components present</span>
â”‚               â”‚   â””â”€â”€ <span class="component">DisplayComponentItem</span>
â”‚               â”‚       â”œâ”€â”€ type="color" â†’ <span class="component">ColorSwatch</span>
â”‚               â”‚       â”œâ”€â”€ type="url" â†’ &lt;a href&gt;
â”‚               â”‚       â””â”€â”€ default â†’ &lt;span&gt;
â”‚               â”‚
â”‚               â”œâ”€â”€ OR: renderTemplate(displayFormat) <span class="note">â† if display_format present</span>
â”‚               â”‚
â”‚               â””â”€â”€ OR: <span class="component">SchemaFields</span> <span class="note">â† fallback to display:true fields</span>
â”‚
â”œâ”€â”€ interaction_type=<span class="string">"review_grouped"</span>
â”‚   â””â”€â”€ <span class="component">ReviewGroupedHost</span> <span class="note">(line 1126)</span>
â”‚       â”œâ”€â”€ State: ReviewGroupedState
â”‚       â”œâ”€â”€ Variants: [cards, list]
â”‚       â”‚
â”‚       â”œâ”€â”€ <span class="component">ReviewGroupedCardsControlled</span>
â”‚       â”‚   â”œâ”€â”€ Props: request, state, onStateChange
â”‚       â”‚   â”œâ”€â”€ <span class="function">parseGroups(data, schema)</span> <span class="note">â† LOCAL function line 42-84</span>
â”‚       â”‚   â”‚   â””â”€â”€ <span style="color:#ff6b6b">âš ï¸ PROBLEM: Only handles nested objects!</span>
â”‚       â”‚   â”‚       <span style="color:#ff6b6b">Line 71: if (typeof value !== "object") continue;</span>
â”‚       â”‚   â”‚
â”‚       â”‚   â””â”€â”€ For each group:
â”‚       â”‚       â””â”€â”€ <span class="component">SchemaFields</span> <span class="note">â† Never reached for flat data</span>
â”‚       â”‚
â”‚       â””â”€â”€ <span class="component">ReviewGroupedListControlled</span>
â”‚           â”œâ”€â”€ Props: request, state, onStateChange
â”‚           â”œâ”€â”€ <span class="function">parseGroups(data, schema)</span> <span class="note">â† LOCAL function line 38-78</span>
â”‚           â”‚   â””â”€â”€ <span style="color:#ff6b6b">âš ï¸ SAME PROBLEM</span>
â”‚           â”‚       <span style="color:#ff6b6b">Line 65: if (typeof value !== "object") continue;</span>
â”‚           â”‚
â”‚           â””â”€â”€ For each group:
â”‚               â””â”€â”€ <span class="component">SchemaFields</span>
â”‚
â”œâ”€â”€ interaction_type=<span class="string">"file_input"</span>
â”‚   â””â”€â”€ <span class="component">FileInputHost</span> <span class="note">(line 1391)</span>
â”‚       â”œâ”€â”€ State: FileInputState
â”‚       â”œâ”€â”€ Variants: [dropzone, text]
â”‚       â”‚
â”‚       â”œâ”€â”€ <span class="component">FileInputDropzoneControlled</span>
â”‚       â”‚   â”œâ”€â”€ Props: request, state, onStateChange
â”‚       â”‚   â””â”€â”€ Renders: drag-drop zone
â”‚       â”‚
â”‚       â””â”€â”€ <span class="component">FileInputTextControlled</span>
â”‚           â”œâ”€â”€ Props: request, state, onStateChange
â”‚           â””â”€â”€ Renders: text input for path
â”‚
â””â”€â”€ interaction_type=<span class="string">"file_download"</span>
    â””â”€â”€ <span class="component">FileDownloadHost</span> <span class="note">(line 1633)</span>
        â”œâ”€â”€ State: FileDownloadState
        â”‚
        â””â”€â”€ <span class="component">FileDownloadControlled</span>
            â”œâ”€â”€ Props: request, state, onStateChange
            â”œâ”€â”€ Uses: request.file_content, request.file_name
            â””â”€â”€ Auto-writes file and confirms
            </div>
        </div>

        <!-- ============================================= -->
        <h2 id="parse-schema-data">Deep Dive: parseSchemaData (groups vs flatItems)</h2>
        <!-- ============================================= -->

        <div class="flow-section">
            <h3>The Question</h3>
            <p>Both <code>StructuredSelectCardsControlled</code> and <code>StructuredSelectListControlled</code> call:</p>
<pre><code><span class="keyword">const</span> { groups, flatItems } = <span class="function">parseSchemaData</span>(data, schema);</code></pre>
            <p>What are <code>groups</code> vs <code>flatItems</code>? Are they hierarchy vs data?</p>

            <h3>The Answer: They're the SAME Data, Different Formats</h3>
            <div class="flow-box" style="border-color: #ff79c6; max-width: 100%;">
                <h4 style="color:#ff79c6;">Key Insight</h4>
                <p><code>flatItems</code> is NOT separate data from groups. Looking at schema-utils.ts:</p>
<pre><code><span class="comment">// schema-utils.ts:99-110</span>
groups.push({
  key: <span class="string">"_root"</span>,
  label: displayLabel,
  items: groupItems,     <span class="comment">// â† items are in the group</span>
  ...
});

flatItems.push(...groupItems);  <span class="comment">// â† SAME items also pushed to flatItems!</span></code></pre>
                <p><strong>They point to the same SelectableItem objects.</strong></p>
            </div>

            <h3>What Each Represents</h3>
            <table>
                <tr>
                    <th>Property</th>
                    <th>Type</th>
                    <th>Purpose</th>
                    <th>Used For</th>
                </tr>
                <tr>
                    <td><code>groups</code></td>
                    <td><code>SelectableGroup[]</code></td>
                    <td>Logical groupings based on schema structure</td>
                    <td>Rendering collapsible cards, section headers</td>
                </tr>
                <tr>
                    <td><code>flatItems</code></td>
                    <td><code>SelectableItem[]</code></td>
                    <td>All items flattened for convenience</td>
                    <td>Total count, "no items found" check</td>
                </tr>
            </table>

            <h3>Where Schema Drives Grouping</h3>
            <p>Schema determines groups through these patterns:</p>
            <div class="tree">
<span class="function">parseSchemaData(data, schema)</span>
â”‚
â”œâ”€â”€ <span class="highlight">Case 1: Root-level array</span>
â”‚   â”‚
â”‚   â”‚   schema = { type: "array", selectable: true, items: {...} }
â”‚   â”‚   data = [item1, item2, item3]
â”‚   â”‚
â”‚   â””â”€â”€ Creates: 1 group named "_root" containing all array items
â”‚       groups = [{ key: "_root", items: [item1, item2, item3] }]
â”‚       flatItems = [item1, item2, item3]
â”‚
â”œâ”€â”€ <span class="highlight">Case 2: Object with selectable additionalProperties</span>
â”‚   â”‚
â”‚   â”‚   schema = { type: "object", selectable: true, additionalProperties: {...} }
â”‚   â”‚   data = { key1: {...}, key2: {...} }
â”‚   â”‚
â”‚   â””â”€â”€ Creates: 1 group named "_root" with each key as an item
â”‚       groups = [{ key: "_root", items: [key1Item, key2Item] }]
â”‚       flatItems = [key1Item, key2Item]
â”‚
â”œâ”€â”€ <span class="highlight">Case 3a: Object with selectable array properties</span>
â”‚   â”‚
â”‚   â”‚   schema = { type: "object", properties: { ideas: { type: "array", selectable: true } } }
â”‚   â”‚   data = { ideas: [idea1, idea2] }
â”‚   â”‚
â”‚   â””â”€â”€ Creates: 1 group per selectable array property
â”‚       groups = [{ key: "ideas", label: "Ideas", items: [idea1, idea2] }]
â”‚       flatItems = [idea1, idea2]
â”‚
â””â”€â”€ <span class="highlight">Case 3b: Nested - parent array with selectable child arrays</span>
    â”‚
    â”‚   schema = {
    â”‚     type: "object",
    â”‚     properties: {
    â”‚       aesthetics: {
    â”‚         type: "array",
    â”‚         items: {
    â”‚           type: "object",
    â”‚           properties: {
    â”‚             ideas: { type: "array", <span class="highlight">selectable: true</span> }  <span class="note">â† nested selectable</span>
    â”‚           }
    â”‚         }
    â”‚       }
    â”‚     }
    â”‚   }
    â”‚   data = {
    â”‚     aesthetics: [
    â”‚       { name: "Aesthetic 1", ideas: [idea1, idea2] },
    â”‚       { name: "Aesthetic 2", ideas: [idea3, idea4] }
    â”‚     ]
    â”‚   }
    â”‚
    â””â”€â”€ Creates: 1 group per PARENT item (aesthetic), items are the CHILD array
        groups = [
          { key: "aesthetics[0]", label: "Aesthetic 1", parentData: {...}, items: [idea1, idea2] },
          { key: "aesthetics[1]", label: "Aesthetic 2", parentData: {...}, items: [idea3, idea4] }
        ]
        flatItems = [idea1, idea2, idea3, idea4]
            </div>

            <h3>TUI vs WebUI: Why Different Approaches?</h3>
            <div class="flow-row">
                <div class="flow-box server" style="flex: 1;">
                    <h4>TUI (_display_schema_data in mixins.py)</h4>
<pre><code><span class="comment"># TUI returns just a flat list</span>
selectable_items = []

<span class="comment"># TUI renders groups INLINE while iterating</span>
<span class="keyword">for</span> key, prop_schema <span class="keyword">in</span> properties.items():
    <span class="keyword">if</span> prop_schema[<span class="string">'selectable'</span>]:
        <span class="comment"># Print group header</span>
        self._log(f"â”€â”€ {display_label} â”€â”€")

        <span class="comment"># Print each item and collect</span>
        <span class="keyword">for</span> idx, item <span class="keyword">in</span> enumerate(array_data):
            self._log(f"{len(selectable_items) + 1}.")
            self._display_schema_fields(item, ...)
            selectable_items.append({...})

<span class="keyword">return</span> selectable_items  <span class="comment"># Just flat list</span></code></pre>
                    <p style="color:#ff6b6b;">TUI is <strong>sequential/imperative</strong> - print as you go.</p>
                </div>
                <div class="flow-box webui" style="flex: 1;">
                    <h4>WebUI (parseSchemaData in schema-utils.ts)</h4>
<pre><code><span class="comment">// WebUI needs structure UPFRONT for React</span>
<span class="keyword">const</span> groups: SelectableGroup[] = [];
<span class="keyword">const</span> flatItems: SelectableItem[] = [];

<span class="comment">// Build structure first, render later</span>
<span class="keyword">for</span> (<span class="keyword">const</span> [key, propSchema] <span class="keyword">of</span> entries(properties)) {
  <span class="keyword">if</span> (propSchema.selectable) {
    <span class="keyword">const</span> groupItems = items.map((item, idx) => ({
      indices: [key, idx],
      data: item,
      ...
    }));

    groups.push({
      key,
      label: displayLabel,
      items: groupItems,  <span class="comment">// Store structure</span>
    });

    flatItems.push(...groupItems);
  }
}

<span class="keyword">return</span> { groups, flatItems };  <span class="comment">// Both</span></code></pre>
                    <p style="color:#4ade80;">WebUI is <strong>declarative</strong> - need structure before rendering.</p>
                </div>
            </div>

            <h3>Data Structures (Current)</h3>
            <div class="flow-row">
                <div class="flow-box" style="flex: 1;">
                    <h4>SelectableGroup</h4>
<pre><code><span class="keyword">interface</span> SelectableGroup {
  key: <span class="string">string</span>;              <span class="comment">// "_root" or "propertyName[index]"</span>
  label: <span class="string">string</span>;            <span class="comment">// Display name from schema</span>
  schema: SchemaProperty;   <span class="comment">// Schema for items in this group</span>
  items: SelectableItem[];  <span class="comment">// The selectable items</span>
}</code></pre>
                </div>
                <div class="flow-box" style="flex: 1;">
                    <h4>SelectableItem</h4>
<pre><code><span class="keyword">interface</span> SelectableItem {
  indices: StructuredIndex;   <span class="comment">// [key, idx] or [key, parentIdx, childIdx]</span>
  data: Record;               <span class="comment">// The actual item data</span>
  schema: SchemaProperty;     <span class="comment">// Schema for this item</span>
  groupKey: <span class="string">string</span>;           <span class="comment">// Which group this belongs to</span>
}</code></pre>
                </div>
            </div>
            <p style="color:#888;font-size:12px;">Note: See "Revised Architecture" section for new schema fields (render_as, nudges, computed)</p>

            <h3>Visual: How Components Use groups vs flatItems</h3>
            <div class="tree">
<span class="component">StructuredSelectCardsControlled</span>
â”‚
â”œâ”€â”€ <span class="function">parseSchemaData(data, schema)</span>
â”‚   â””â”€â”€ Returns: { <span class="highlight">groups</span>, flatItems }
â”‚
â”œâ”€â”€ Uses <span class="highlight">groups</span> for rendering:
â”‚   â”‚
â”‚   â””â”€â”€ {groups.map(group => (
â”‚         &lt;<span class="component">GroupCard</span> key={group.key}&gt;
â”‚           &lt;CardHeader&gt;{group.label}&lt;/CardHeader&gt;
â”‚           {group.items.map(item => (
â”‚             &lt;<span class="component">SelectableItemCard</span> item={item} /&gt;
â”‚           ))}
â”‚         &lt;/GroupCard&gt;
â”‚       ))}
â”‚
â””â”€â”€ Uses flatItems only for empty check
            </div>
        </div>

        <!-- ============================================= -->
        <h2 id="revised-architecture">Revised Architecture (from Discussion)</h2>
        <!-- ============================================= -->

        <div class="flow-section">
            <h3>Key Decisions</h3>
            <table>
                <tr>
                    <th>Topic</th>
                    <th>Decision</th>
                </tr>
                <tr>
                    <td><code>selectable</code></td>
                    <td>Single code path. Prop toggles selection UI only. Visual richness identical regardless of selectable value.</td>
                </tr>
                <tr>
                    <td><code>render_as</code></td>
                    <td>New field replacing <code>format</code> for rendering. WebUI uses <code>render_as</code>, TUI uses <code>format</code> (migration planned).</td>
                </tr>
                <tr>
                    <td><code>nudges</code></td>
                    <td>Declared in schema at field level. Array of strings: ["copy", "swatch", "external-link", ...]</td>
                </tr>
                <tr>
                    <td><code>computed</code></td>
                    <td>New schema section (sibling to <code>properties</code>). Replaces <code>display_components</code> entirely.</td>
                </tr>
                <tr>
                    <td><code>display_order</code></td>
                    <td>Sorts ALL fields (properties + computed) together for display.</td>
                </tr>
                <tr>
                    <td>Errors</td>
                    <td>Inline + sidebar panel. Non-blocking unless critical. Show detailed guidance for schema authors.</td>
                </tr>
                <tr>
                    <td>Assumptions</td>
                    <td><strong>NONE.</strong> Everything explicit. Missing rendering instructions = error, not fallback.</td>
                </tr>
            </table>

            <h3>New Schema Structure</h3>
<pre><code>{
  <span class="string">"type"</span>: <span class="string">"object"</span>,
  <span class="highlight">"selectable"</span>: <span class="keyword">true</span>,  <span class="comment">// â† toggles selection UI, NOT visual richness</span>

  <span class="string">"properties"</span>: {
    <span class="string">"name"</span>: {
      <span class="string">"type"</span>: <span class="string">"string"</span>,
      <span class="string">"display"</span>: <span class="keyword">true</span>,
      <span class="string">"display_order"</span>: <span class="number">1</span>,
      <span class="string">"display_label"</span>: <span class="string">"Name"</span>
    },
    <span class="string">"hex_color"</span>: {
      <span class="string">"type"</span>: <span class="string">"string"</span>,
      <span class="string">"display"</span>: <span class="keyword">true</span>,
      <span class="string">"display_order"</span>: <span class="number">3</span>,
      <span class="highlight">"render_as"</span>: <span class="string">"color"</span>,  <span class="comment">// â† explicit rendering type</span>
      <span class="highlight">"nudges"</span>: [<span class="string">"copy"</span>, <span class="string">"swatch"</span>]  <span class="comment">// â† UI enhancements</span>
    },
    <span class="string">"website"</span>: {
      <span class="string">"type"</span>: <span class="string">"string"</span>,
      <span class="string">"display"</span>: <span class="keyword">true</span>,
      <span class="string">"display_order"</span>: <span class="number">4</span>,
      <span class="highlight">"render_as"</span>: <span class="string">"url"</span>,
      <span class="highlight">"nudges"</span>: [<span class="string">"external-link"</span>, <span class="string">"copy"</span>]
    }
  },

  <span class="highlight">"computed"</span>: {  <span class="comment">// â† NEW: virtual fields, replaces display_components</span>
    <span class="string">"_summary"</span>: {
      <span class="string">"display"</span>: <span class="keyword">true</span>,
      <span class="string">"display_order"</span>: <span class="number">2</span>,  <span class="comment">// â† can interleave with properties</span>
      <span class="string">"display_format"</span>: <span class="string">"{{ name }} ({{ hex_color }})"</span>,
      <span class="string">"render_as"</span>: <span class="string">"text"</span>,
      <span class="string">"nudges"</span>: [<span class="string">"copy"</span>]
    }
  }
}</code></pre>

            <h3>Rendering Order Example</h3>
            <p>Given the schema above, fields render in <code>display_order</code>:</p>
            <div class="tree">
1. <span class="component">name</span> (order: 1) - from properties
2. <span class="component">_summary</span> (order: 2) - from computed <span class="note">â† computed interleaved!</span>
3. <span class="component">hex_color</span> (order: 3) - from properties
4. <span class="component">website</span> (order: 4) - from properties
            </div>

            <h3>render_as Values (Initial Set)</h3>
            <table>
                <tr>
                    <th>Value</th>
                    <th>Renders As</th>
                    <th>Supported Nudges</th>
                </tr>
                <tr>
                    <td><code>text</code></td>
                    <td>Plain text</td>
                    <td>copy</td>
                </tr>
                <tr>
                    <td><code>color</code></td>
                    <td>Color swatch + hex value</td>
                    <td>copy, swatch</td>
                </tr>
                <tr>
                    <td><code>url</code></td>
                    <td>Clickable link</td>
                    <td>copy, external-link</td>
                </tr>
                <tr>
                    <td><code>datetime</code></td>
                    <td>Formatted date/time</td>
                    <td>copy</td>
                </tr>
                <tr>
                    <td><code>number</code></td>
                    <td>Formatted number</td>
                    <td>copy</td>
                </tr>
                <tr>
                    <td><code>image</code></td>
                    <td>Thumbnail/preview</td>
                    <td>preview, download</td>
                </tr>
            </table>

            <h3>Component Hierarchy (Revised)</h3>
            <div class="tree">
<span class="component">InteractionHost</span>
â”‚
â””â”€â”€ props: { request, <span class="highlight">selectable</span>: boolean }
    â”‚
    â””â”€â”€ <span class="component">UnifiedItemRenderer</span>  <span class="note">â† single component for all cases</span>
        â”‚
        â””â”€â”€ props: { data, schema, <span class="highlight">selectable</span> }
            â”‚
            â”œâ”€â”€ Collects fields from:
            â”‚   â”œâ”€â”€ schema.properties (where display: true)
            â”‚   â””â”€â”€ schema.computed (where display: true)
            â”‚
            â”œâ”€â”€ Sorts by display_order
            â”‚
            â””â”€â”€ For each field:
                â”‚
                â”œâ”€â”€ <span class="highlight">selectable=true</span>: show checkbox/radio + rich content
                â””â”€â”€ <span class="highlight">selectable=false</span>: same rich content, no selection UI
                    â”‚
                    â””â”€â”€ <span class="component">TerminalRenderer</span>
                        â”‚
                        â”œâ”€â”€ render_as: "text" â†’ <span class="component">TextRenderer</span>
                        â”œâ”€â”€ render_as: "color" â†’ <span class="component">ColorRenderer</span>
                        â”œâ”€â”€ render_as: "url" â†’ <span class="component">UrlRenderer</span>
                        â”œâ”€â”€ render_as: "datetime" â†’ <span class="component">DateTimeRenderer</span>
                        â”œâ”€â”€ render_as: "image" â†’ <span class="component">ImageRenderer</span>
                        â””â”€â”€ (unknown) â†’ <span class="component">ErrorRenderer</span> <span class="note">â† no fallback!</span>
            </div>

            <h3>ArrayField (Revised)</h3>
            <p>ArrayField is a <strong>wrapper/orchestrator</strong>, not a leaf renderer:</p>
            <div class="tree">
<span class="component">ArrayField</span>
â”‚
â”œâ”€â”€ Props: { items: unknown[], schema, selectable }
â”‚
â”œâ”€â”€ For each item in items:
â”‚   â””â”€â”€ <span class="component">SchemaField</span>(item, schema.items) <span class="note">â† recurses!</span>
â”‚
â””â”€â”€ <span style="color:#ff6b6b">OLD behavior (removed):</span>
    â”œâ”€â”€ display_format === "join" â†’ magic keyword <span class="note">â† use Jinja instead</span>
    â””â”€â”€ else â†’ numbered list [1] item <span class="note">â† use proper list component</span>
            </div>

            <h3>What Gets Removed</h3>
            <table>
                <tr>
                    <th>Remove</th>
                    <th>Replace With</th>
                </tr>
                <tr>
                    <td><code>display_components</code></td>
                    <td><code>computed</code> fields in schema</td>
                </tr>
                <tr>
                    <td><code>display_format: "join"</code> magic</td>
                    <td>Jinja: <code>{{ items | join(' ') }}</code></td>
                </tr>
                <tr>
                    <td>Separate selectable/non-selectable code paths</td>
                    <td>Single unified renderer with <code>selectable</code> prop</td>
                </tr>
                <tr>
                    <td>Implicit String(value) fallback</td>
                    <td>Explicit <code>render_as</code> required, else error</td>
                </tr>
                <tr>
                    <td><code>format</code> for rendering (WebUI)</td>
                    <td><code>render_as</code> (TUI keeps <code>format</code> for now)</td>
                </tr>
            </table>
        </div>

        <!-- ============================================= -->
        <h2 id="summary">Summary: What Needs to Change</h2>
        <!-- ============================================= -->

        <div class="flow-section">
            <h3>Original Issues (Still Valid)</h3>
            <table>
                <tr>
                    <th>Issue</th>
                    <th>File</th>
                    <th>Fix</th>
                </tr>
                <tr>
                    <td>parseGroups ignores flat data</td>
                    <td>ReviewGroupedListControlled.tsx:38-78<br>ReviewGroupedCardsControlled.tsx:42-84</td>
                    <td>Check for display:true fields first, create single "_root" group</td>
                </tr>
                <tr>
                    <td>No format-aware rendering</td>
                    <td>schema-renderer.tsx:217</td>
                    <td>Implement <code>render_as</code> switch with terminal renderers</td>
                </tr>
                <tr>
                    <td>Duplicate parseGroups logic</td>
                    <td>Both ReviewGrouped variants</td>
                    <td>Extract to schema-utils.ts as getDisplayGroups()</td>
                </tr>
            </table>

            <h3>New Changes Required</h3>
            <table>
                <tr>
                    <th>Change</th>
                    <th>Details</th>
                </tr>
                <tr>
                    <td>Add <code>computed</code> field support</td>
                    <td>Parse schema.computed, merge with properties, sort by display_order</td>
                </tr>
                <tr>
                    <td>Implement <code>render_as</code></td>
                    <td>Create terminal renderers: TextRenderer, ColorRenderer, UrlRenderer, etc.</td>
                </tr>
                <tr>
                    <td>Implement <code>nudges</code></td>
                    <td>Add nudge props to terminal renderers (copy button, external link icon, etc.)</td>
                </tr>
                <tr>
                    <td>Unify selectable/non-selectable</td>
                    <td>Single component tree, <code>selectable</code> prop controls UI only</td>
                </tr>
                <tr>
                    <td>Remove display_components</td>
                    <td>Delete DisplayComponents renderer, migrate existing to computed</td>
                </tr>
                <tr>
                    <td>Remove "join" magic</td>
                    <td>Delete special case in ArrayField</td>
                </tr>
                <tr>
                    <td>Add error rendering</td>
                    <td>ErrorRenderer for missing render_as, failed templates, etc.</td>
                </tr>
            </table>
        </div>

        <hr>
        <p style="color:#666;text-align:center;">Generated 2026-01-01 | Schema-Driven UI Architecture</p>
    </div>
</body>
</html>
