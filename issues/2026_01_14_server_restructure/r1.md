# Server Codebase Restructure Proposal

**Date:** 2026-01-14
**Status:** Proposal
**Priority:** High

---

## Summary

The server codebase has grown organically and now exhibits significant complexity issues that impact maintainability, readability, and testability. This document provides a comprehensive analysis of the current state and proposes a restructuring plan.

---

## Complexity Analysis

### Cyclomatic Complexity - High Risk Functions

| File | Function | Complexity | Rating |
|------|----------|------------|--------|
| `api/workflow_api.py` | `resume_workflow` | 21 | D (Very High) |
| `api/database_provider.py` | `get_workflow_position` | 23 | D (Very High) |
| `api/database_provider.py` | `recover_workflow` | 15 | C (High) |
| `api/database_provider.py` | `get_retry_context` | 13 | C (High) |
| `api/workflow_api.py` | `start_workflow` | 14 | C (High) |
| `api/workflow_api.py` | `compute_workflow_diff` | 14 | C (High) |
| `api/workflow_api.py` | `start_workflow_by_version` | 13 | C (High) |
| `api/workflow_api.py` | `confirm_resume_with_update` | 13 | C (High) |
| `api/workflow_api.py` | `get_all_workflows` | 12 | C (High) |
| `api/database_provider.py` | `store_event` | 11 | C (High) |
| `api/database_provider.py` | `get_lineage_events` | 11 | C (High) |

**Target:** Functions should be A (1-5) or B (6-10). Currently 11 functions exceed this.

### Maintainability Index - Problem Files

| File | Lines | MI Score | Rating |
|------|-------|----------|--------|
| `api/database_provider.py` | 2,348 | 10.36 | B (Borderline) |
| `api/workflow_api.py` | 2,167 | 10.39 | B (Borderline) |
| `api/workflow_processor.py` | 1,606 | 17.95 | B (Moderate) |

**Note:** MI scores below 20 indicate hard-to-maintain code. All three core files are concerning.

### Halstead Metrics - Largest Files

| File | Volume | Difficulty | Effort | Est. Bugs |
|------|--------|------------|--------|-----------|
| `workflow_api.py` | 2,952 | 7.9 | 23,398 | 0.98 |
| `workflow_processor.py` | 2,452 | 8.5 | 20,930 | 0.82 |
| `database_provider.py` | 2,039 | 9.7 | 19,839 | 0.68 |

---

## Architectural Issues Identified

### 1. God Objects - Files Doing Too Much

**`database_provider.py` (2,348 lines)**
Currently handles:
- User management (creation, auth, access keys)
- Workflow run CRUD
- Event sourcing and storage
- Branch/lineage management
- Module output storage and retrieval
- Token usage tracking
- File storage
- Workflow position reconstruction
- Recovery logic
- Version management (via mixins)
- Config storage (via mixins)
- History queries (via mixins)

**`workflow_api.py` (2,167 lines)**
Currently handles:
- All REST endpoints (20+ routes)
- SSE streaming setup
- State streaming
- Authentication middleware
- Workflow content resolution (zip/JSON)
- Version diff computation (imported but tightly coupled)
- File serving
- Template listing

**`workflow_processor.py` (1,606 lines)**
Currently handles:
- Workflow start/resume orchestration
- Step and module execution
- Interaction handling
- Retry/jump logic
- State management
- Response processing
- Version selection
- AI config management

### 2. Mixed Concerns in `/api/` Folder

The `/api/` folder conflates:
- HTTP layer (routes, middleware, request/response handling)
- Business logic (workflow processing, state management)
- Data access (database operations)

Current structure:
```
server/api/
├── workflow_api.py        # Routes + business logic mixed
├── workflow_processor.py  # Business logic + data access mixed
├── database_provider.py   # Data access + business logic mixed
├── models.py              # DTOs (fine)
├── auth.py                # Auth utilities (fine)
├── auth_routes.py         # Auth routes (fine)
└── migrations/            # DB migrations (fine)
```

### 3. Inconsistent Module Boundaries

- `workflow_context.py` is in `/api/` but provides execution context (belongs in `/engine/`)
- `workflow_streaming.py` is a mixin for `WorkflowProcessor` but lives separately
- Database mixins (`database_history.py`, `database_migrations.py`, `database_config.py`) pattern is good but inconsistently applied

### 4. Deep Nesting in Provider Implementations

```
server/modules/api/providers/anthropic/provider.py  (566 lines)
server/modules/api/providers/openai/provider.py     (860 lines)
```

These files are large and deeply nested. The `providers/__init__.py` pattern adds complexity.

### 5. No Clear Service Layer

Business logic is scattered between:
- Route handlers (validation, orchestration)
- Processor (execution logic)
- Database provider (query logic + some business rules)

---

## Proposed Restructure

### Phase 1: Extract Domain Services

**Goal:** Separate business logic from HTTP and data layers.

#### New Structure:
```
server/
├── api/                          # HTTP layer only
│   ├── routes/                   # Route definitions
│   │   ├── workflow_routes.py    # /workflow/* endpoints
│   │   ├── auth_routes.py        # /auth/* endpoints
│   │   ├── template_routes.py    # /workflow-templates endpoint
│   │   └── file_routes.py        # /workflow/{id}/files endpoints
│   ├── middleware/               # Request/response middleware
│   │   └── auth_middleware.py    # Authentication
│   ├── models.py                 # Request/response DTOs
│   ├── streaming.py              # SSE utilities
│   └── app.py                    # FastAPI app setup
│
├── services/                     # Business logic layer (NEW)
│   ├── workflow_service.py       # Orchestration logic
│   ├── execution_service.py      # Module execution
│   ├── state_service.py          # State management
│   ├── version_service.py        # Version selection/management
│   └── interaction_service.py    # Interaction handling
│
├── repositories/                 # Data access layer (NEW)
│   ├── base.py                   # Base repository
│   ├── workflow_repository.py    # Workflow CRUD
│   ├── event_repository.py       # Event sourcing
│   ├── user_repository.py        # User management
│   ├── version_repository.py     # Version management
│   └── file_repository.py        # File storage
│
├── engine/                       # Workflow engine (keep but refine)
│   ├── module_interface.py       # Module contracts
│   ├── module_registry.py        # Module discovery
│   ├── jinja2_resolver.py        # Parameter resolution
│   ├── workflow_resolver.py      # $ref resolution
│   ├── execution_groups.py       # Path flattening
│   └── execution_context.py      # Context for modules (moved from api/)
│
└── modules/                      # Module implementations (keep)
    └── ...
```

### Phase 2: Break Down God Objects

#### `database_provider.py` → Multiple Repositories

| Current Method Group | New Repository |
|---------------------|----------------|
| User management | `user_repository.py` |
| Workflow CRUD | `workflow_repository.py` |
| Event sourcing | `event_repository.py` |
| Version management | `version_repository.py` |
| File storage | `file_repository.py` |
| Token tracking | `usage_repository.py` |

#### `workflow_api.py` → Multiple Route Modules

| Current Endpoint Group | New Route File |
|-----------------------|----------------|
| `/workflow/start`, `/respond`, etc. | `workflow_routes.py` |
| `/workflow/{id}/stream`, `/state/stream` | `streaming_routes.py` |
| `/workflow/{id}/files` | `file_routes.py` |
| `/workflow-templates` | `template_routes.py` |

#### `workflow_processor.py` → Service Layer

| Current Responsibility | New Service |
|-----------------------|-------------|
| `start_workflow`, `resume_workflow_with_update` | `workflow_service.py` |
| `_execute_from_position`, `_execute_step_modules` | `execution_service.py` |
| `respond`, `_continue_after_interaction` | `interaction_service.py` |
| `retry`, `jump` | `navigation_service.py` |

### Phase 3: Simplify Complex Functions

Target functions with CC > 10 for extraction:

#### `get_workflow_position` (CC=23)
Extract into:
- `_compute_completed_steps()`
- `_find_pending_interaction()`
- `_calculate_module_index()`

#### `resume_workflow` (CC=21)
Extract into:
- `_validate_workflow_access()`
- `_handle_version_change()`
- `_build_resume_response()`

#### `recover_workflow` (CC=15)
Extract into:
- `_detect_inconsistent_state()`
- `_apply_recovery_action()`

### Phase 4: Flatten Provider Structure

Current:
```
modules/api/providers/anthropic/provider.py
modules/api/providers/openai/provider.py
```

Proposed:
```
modules/api/providers/
├── base.py
├── anthropic.py    # Flattened, no nested folder
├── openai.py       # Flattened, no nested folder
└── registry.py
```

---

## Implementation Order

### Step 1: Create Repository Layer (Low Risk)
1. Create `server/repositories/` folder
2. Extract `UserRepository` from `database_provider.py`
3. Extract `EventRepository` from `database_provider.py`
4. Update imports in `workflow_processor.py` and `workflow_api.py`
5. Test all workflows still work

### Step 2: Create Service Layer (Medium Risk)
1. Create `server/services/` folder
2. Extract `WorkflowService` from `workflow_processor.py`
3. Move orchestration logic from route handlers to services
4. Route handlers become thin wrappers

### Step 3: Split Route Files (Low Risk)
1. Create `server/api/routes/` folder
2. Split endpoints by domain
3. Update imports in `app.py`

### Step 4: Refactor Complex Functions (Medium Risk)
1. Apply extract-method refactoring to CC>10 functions
2. Add unit tests for extracted methods
3. Verify behavior preservation

### Step 5: Flatten Providers (Low Risk)
1. Move provider files up one level
2. Remove empty `__init__.py` files
3. Update imports

---

## Metrics Goals

After restructure:

| Metric | Current | Target |
|--------|---------|--------|
| Max file size | 2,348 lines | < 500 lines |
| Max function CC | 23 | < 10 |
| Maintainability Index (min) | 10.36 | > 40 |
| Files with MI < 20 | 3 | 0 |

---

## Risks and Mitigations

| Risk | Mitigation |
|------|------------|
| Breaking existing functionality | Incremental changes with tests at each step |
| Import path changes breaking clients | Keep backward-compatible aliases temporarily |
| Large merge conflicts | Do restructure on dedicated branch |
| Performance regression | Benchmark before/after |

---

## Questions for Review

1. Should we maintain backward-compatible imports during transition?
<!--I'm not sure what you meant by backwards compatibility. as long as server endpoints are intact and works as expected, it should be good. if there are direct console or non-api related code, they are not meant to be there.-->
2. What is the priority order for the phases?
<!--your implementation order makes sense, as long as it includes everything-->
3. Are there specific pain points to address first?
<!--no, by the time we finish all goals in this document, everything must work as it does now.-->
4. Should we add comprehensive tests before restructuring?
<!--no, unfortunately we dont have time for it atm-->
5. How do we handle the TUI/WebUI imports that depend on server structure?
<!--there shouldnt be any thing in either tui or webui which directly access server components other than api. server vs tui, all shared files has to be in /contracts, if there any other direct use, they are wrong and has to be fixed. better analyze for them upfront. there are tooling in /analyze folder to do that.-->

---

## Files Affected Summary

### Will Be Split/Refactored:
- `server/api/database_provider.py` (2,348 lines) → 6 repositories
- `server/api/workflow_api.py` (2,167 lines) → 4 route files
- `server/api/workflow_processor.py` (1,606 lines) → 4 services

### Will Be Moved:
- `server/api/workflow_context.py` → `server/engine/execution_context.py`
- `server/api/workflow_streaming.py` → `server/api/streaming.py`

### Will Be Flattened:
- `server/modules/api/providers/anthropic/` → single file
- `server/modules/api/providers/openai/` → single file
