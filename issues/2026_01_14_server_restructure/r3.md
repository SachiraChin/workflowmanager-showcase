# Server Codebase Restructure Proposal

**Date:** 2026-01-14
**Status:** In Progress
**Priority:** High
**Revision:** 3

---

## Summary

This document tracks progress on the server restructure initiative. See r1.md and r2.md for the original analysis and proposal.

---

## Progress Update

### Completed Steps

#### Step 1: Create Database Layer ✅ COMPLETED

**Commits:**
- `refactor(server): Extract UserRepository and EventRepository from DatabaseProvider`
- `refactor(server): Extract Workflow, Branch, and File repositories`
- `refactor(server): Replace DatabaseProvider with db/ module`

**Changes:**
- Created `server/db/` folder (renamed from `repositories/`)
- Created `Database` class in `db/__init__.py` - minimal connection + repo initialization
- Extracted 8 repositories:
  - `user_repository.py` - User CRUD, access keys, refresh tokens
  - `event_repository.py` - Event storage, lineage queries
  - `workflow_repository.py` - Workflow run CRUD, status updates
  - `branch_repository.py` - Branch management, lineage
  - `file_repository.py` - File storage for API calls and outputs
  - `state_repository.py` - Module outputs, workflow position, retry context
  - `token_repository.py` - Token usage tracking
  - `version_repository.py` - Workflow versions, templates, execution groups
- Moved mixins to `db/mixins/`:
  - `config.py` - Configuration storage
  - `history.py` - Option usage history
  - `migrations.py` - Branch/workflow migrations
- Moved `api/migrations/` to `db/migrations/`
- Created `server/utils.py` with shared `uuid7_str()` function
- Updated all callers to use `from db import Database, DbEventType`
- **Deleted `database_provider.py`** (1,833 lines removed)

**Results:**
- `database_provider.py`: 2,348 → 0 lines (DELETED) ✅
- Clean separation: Database class only initializes repos, no business logic

#### Step 3: Split Route Files ✅ COMPLETED

**Commit:**
- `refactor(server): Split workflow_api.py into modular route files`

**Changes:**
- Renamed `workflow_api.py` → `app.py` (minimal app setup only)
- Created `server/api/routes/` folder with domain-specific modules:
  - `execution.py` (366 lines) - Start, confirm, respond, retry
  - `streaming.py` (163 lines) - SSE execution streaming
  - `state.py` (320 lines) - State queries and streaming
  - `management.py` (517 lines) - Status, resume, events, history, delete, reset
  - `files.py` (114 lines) - File access for TUI debug mode
  - `listing.py` (153 lines) - Template and workflow listing
- Created support modules:
  - `helpers.py` (213 lines) - Shared utility functions
  - `dependencies.py` (92 lines) - FastAPI dependency injection
  - `stream_state.py` (17 lines) - Shared SSE stream tracking
  - `convertors.py` (23 lines) - Custom path convertors

**Results:**
- Original `workflow_api.py`: 2,167 → 0 lines (DELETED) ✅
- New `app.py`: 202 lines (minimal setup)

---

#### Step 2: Extract Workflow and Models Modules ✅ COMPLETED

**Commit:**
- `refactor(server): Extract workflow and models to separate modules`

**Changes:**
- Created `server/workflow/` folder with modular components:
  - `__init__.py` - Module exports
  - `processor.py` (~350 lines) - Main orchestrator, delegates to handlers
  - `executor.py` (~300 lines) - Step/module execution
  - `interaction.py` (~280 lines) - User interaction handling
  - `navigation.py` (~200 lines) - Retry/jump logic
  - `streaming.py` (~250 lines) - SSE streaming support
  - `workflow_utils.py` (~200 lines) - Workflow-specific utilities
  - `workflow_context.py` - Execution context and state proxy
- Created `server/models/` folder for shared Pydantic models:
  - `workflow.py` - WorkflowStatus, WorkflowResponse, WorkflowProgress
  - `interaction.py` - ApiInteractionType, ApiSelectOption, ApiInteractionRequest
  - `sse.py` - SSEEventType, SSEEvent
  - `requests.py` - API request models
  - `responses.py` - API response models
- Updated all imports across api/ and workflow/
- Simplified `api/__init__.py`
- **Deleted `api/workflow_processor.py`** (1,606 lines)
- **Deleted `api/workflow_streaming.py`** (367 lines)
- **Deleted `api/models.py`** (335 lines)

**Results:**
- `workflow_processor.py`: 1,606 → 0 lines (DELETED) ✅
- `workflow_streaming.py`: 367 → 0 lines (DELETED) ✅
- `models.py`: 335 → 0 lines (DELETED) ✅
- Logic split into focused components in `workflow/` and `models/`

---

#### Step 4: Consolidate Utilities and Cleanup API Structure ✅ COMPLETED

**Changes:**

**Utils Consolidation (naming convention: `{context}_utils.py`):**
- Consolidated generic utilities into `server/utils.py`:
  - `uuid7_str()` - Time-sortable UUID generation
  - `sanitize_error_message()` - Redact sensitive info from errors
  - `make_json_serializable()` - Convert objects for JSON serialization
  - `get_nested_value()` - Dot-notation dict access
- Renamed `api/helpers.py` → `api/api_utils.py` (API-specific utilities)
- Renamed `workflow/helpers.py` → `workflow/workflow_utils.py` (workflow-specific utilities)
- Kept `engine/context_utils.py` (already followed pattern)
- **Deleted `api/utils.py`** (merged into root utils.py)

**Route Restructuring:**
- Moved `api/auth_routes.py` → `api/routes/auth.py`
- Updated `api/app.py` to import from `routes.auth`
- Added `auth` to `routes/__init__.py` exports

**Workflow Module Consolidation:**
- Moved `api/workflow_context.py` → `workflow/workflow_context.py`
- Updated imports in `workflow/executor.py` and `workflow/interaction.py`

**Stream State Merge:**
- Merged `api/stream_state.py` into `api/routes/streaming.py`
- `active_streams` and `active_state_streams` now defined in streaming.py
- Updated imports in `api/app.py` and `api/routes/state.py`
- **Deleted `api/stream_state.py`**

**Results:**
- Consistent naming: all utility files follow `{context}_utils.py` pattern
- No more scattered helper/utils files
- Auth routes properly organized in routes/ folder
- Workflow-related code consolidated in workflow/ folder
- Stream state co-located with streaming routes

---

### Remaining Steps

#### Step 5: Flatten Providers - DEFERRED

**Decision:** Keep current folder structure.

The existing structure with separate folders per provider is better for future expansion:
```
providers/
├── anthropic/
│   ├── provider.py
│   └── models.json
└── openai/
    ├── provider.py
    └── models.json
```

This allows each provider to have its own configuration files and keeps provider-specific code isolated.

---

## Future Improvements

### Refactor workflow/ Module Structure
The initial extraction to `server/workflow/` creates a basic structure but could be improved:

1. **Further decomposition of executor.py**
   - `execute_from_position` and `execute_step_modules` are still large methods
   - Consider breaking into smaller, more focused functions

2. **Further decomposition of interaction.py**
   - `continue_after_interaction` is still a large method (~200 lines)
   - Context creation logic is duplicated with executor.py
   - Consider extracting context factory

3. **Review navigation.py design**
   - `handle_retry_from_response` duplicates module lookup logic
   - Jump and retry share similar patterns - consider unifying
   - Branch creation logic could be extracted

4. **Simplify processor.py orchestrator**
   - `start_workflow` is still ~120 lines with version selection logic
   - Version selection/resolution could be extracted to version_service.py
   - Services dict construction is repeated - extract to factory

5. **Consider state machine pattern**
   - Workflow execution is essentially a state machine
   - Could formalize states and transitions for clarity

5. **Add comprehensive tests**
   - Unit tests for each workflow component
   - Integration tests for the full execution flow

---

## Current Metrics

### File Sizes

| File | Original | Current | Target |
|------|----------|---------|--------|
| `database_provider.py` | 2,348 | 0 (DELETED) | ✅ |
| `workflow_api.py` | 2,167 | 0 (DELETED) | ✅ |
| `app.py` | - | 202 | < 500 ✅ |
| `workflow_processor.py` | 1,606 | 0 (DELETED) | ✅ |
| `workflow_streaming.py` | 367 | 0 (DELETED) | ✅ |
| `models.py` | 335 | 0 (DELETED) | ✅ |

### Workflow Module Structure

| File | Lines | Purpose |
|------|-------|---------|
| `workflow/processor.py` | ~350 | Main orchestrator |
| `workflow/executor.py` | ~300 | Step/module execution |
| `workflow/interaction.py` | ~280 | User interaction handling |
| `workflow/streaming.py` | ~250 | SSE streaming support |
| `workflow/navigation.py` | ~200 | Retry/jump logic |
| `workflow/workflow_utils.py` | ~200 | Workflow-specific utilities |
| `workflow/workflow_context.py` | ~170 | Execution context, state proxy |

### Models Module Structure

| File | Lines | Purpose |
|------|-------|---------|
| `models/workflow.py` | ~45 | WorkflowStatus, WorkflowResponse, WorkflowProgress |
| `models/interaction.py` | ~100 | ApiInteractionType, ApiSelectOption, ApiInteractionRequest |
| `models/sse.py` | ~35 | SSEEventType, SSEEvent |
| `models/requests.py` | ~85 | API request models |
| `models/responses.py` | ~55 | API response models |

### Database Layer Structure

| File | Lines | Purpose |
|------|-------|---------|
| `db/__init__.py` | ~150 | Database class, exports |
| `db/state_repository.py` | ~300 | Module outputs, position |
| `db/version_repository.py` | ~380 | Versions, templates |
| `db/event_repository.py` | ~250 | Event sourcing |
| `db/workflow_repository.py` | ~280 | Workflow CRUD |
| `db/branch_repository.py` | ~180 | Branch management |
| `db/user_repository.py` | ~280 | User CRUD |
| `db/file_repository.py` | ~230 | File storage |
| `db/token_repository.py` | ~100 | Token tracking |

### Route Module Sizes

| Module | Lines | Purpose |
|--------|-------|---------|
| `routes/management.py` | 517 | Status, resume, events, history |
| `routes/execution.py` | 366 | Start, confirm, respond, retry |
| `routes/state.py` | 320 | State queries and streaming |
| `routes/streaming.py` | ~180 | SSE streaming + stream state |
| `routes/listing.py` | 153 | Template and workflow listing |
| `routes/files.py` | 114 | File access for TUI debug |
| `routes/auth.py` | ~300 | Authentication endpoints |
| `dependencies.py` | 92 | FastAPI dependency injection |
| `convertors.py` | 23 | Custom path convertors |
| `api_utils.py` | ~210 | API-specific utilities |

### Utility Files

| File | Lines | Purpose |
|------|-------|---------|
| `server/utils.py` | ~100 | Generic utilities (uuid7, sanitize, serialize) |
| `api/api_utils.py` | ~210 | API-specific (workflow resolution, AI config) |
| `workflow/workflow_utils.py` | ~200 | Workflow-specific (interaction conversion) |
| `engine/context_utils.py` | ~70 | Context validation utilities |

---

## Next Priority

**Further Refactoring** (Future)

The major restructure is complete. Remaining improvements are incremental:

1. **Decompose large methods** - executor.py and interaction.py have large methods
2. **Extract context factory** - Context creation logic is duplicated
3. **Add comprehensive tests** - Unit tests for each component

---

## Files Changed Summary

### Created:
- `server/db/` (9 repository files + base)
- `server/db/mixins/` (3 mixin files)
- `server/db/migrations/` (moved from api/)
- `server/utils.py` - Generic utilities
- `server/api/routes/` (7 route files including auth.py)
- `server/api/app.py`
- `server/api/api_utils.py` - API-specific utilities
- `server/api/dependencies.py`
- `server/api/convertors.py`
- `server/workflow/` (8 workflow component files)
- `server/workflow/workflow_utils.py` - Workflow-specific utilities
- `server/workflow/workflow_context.py` - Execution context
- `server/models/` (5 model files)

### Deleted:
- `server/api/database_provider.py` (1,833 lines)
- `server/api/workflow_api.py` (2,167 lines)
- `server/api/workflow_processor.py` (1,606 lines)
- `server/api/workflow_streaming.py` (367 lines)
- `server/api/models.py` (335 lines)
- `server/api/utils.py` (merged into root utils.py)
- `server/api/helpers.py` (renamed to api_utils.py)
- `server/api/auth_routes.py` (moved to routes/auth.py)
- `server/api/stream_state.py` (merged into routes/streaming.py)
- `server/api/workflow_context.py` (moved to workflow/)
- `server/workflow/helpers.py` (renamed to workflow_utils.py)
- `server/repositories/` (renamed to db/)

### Current API Structure:
```
server/api/
├── __init__.py
├── app.py              # FastAPI app setup
├── api_utils.py        # API-specific utilities
├── auth.py             # Auth logic (JWT, cookies)
├── contract_validation.py
├── convertors.py       # Custom path convertors
├── dependencies.py     # FastAPI dependencies
├── workflow_diff.py    # Workflow version diffing
└── routes/
    ├── __init__.py
    ├── auth.py         # Auth endpoints
    ├── execution.py    # Start, respond, retry
    ├── files.py        # File access
    ├── listing.py      # Template listing
    ├── management.py   # Status, events, history
    ├── state.py        # State queries
    └── streaming.py    # SSE streaming + stream state
```

### Current Workflow Structure:
```
server/workflow/
├── __init__.py
├── executor.py         # Step/module execution
├── interaction.py      # User interaction handling
├── navigation.py       # Retry/jump logic
├── processor.py        # Main orchestrator
├── streaming.py        # SSE streaming support
├── workflow_context.py # Execution context
└── workflow_utils.py   # Workflow utilities
```
