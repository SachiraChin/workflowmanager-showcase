# Server Codebase Restructure Proposal

**Date:** 2026-01-14
**Status:** In Progress
**Priority:** High
**Revision:** 3

---

## Summary

This document tracks progress on the server restructure initiative. See r1.md and r2.md for the original analysis and proposal.

---

## Progress Update

### Completed Steps

#### Step 1: Create Repository Layer ✅ COMPLETED

**Commits:**
- `refactor(server): Extract UserRepository and EventRepository from DatabaseProvider`
- `refactor(server): Extract Workflow, Branch, and File repositories`

**Changes:**
- Created `server/repositories/` folder
- Extracted 5 repositories:
  - `user_repository.py` (280 lines) - User CRUD, access keys, refresh tokens
  - `event_repository.py` (278 lines) - Event storage, lineage queries
  - `workflow_repository.py` (277 lines) - Workflow run CRUD, status updates
  - `branch_repository.py` (188 lines) - Branch management, lineage
  - `file_repository.py` (235 lines) - File storage for API calls and outputs
- Created `base.py` with shared repository base class
- Updated all callers to use `db.user_repo.*`, `db.workflow_repo.*`, etc.
- **No backward-compatible wrappers** - callers updated directly

**Results:**
- `database_provider.py`: 2,348 → 1,833 lines (515 lines removed)

#### Step 3: Split Route Files ✅ COMPLETED

**Commit:**
- `refactor(server): Split workflow_api.py into modular route files`

**Changes:**
- Renamed `workflow_api.py` → `app.py` (minimal app setup only)
- Created `server/api/routes/` folder with domain-specific modules:
  - `execution.py` (366 lines) - Start, confirm, respond, retry
  - `streaming.py` (163 lines) - SSE execution streaming
  - `state.py` (320 lines) - State queries and streaming
  - `management.py` (517 lines) - Status, resume, events, history, delete, reset
  - `files.py` (114 lines) - File access for TUI debug mode
  - `listing.py` (153 lines) - Template and workflow listing
- Created support modules:
  - `helpers.py` (213 lines) - Shared utility functions
  - `dependencies.py` (92 lines) - FastAPI dependency injection
  - `stream_state.py` (17 lines) - Shared SSE stream tracking
  - `convertors.py` (23 lines) - Custom path convertors

**Results:**
- Original `workflow_api.py`: 2,167 lines (single file)
- New structure: 6 route modules + 4 support modules
- Largest module: `management.py` at 517 lines

---

### Remaining Steps

#### Step 2: Create Service Layer (Pending)
- Create `server/services/` folder
- Extract services from `workflow_processor.py`:
  - `WorkflowService` - Orchestration logic
  - `ExecutionService` - Module execution
  - `InteractionService` - Interaction handling
  - `NavigationService` - Retry/jump logic

#### Step 4: Refactor Complex Functions (Pending)
- Extract methods from high-CC functions:
  - `get_workflow_position` (CC=23) → multiple smaller functions
  - `resume_workflow` (CC=21) → validation, version check, response building
  - `recover_workflow` (CC=15) → detection, recovery

#### Step 5: Flatten Providers (Pending)
- Flatten `modules/api/providers/anthropic/` to single file
- Flatten `modules/api/providers/openai/` to single file

---

## Current Metrics

### File Sizes

| File | Original | Current | Target |
|------|----------|---------|--------|
| `database_provider.py` | 2,348 | 1,833 | < 500 |
| `workflow_api.py` | 2,167 | 202 (app.py) | < 500 ✅ |
| `workflow_processor.py` | 1,606 | 1,606 | < 500 |

### Route Module Sizes

| Module | Lines |
|--------|-------|
| `management.py` | 517 |
| `execution.py` | 366 |
| `state.py` | 320 |
| `helpers.py` | 213 |
| `streaming.py` | 163 |
| `listing.py` | 153 |
| `files.py` | 114 |
| `dependencies.py` | 92 |
| `convertors.py` | 23 |
| `stream_state.py` | 17 |

---

## Next Priority

**Simplify WorkflowProcessor** (Step 4 partial)

The user indicated WorkflowProcessor has significant logic that's hard to follow. Before creating a full service layer, we should:

1. Identify high-complexity sections in `workflow_processor.py`
2. Extract methods to reduce function-level complexity
3. Add clear documentation for the execution flow

This can be done without the full service layer refactor.

---

## Files Changed Summary

### Created:
- `server/repositories/` (6 files)
- `server/api/routes/` (7 files)
- `server/api/app.py`
- `server/api/helpers.py`
- `server/api/dependencies.py`
- `server/api/stream_state.py`
- `server/api/convertors.py`

### Modified:
- `server/api/database_provider.py` (reduced 515 lines)
- `server.py` (import path updated)
- `server/api/__init__.py` (import path updated)
- Various modules updated to use repository methods

### Deleted:
- `server/api/workflow_api.py` (replaced by app.py + routes/)
