# Server Codebase Restructure Proposal

**Date:** 2026-01-14
**Status:** In Progress
**Priority:** High
**Revision:** 3

---

## Summary

This document tracks progress on the server restructure initiative. See r1.md and r2.md for the original analysis and proposal.

---

## Progress Update

### Completed Steps

#### Step 1: Create Database Layer ✅ COMPLETED

**Commits:**
- `refactor(server): Extract UserRepository and EventRepository from DatabaseProvider`
- `refactor(server): Extract Workflow, Branch, and File repositories`
- `refactor(server): Replace DatabaseProvider with db/ module`

**Changes:**
- Created `server/db/` folder (renamed from `repositories/`)
- Created `Database` class in `db/__init__.py` - minimal connection + repo initialization
- Extracted 8 repositories:
  - `user_repository.py` - User CRUD, access keys, refresh tokens
  - `event_repository.py` - Event storage, lineage queries
  - `workflow_repository.py` - Workflow run CRUD, status updates
  - `branch_repository.py` - Branch management, lineage
  - `file_repository.py` - File storage for API calls and outputs
  - `state_repository.py` - Module outputs, workflow position, retry context
  - `token_repository.py` - Token usage tracking
  - `version_repository.py` - Workflow versions, templates, execution groups
- Moved mixins to `db/mixins/`:
  - `config.py` - Configuration storage
  - `history.py` - Option usage history
  - `migrations.py` - Branch/workflow migrations
- Moved `api/migrations/` to `db/migrations/`
- Created `server/utils.py` with shared `uuid7_str()` function
- Updated all callers to use `from db import Database, DbEventType`
- **Deleted `database_provider.py`** (1,833 lines removed)

**Results:**
- `database_provider.py`: 2,348 → 0 lines (DELETED) ✅
- Clean separation: Database class only initializes repos, no business logic

#### Step 3: Split Route Files ✅ COMPLETED

**Commit:**
- `refactor(server): Split workflow_api.py into modular route files`

**Changes:**
- Renamed `workflow_api.py` → `app.py` (minimal app setup only)
- Created `server/api/routes/` folder with domain-specific modules:
  - `execution.py` (366 lines) - Start, confirm, respond, retry
  - `streaming.py` (163 lines) - SSE execution streaming
  - `state.py` (320 lines) - State queries and streaming
  - `management.py` (517 lines) - Status, resume, events, history, delete, reset
  - `files.py` (114 lines) - File access for TUI debug mode
  - `listing.py` (153 lines) - Template and workflow listing
- Created support modules:
  - `helpers.py` (213 lines) - Shared utility functions
  - `dependencies.py` (92 lines) - FastAPI dependency injection
  - `stream_state.py` (17 lines) - Shared SSE stream tracking
  - `convertors.py` (23 lines) - Custom path convertors

**Results:**
- Original `workflow_api.py`: 2,167 → 0 lines (DELETED) ✅
- New `app.py`: 202 lines (minimal setup)

---

### Remaining Steps

#### Step 2: Create Service Layer (Pending)
- Create `server/services/` folder
- Extract services from `workflow_processor.py`:
  - `WorkflowService` - Orchestration logic
  - `ExecutionService` - Module execution
  - `InteractionService` - Interaction handling
  - `NavigationService` - Retry/jump logic

#### Step 4: Refactor Complex Functions (Pending)
- Extract methods from high-CC functions in `workflow_processor.py`:
  - `resume_workflow` (CC=21) → validation, version check, response building
  - Various nested conditionals → smaller focused functions

#### Step 5: Flatten Providers (Pending)
- Flatten `modules/api/providers/anthropic/` to single file
- Flatten `modules/api/providers/openai/` to single file

---

## Current Metrics

### File Sizes

| File | Original | Current | Target |
|------|----------|---------|--------|
| `database_provider.py` | 2,348 | 0 (DELETED) | ✅ |
| `workflow_api.py` | 2,167 | 0 (DELETED) | ✅ |
| `app.py` | - | 202 | < 500 ✅ |
| `workflow_processor.py` | 1,606 | 1,606 | < 500 |

### Database Layer Structure

| File | Lines | Purpose |
|------|-------|---------|
| `db/__init__.py` | ~150 | Database class, exports |
| `db/state_repository.py` | ~300 | Module outputs, position |
| `db/version_repository.py` | ~380 | Versions, templates |
| `db/event_repository.py` | ~250 | Event sourcing |
| `db/workflow_repository.py` | ~280 | Workflow CRUD |
| `db/branch_repository.py` | ~180 | Branch management |
| `db/user_repository.py` | ~280 | User CRUD |
| `db/file_repository.py` | ~230 | File storage |
| `db/token_repository.py` | ~100 | Token tracking |

### Route Module Sizes

| Module | Lines |
|--------|-------|
| `management.py` | 517 |
| `execution.py` | 366 |
| `state.py` | 320 |
| `helpers.py` | 213 |
| `streaming.py` | 163 |
| `listing.py` | 153 |
| `files.py` | 114 |
| `dependencies.py` | 92 |
| `convertors.py` | 23 |
| `stream_state.py` | 17 |

---

## Next Priority

**Simplify WorkflowProcessor** (Step 4)

The `workflow_processor.py` file remains at 1,606 lines and contains complex logic. Options:

1. **Extract to services** (Step 2) - Create dedicated service classes
2. **Break down methods** - Split large methods into smaller functions
3. **Document flow** - Add clear documentation for execution paths

---

## Files Changed Summary

### Created:
- `server/db/` (9 repository files + base)
- `server/db/mixins/` (3 mixin files)
- `server/db/migrations/` (moved from api/)
- `server/utils.py`
- `server/api/routes/` (6 route files)
- `server/api/app.py`
- `server/api/helpers.py`
- `server/api/dependencies.py`
- `server/api/stream_state.py`
- `server/api/convertors.py`

### Deleted:
- `server/api/database_provider.py` (1,833 lines)
- `server/api/workflow_api.py` (2,167 lines)
- `server/repositories/` (renamed to db/)

### Modified:
- `server/api/__init__.py` (imports from db)
- `server/api/workflow_processor.py` (imports from db)
- `server/api/workflow_streaming.py` (imports from db)
- `server/api/workflow_context.py` (imports from db)
