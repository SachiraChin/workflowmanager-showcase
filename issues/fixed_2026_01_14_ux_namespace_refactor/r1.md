# Issue: UX Namespace Refactor (`_ux`)

## Summary

Refactor display/rendering schema properties into a dedicated `_ux` namespace to cleanly separate JSON Schema validation concerns from UI rendering concerns. This enables extensible per-renderer configuration (e.g., `expanded`, `gap`) without cluttering the schema root.

## Motivation

Currently, UX properties live at the schema node root alongside JSON Schema properties (`type`, `properties`, `items`). This causes:

1. **Mixing concerns**: Validation schema mixed with rendering hints
2. **Limited extensibility**: Adding renderer-specific config (e.g., `card.expanded`) requires more root-level fields
3. **No clear boundary**: Hard to know which properties are for validation vs rendering

---

## Complete UX Properties Inventory

Based on comprehensive scan of all 85 JSON files in workflows/:

### Core Display Properties
| Property | Count | Values/Examples |
|----------|-------|-----------------|
| `display` | 300+ | `true`, `false`, `"visible"`, `"hidden"`, `"passthrough"` |
| `display_label` | 150+ | `"Duration"`, `"Style"`, `"Tone"` |
| `display_format` | 25+ | Jinja2 templates: `"{{ value \| join(', ') }}"` |
| `display_order` | 30+ | Integers: `1`, `2`, `3` |
| `display_mode` | 15+ | `"review"` |

### Rendering Properties
| Property | Count | Values/Examples |
|----------|-------|-----------------|
| `render_as` | 80+ | `"card"`, `"section"`, `"table"`, `"content-panel"`, `"card-stack"`, `"section-list"`, `"card-title"`, `"card-subtitle"`, `"section-title"`, `"section-badge"`, `"section-summary"`, `"column"` |
| `nudges` | 20+ | `["index-badge"]`, `["swatch"]` |
| `computed` | 5+ | Object with nested UX properties for dynamic fields |

### Visual Emphasis Properties
| Property | Count | Values/Examples |
|----------|-------|-----------------|
| `highlight` | 45+ | `true` |
| `highlight_color` | 25+ | `"#FF6B6B"`, `"#7CFFB2"`, `"#FFD93D"`, `"#4ECDC4"`, `"#7B68EE"` |

### Interaction Properties
| Property | Count | Values/Examples |
|----------|-------|-----------------|
| `selectable` | 40+ | `true` |

### Form Properties (WebUI only)
| Property | Count | Values/Examples |
|----------|-------|-----------------|
| `input_schema` | 3+ | Object containing form definition |
| `input_type` | 5+ | `"counter"` |
| `form_type` | 2+ | `"table"` |
| `enum_labels` | 2+ | `{ "w": "With person", "q": "Without person" }` |

---

## Schema File Categorization

### Server Schemas (Pure JSON Schema - DO NOT TOUCH)
These contain NO UX properties and are used for LLM output validation:

```
cc/steps/2_scene_generation/schemas/scene_concepts_schema.json
cc/steps/3_image_prompts/schemas/cc_image_prompts_schema.json
cc/steps/4_video_prompts/schemas/cc_video_prompts_schema.json
cc/steps/5_text_overlays/schemas/cc_text_overlays_schema.json
cc/steps/6_titles_social/schemas/cc_titles_social_schema.json
cc/steps/7_music/schemas/cc_elevenlabs_schema.json
cc/steps/7_music/schemas/cc_music_options_schema.json
oms/steps/1_user_input/schemas/aesthetic_concepts_schema.json
oms/steps/1_user_input/schemas/aesthetic_enrichment_schema.json
oms/steps/1_user_input/schemas/aesthetic_summaries_schema.json
oms/steps/1_user_input/schemas/scene_expansion_schema.json
oms/steps/2_prompt_generation/schemas/leonardo_schema.json
oms/steps/2_prompt_generation/schemas/midjourney_schema.json
oms/steps/2_prompt_generation/schemas/sora_schema.json
oms/steps/2_prompt_generation/schemas/stable_diffusion_schema.json
oms/steps/3_image_analysis/schemas/image_analysis_schema.json
oms/steps/4_video_prompt_generation/schemas/midjourney_animate_schema.json
oms/steps/4_video_prompt_generation/schemas/motion_2_0_schema.json
oms/steps/5_text_overlays/schemas/text_generation_schema.json
oms/steps/6_titles_descriptions/schemas/titles_descriptions_schema.json
oms/steps/7_text_colors/schemas/color_combinations_schema.json
oms/steps/8_music_generation/schemas/elevenlabs_schemas_schema.json
oms/steps/8_music_generation/schemas/music_options_schema.json
```

### Display Schemas (Have UX properties - WILL MIGRATE)
These contain UX properties and need `_ux` namespace migration:

```
# OMS Display Schemas
oms/steps/1_user_input/schemas/aesthetic_display_schema.json
oms/steps/1_user_input/schemas/aesthetic_form_schema.json  (hybrid: display + form)
oms/steps/1_user_input/schemas/brightness_display_schema.json
oms/steps/1_user_input/schemas/duration_display_schema.json
oms/steps/1_user_input/schemas/motion_strength_display_schema.json
oms/steps/1_user_input/schemas/theme_display_schema.json
oms/steps/1_user_input/schemas/tone_display_schema.json
oms/steps/1_user_input/schemas/visual_style_display_schema.json
oms/steps/2_prompt_generation/schemas/leonardo_display_schema.json
oms/steps/2_prompt_generation/schemas/midjourney_display_schema.json
oms/steps/2_prompt_generation/schemas/model_groups_display_schema.json
oms/steps/2_prompt_generation/schemas/prompts_display_wrapper_schema.json
oms/steps/2_prompt_generation/schemas/sora_display_schema.json
oms/steps/2_prompt_generation/schemas/stable_diffusion_display_schema.json
oms/steps/4_video_prompt_generation/schemas/midjourney_animate_display_schema.json
oms/steps/4_video_prompt_generation/schemas/motion_2_0_display_schema.json
oms/steps/4_video_prompt_generation/schemas/motion_anchors_display_schema.json
oms/steps/4_video_prompt_generation/schemas/video_prompts_display_wrapper_schema.json
oms/steps/5_text_overlays/schemas/paragraph_display_schema.json
oms/steps/6_titles_descriptions/schemas/descriptions_display_schema.json
oms/steps/6_titles_descriptions/schemas/titles_display_schema.json
oms/steps/7_text_colors/schemas/color_display_schema.json
oms/steps/7_text_colors/schemas/text_placement_schema.json  (misnamed - is a display schema)
oms/steps/8_music_generation/schemas/elevenlabs_display_schema.json
oms/steps/8_music_generation/schemas/music_options_display_schema.json

# CC Display Schemas
cc/steps/1_user_input/schemas/cc_aesthetic_display_schema.json
cc/steps/1_user_input/schemas/cc_duration_display_schema.json
cc/steps/1_user_input/schemas/pet_type_display_schema.json
cc/steps/2_scene_generation/schemas/scene_display_schema.json
cc/steps/3_image_prompts/schemas/cc_image_prompts_display_schema.json
cc/steps/4_video_prompts/schemas/cc_video_prompts_display_schema.json
cc/steps/5_text_overlays/schemas/cc_text_overlays_display_schema.json
cc/steps/6_titles_social/schemas/cc_descriptions_display_schema.json
cc/steps/6_titles_social/schemas/cc_titles_display_schema.json
cc/steps/7_music/schemas/cc_music_options_display_schema.json
```

### Step Files with Inline Schemas
Some step.json files have inline display schemas:
```
cc/steps/7_music/step.json (has inline schema with display_mode, render_as, nudges)
```

---

## Proposed Format

Support two formats (both allowed, `_ux` object takes precedence):

### Format 1: Object namespace
```json
{
  "type": "array",
  "_ux": {
    "display": "visible",
    "render_as": "card-stack",
    "nudges": ["index-badge"],
    "card": {
      "expanded": false
    }
  },
  "items": { ... }
}
```

### Format 2: Dot-notation (flat)
```json
{
  "type": "array",
  "_ux.display": "visible",
  "_ux.render_as": "card-stack",
  "items": { ... }
}
```

### Backwards Compatibility
Legacy format (root-level properties) continues to work via normalization utility.

---

## Implementation Checklist

### Phase 1: WebUI - Core Infrastructure

- [ ] **1.1** Create `webui/src/components/workflow/interactions/schema-interaction/ux-utils.ts`
  - `getUx(schema)` - normalizes schema to UX config
  - `UxConfig` type definition
  - Checks: `_ux` object → `_ux.*` flat → legacy root-level
  - Properties to extract:
    - `display`
    - `display_label`
    - `display_format`
    - `display_order`
    - `display_mode`
    - `render_as`
    - `nudges`
    - `selectable`
    - `highlight`
    - `highlight_color`
    - `computed`
    - `input_schema`
    - `input_type`
    - `form_type`
    - `enum_labels`

- [ ] **1.2** Update `types.ts`
  - Add `UxConfig` interface
  - Add `_ux?: UxConfig` to `SchemaProperty`
  - Add index signature for `_ux.*` properties

### Phase 2: WebUI - Core Renderers

- [ ] **2.1** Update `SchemaRenderer.tsx`
  - Import `getUx`
  - Replace `schema.render_as` → `ux.render_as`
  - Replace `schema.display_format` → `ux.display_format`
  - Replace `schema.display_label` → `ux.display_label`
  - Replace `schema.nudges` → `ux.nudges`

- [ ] **2.2** Update `ArraySchemaRenderer.tsx`
  - Replace `schema.display` → `ux.display`
  - Replace `schema.render_as` → `ux.render_as`

- [ ] **2.3** Update `ObjectSchemaRenderer.tsx`
  - Replace `schema.display` → `ux.display`
  - Replace `schema.render_as` → `ux.render_as`
  - Replace `schema.display_order` → `ux.display_order`
  - Update child wrapper data-* attributes to use `ux.*`

- [ ] **2.4** Update `TableSchemaRenderer.tsx`
  - Replace all `schema.*` UX property accesses with `ux.*`

- [ ] **2.5** Update `ContentPanelSchemaRenderer.tsx`
  - Replace `schema.display_label` → `ux.display_label`

### Phase 3: WebUI - Layouts

- [ ] **3.1** Update `layouts/CardLayout.tsx`
  - Replace `schema.nudges` → `ux.nudges`
  - Replace `schema.display_label` → `ux.display_label`

- [ ] **3.2** Update `layouts/SectionLayout.tsx`
  - Replace `schema.display_label` → `ux.display_label`

- [ ] **3.3** Update `layouts/DefaultLayout.tsx`
  - No direct UX property access (uses useSelectable)

- [ ] **3.4** Update `layouts/registry.tsx`
  - Update comments/docs if needed

### Phase 4: WebUI - Helpers & Hooks

- [ ] **4.1** Update `useSelectable.ts`
  - Replace `schema.display_label` → `ux.display_label`
  - Replace `schema.selectable` → `ux.selectable`

- [ ] **4.2** Update `helpers/extractInnerData.ts`
  - Replace `schema.display` → `ux.display`
  - Replace `schema.display_order` → `ux.display_order`

- [ ] **4.3** Update `helpers/getRenderer.ts`
  - Replace `schema.render_as` → `ux.render_as`

- [ ] **4.4** Update `SelectableItem.tsx`
  - Replace `schema.display_label` → `ux.display_label`

### Phase 5: WebUI - Terminal Renderers

- [ ] **5.1** Update `renderers/TerminalRenderer.tsx`
  - Verify no direct schema UX access (receives props)

- [ ] **5.2** Update `renderers/layouts/CardRenderer.tsx`
  - Replace `schema.display_label` → `ux.display_label`

- [ ] **5.3** Update `renderers/layouts/SectionRenderer.tsx`
  - Replace `schema.display_label` → `ux.display_label`

- [ ] **5.4** Update `renderers/layouts/CardContentRenderer.tsx`
  - Replace `schema.display_label` → `ux.display_label`
  - Replace `schema.display_format` → `ux.display_format`

### Phase 6: TUI - Infrastructure

- [ ] **6.1** Create `tui/strategies/ux_utils.py`
  - `get_ux(schema)` - normalizes schema to UX config dict
  - Checks: `_ux` dict → `_ux.*` flat → legacy root-level
  - Properties: `display`, `display_format`, `display_label`, `selectable`, `display_mode`

### Phase 7: TUI - Strategies

- [ ] **7.1** Update `tui/strategies/mixins.py`
  - Import `get_ux`
  - Replace all `schema.get('display_format')` → `ux.get('display_format')`
  - Replace all `schema.get('display_label')` → `ux.get('display_label')`
  - Replace all `schema.get('selectable')` → `ux.get('selectable')`
  - Replace all `items_schema.get(...)` with `get_ux(items_schema).get(...)`
  - Replace all `prop_schema.get(...)` with `get_ux(prop_schema).get(...)`

- [ ] **7.2** Update `tui/strategies/select_structured.py`
  - Import `get_ux`
  - Update any direct schema property access

- [ ] **7.3** Update `tui/strategies/review_grouped.py`
  - Import `get_ux`
  - Replace `group_prop_schema.get('display_label')` → `ux.get('display_label')`

### Phase 8: Cleanup Legacy Code (Optional)

- [ ] **8.1** Remove `SchemaRenderer.old.tsx` if no longer needed
- [ ] **8.2** Update JSDoc/comments to document `_ux` namespace

---

## Files Affected

### WebUI (~15 files)
```
webui/src/components/workflow/interactions/schema-interaction/
├── ux-utils.ts (NEW)
├── types.ts
├── SchemaRenderer.tsx
├── ArraySchemaRenderer.tsx
├── ObjectSchemaRenderer.tsx
├── TableSchemaRenderer.tsx
├── ContentPanelSchemaRenderer.tsx
├── SelectableItem.tsx
├── useSelectable.ts
├── layouts/
│   ├── CardLayout.tsx
│   ├── SectionLayout.tsx
│   └── DefaultLayout.tsx
├── helpers/
│   ├── extractInnerData.ts
│   └── getRenderer.ts
└── renderers/layouts/
    ├── CardRenderer.tsx
    ├── SectionRenderer.tsx
    └── CardContentRenderer.tsx
```

### TUI (~4 files)
```
tui/strategies/
├── ux_utils.py (NEW)
├── mixins.py
├── select_structured.py
└── review_grouped.py
```

---

## Testing Strategy

1. **After each phase**: Run `npm run build` (WebUI) or import check (TUI)
2. **After WebUI complete**: Test OMS workflow steps 1-3 in browser
3. **After TUI complete**: Test OMS workflow step 1 in terminal
4. **Verify backwards compat**: Existing workflow schemas should work unchanged

---

## Fixed Issues

- [x] Fixed `display_as` typo → `render_as` in `paragraph_display_schema.json`

---

## Priority

**Medium** - Improves architecture but not blocking. Can be done incrementally.

---

## Notes

- Workflows do NOT need to be migrated immediately - backwards compatibility is maintained
- Future workflow schema changes can adopt `_ux` format gradually
- The `expanded` feature that motivated this can be added after Phase 3 completes
- Server schemas (pure JSON Schema) should NOT be modified

---

## Plan of Action (POA)

### Execution Order

**Session 1: WebUI Infrastructure + Core Renderers**
1. Create `ux-utils.ts` with `getUx()` and `UxConfig` type (Phase 1.1)
2. Update `types.ts` with new interfaces (Phase 1.2)
3. Update core renderers one by one, testing build after each:
   - SchemaRenderer.tsx (Phase 2.1)
   - ArraySchemaRenderer.tsx (Phase 2.2)
   - ObjectSchemaRenderer.tsx (Phase 2.3)
   - TableSchemaRenderer.tsx (Phase 2.4)
   - ContentPanelSchemaRenderer.tsx (Phase 2.5)
4. Run `npm run build` - verify no errors
5. Commit: "feat(schema-interaction): Add _ux namespace infrastructure and update core renderers"

**Session 2: WebUI Layouts + Helpers**
1. Update layouts:
   - CardLayout.tsx (Phase 3.1)
   - SectionLayout.tsx (Phase 3.2)
   - DefaultLayout.tsx (Phase 3.3) - verify no changes needed
2. Update helpers and hooks:
   - useSelectable.ts (Phase 4.1)
   - extractInnerData.ts (Phase 4.2)
   - getRenderer.ts (Phase 4.3)
   - SelectableItem.tsx (Phase 4.4)
3. Run `npm run build` - verify no errors
4. Test in browser - OMS steps 1-3
5. Commit: "feat(schema-interaction): Update layouts and helpers to use _ux namespace"

**Session 3: WebUI Terminal Renderers**
1. Update terminal renderers:
   - TerminalRenderer.tsx (Phase 5.1) - verify
   - CardRenderer.tsx (Phase 5.2)
   - SectionRenderer.tsx (Phase 5.3)
   - CardContentRenderer.tsx (Phase 5.4)
2. Run `npm run build` - verify no errors
3. Full browser test - all OMS steps
4. Commit: "feat(schema-interaction): Update terminal renderers to use _ux namespace"

**Session 4: TUI (if needed)**
1. Create `ux_utils.py` (Phase 6.1)
2. Update strategies:
   - mixins.py (Phase 7.1)
   - select_structured.py (Phase 7.2)
   - review_grouped.py (Phase 7.3)
3. Test in terminal
4. Commit: "feat(tui): Add _ux namespace support to TUI strategies"

### Rollback Plan

If issues arise:
- Each commit is atomic and reversible
- `getUx()` provides backwards compatibility - existing schemas continue to work
- Can revert individual file changes without breaking the system

### Success Criteria

- [ ] All existing workflows render identically (no visual changes)
- [ ] Build passes with no TypeScript errors
- [ ] New `_ux` namespace format works when tested manually
- [ ] Legacy root-level properties still work (backwards compat)
