# Issue: Unified Validation Strategy (Client + Server)

## Summary

The validation system needs a unified approach across client (WebUI/TUI) and server (io.validate module). Currently:
- Server uses `io.validate` with JSON schema validation
- WebUI has ad-hoc client-side validation
- TUI uses pattern-based validation
- No shared schema or error format

This issue merges the concerns from client-side validation and io.validate scope into a single unified validation strategy using standard JSON Schema libraries.

## Architecture Reference

- [R5 Part 6](../architecture/2026_01_06_aesthetic_selection_ux/r5.md): "Validation with `io.validate` Module" - Server-side specification
- [R5 Part 4](../architecture/2026_01_06_aesthetic_selection_ux/r5.md): "Generic `user.form` Module" - Form schema structure
- [R9](../architecture/2026_01_06_aesthetic_selection_ux/r9.md): References io.validate module design

## JSON Schema 2020-12 Examples

### Example 1: Aesthetic Form Input Schema

Schema for validating user input in the aesthetic selection form:

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "type": "array",
  "items": {
    "type": "object",
    "properties": {
      "count": {
        "type": "integer",
        "minimum": 0,
        "maximum": 10,
        "default": 0
      },
      "mode": {
        "type": "string",
        "enum": ["q", "w", "e"],
        "default": "e"
      }
    },
    "required": ["count", "mode"]
  }
}
```

**Validates:**
```json
[
  {"count": 2, "mode": "w"},
  {"count": 0, "mode": "e"},
  {"count": 4, "mode": "q"}
]
```

**Error examples:**
- `{"count": -1, "mode": "w"}` → `"path": "/0/count", "message": "-1 is less than the minimum of 0"`
- `{"count": 2, "mode": "x"}` → `"path": "/0/mode", "message": "'x' is not one of ['q', 'w', 'e']"`
- `{"count": 2}` → `"path": "/0", "message": "'mode' is a required property"`

### Example 2: Execution Group Output Schema

Schema for validating state at group exit (used by io.validate). **Primary purpose**: Ensure each execution path (webui_path, tui_path) writes data to state with correct structure and field names, regardless of which path was taken.

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "type": "object",
  "properties": {
    "aesthetic_selections": {
      "type": "array",
      "description": "Must exist and be an array",
      "items": {
        "type": "object",
        "properties": {
          "aesthetic": {
            "type": "object",
            "description": "Must contain the original aesthetic object",
            "properties": {
              "id": {"type": "string", "minLength": 1},
              "label": {"type": "string", "minLength": 1}
            },
            "required": ["id", "label"],
            "additionalProperties": true
          },
          "mode": {
            "type": "string",
            "description": "Must be one of the valid mode values",
            "enum": ["with_person", "without_person", "both"]
          },
          "with_count": {"type": "integer"},
          "without_count": {"type": "integer"},
          "total_count": {"type": "integer"}
        },
        "required": ["aesthetic", "mode", "total_count"],
        "additionalProperties": false
      }
    },
    "total_concepts_required": {
      "type": "integer",
      "description": "Must be set by the execution group"
    },
    "aesthetic_prompt_sections": {
      "type": "string",
      "description": "Rendered prompt text for LLM"
    }
  },
  "required": ["aesthetic_selections", "total_concepts_required", "aesthetic_prompt_sections"]
}
```

**Key validations (structure over values):**
1. **Required state keys exist**: `aesthetic_selections`, `total_concepts_required`, `aesthetic_prompt_sections`
2. **Correct field names**: Each item has `aesthetic`, `mode`, `total_count` (not `count`, `type`, etc.)
3. **Correct nested structure**: `aesthetic` contains `id` and `label`
4. **No extra fields**: `additionalProperties: false` catches typos like `totla_count`

**Error examples (structure/naming issues):**
- Missing state key: `"path": "", "message": "'aesthetic_selections' is a required property"`
- Wrong field name: `"path": "/aesthetic_selections/0", "message": "'mode' is a required property"` (if wrote `person_mode` instead)
- Missing nested field: `"path": "/aesthetic_selections/0/aesthetic", "message": "'id' is a required property"`
- Typo in field: `"path": "/aesthetic_selections/0", "message": "Additional properties are not allowed ('totla_count' was unexpected)"`

**Validates state like:**
```json
{
  "aesthetic_selections": [
    {
      "aesthetic": {"id": "futuristic", "label": "Futuristic"},
      "mode": "with_person",
      "with_count": 2,
      "without_count": 0,
      "total_count": 2
    }
  ],
  "total_concepts_required": 2,
  "aesthetic_prompt_sections": "## Futuristic\n..."
}
```

### Example 3: Conditional Validation

Schema with conditional rules - require `with_count` only when mode includes "with":

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "type": "object",
  "properties": {
    "mode": {
      "type": "string",
      "enum": ["with_person", "without_person", "both"]
    },
    "with_count": {"type": "integer", "minimum": 0},
    "without_count": {"type": "integer", "minimum": 0}
  },
  "allOf": [
    {
      "if": {
        "properties": {"mode": {"enum": ["with_person", "both"]}}
      },
      "then": {
        "properties": {
          "with_count": {"minimum": 1}
        }
      }
    },
    {
      "if": {
        "properties": {"mode": {"enum": ["without_person", "both"]}}
      },
      "then": {
        "properties": {
          "without_count": {"minimum": 1}
        }
      }
    }
  ]
}
```

### Example 4: Nested Object with $ref

Schema using references for reusable definitions:

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$defs": {
    "aesthetic": {
      "type": "object",
      "properties": {
        "id": {"type": "string", "minLength": 1},
        "label": {"type": "string", "minLength": 1},
        "description": {"type": "string"}
      },
      "required": ["id", "label"]
    },
    "count_range": {
      "type": "integer",
      "minimum": 0,
      "maximum": 10
    }
  },
  "type": "object",
  "properties": {
    "aesthetic": {"$ref": "#/$defs/aesthetic"},
    "count": {"$ref": "#/$defs/count_range"},
    "mode": {
      "type": "string",
      "enum": ["q", "w", "e"]
    }
  },
  "required": ["aesthetic", "count", "mode"]
}
```

### Example 5: String Format Validation

Schema with format validation (email, date, uuid):

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "type": "object",
  "properties": {
    "email": {
      "type": "string",
      "format": "email"
    },
    "created_date": {
      "type": "string",
      "format": "date"
    },
    "request_id": {
      "type": "string",
      "format": "uuid"
    },
    "webhook_url": {
      "type": "string",
      "format": "uri"
    }
  }
}
```

**Note:** Format validation requires explicit opt-in:
- Python: `Draft202012Validator(schema, format_checker=draft202012_format_checker)`
- Ajv: `new Ajv2020({ formats: true })` or add `ajv-formats` package

## Current State

### Server-Side (io.validate)

From `server/modules/io/validate.py`:
- Uses Python `jsonschema` library
- Auto-generated by flattener at group exit
- Validates state keys against schema
- Throws `ModuleExecutionError` on failure

### Client-Side (WebUI)

From `webui/src/components/interactions/FormInteraction.tsx`:
- Custom validation logic
- Uses `input_schema` from form definition
- Inconsistent error format with server

### Client-Side (TUI)

From `tui/workflow_runner.py`:
- Uses `validation_pattern` regex for text input
- No form validation (TUI doesn't support forms)

### Workarounds in Workflows

From `workflows/oms/steps/1_user_input/modules/07_aesthetic_selection_group.json`:
```json
{
  "module_id": "io.write_state",
  "inputs": {
    "values": {
      "aesthetic_selection_valid": true,
      "aesthetic_selection_errors": []
    }
  }
}
```

Manual validation state because io.validate doesn't output validation status.

## Proposed Solution: JSON Schema 2020-12 Libraries

Use standard JSON Schema 2020-12 compliant libraries on both client and server to ensure consistent validation behavior.

### Why JSON Schema 2020-12?

1. **Industry Standard**: Widely adopted, well-documented specification
2. **Library Support**: Mature libraries exist for both Python and TypeScript
3. **Same Schema, Same Results**: Identical validation behavior across platforms
4. **Rich Validation**: Supports complex schemas (conditionals, references, formats)
5. **Standard Error Format**: Libraries provide consistent error structures

### Python: jsonschema Library

[jsonschema](https://pypi.org/project/jsonschema/) (v4.26.0) - The standard Python JSON Schema implementation.

```python
from jsonschema import Draft202012Validator
from jsonschema.exceptions import ValidationError

def validate_data(data: dict, schema: dict) -> tuple[bool, list[dict]]:
    """
    Validate data against JSON Schema 2020-12.

    Returns:
        (is_valid, errors) - errors is list of {path, message}
    """
    validator = Draft202012Validator(schema)
    errors = []

    for error in validator.iter_errors(data):
        errors.append({
            "path": "/" + "/".join(str(p) for p in error.path),
            "message": error.message,
            "keyword": error.validator
        })

    return len(errors) == 0, errors
```

**Features:**
- Full Draft 2020-12 support
- Format validation (email, date, uuid, etc.) with `format_checker`
- Detailed error messages with JSON path to invalid field
- Schema composition ($ref, allOf, oneOf, anyOf)

**Documentation:** [python-jsonschema.readthedocs.io](https://python-jsonschema.readthedocs.io/)

### TypeScript: Ajv Library

[Ajv](https://ajv.js.org/) (Another JSON Validator) - The fastest JSON validator for Node.js and browser.

```typescript
import Ajv2020 from "ajv/dist/2020";
import addFormats from "ajv-formats";
import type { ErrorObject } from "ajv";

const ajv = new Ajv2020({ allErrors: true });
addFormats(ajv);  // Enable format validation

interface ValidationResult {
  valid: boolean;
  errors: Array<{
    path: string;
    message: string;
    keyword: string;
  }>;
}

export function validateData(data: unknown, schema: object): ValidationResult {
  const validate = ajv.compile(schema);
  const valid = validate(data);

  if (valid) {
    return { valid: true, errors: [] };
  }

  const errors = (validate.errors || []).map((err: ErrorObject) => ({
    path: err.instancePath || "/",
    message: err.message || "Validation error",
    keyword: err.keyword
  }));

  return { valid: false, errors };
}
```

**Features:**
- Full Draft 2020-12 support (import from `ajv/dist/2020`)
- TypeScript type guards for validated data
- Compiled validators for performance
- Same error structure can be normalized to match Python

**Documentation:** [ajv.js.org](https://ajv.js.org/)

### Unified Error Format

Both libraries output errors that can be normalized to:

```typescript
interface ValidationError {
  path: string;          // JSON pointer to invalid field (e.g., "/items/0/count")
  message: string;       // Human-readable error message
  keyword: string;       // Schema keyword that failed (e.g., "minimum", "required")
}
```

### Implementation Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                     JSON Schema 2020-12                         │
│                   (Single Source of Truth)                      │
└─────────────────────────────────────────────────────────────────┘
                              │
          ┌───────────────────┼───────────────────┐
          │                   │                   │
          ▼                   ▼                   ▼
   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
   │   WebUI     │    │    TUI      │    │   Server    │
   │   (Ajv)     │    │ (jsonschema)│    │ (jsonschema)│
   └─────────────┘    └─────────────┘    └─────────────┘
          │                   │                   │
          └───────────────────┼───────────────────┘
                              │
                              ▼
                 ┌─────────────────────────┐
                 │  Normalized Error Format │
                 │  { path, message, ... }  │
                 └─────────────────────────┘
```

### Validation Flow

```
User Input
    │
    ▼
┌─────────────────────────────────────┐
│ Client-Side Validation (Ajv)        │
│ - Real-time on field blur           │
│ - Block submit if errors            │
│ - Show inline error messages        │
└─────────────────────────────────────┘
    │
    │ (only if client validation passes)
    ▼
┌─────────────────────────────────────┐
│ Server-Side Validation (jsonschema) │
│ - io.validate at group exit         │
│ - Final authority                   │
│ - May catch edge cases client missed│
└─────────────────────────────────────┘
    │
    ▼
Continue Workflow
```

## Files Affected

### New/Modified Files

1. **contracts/validation.py** - Shared validation wrapper
   ```python
   from jsonschema import Draft202012Validator

   def validate_against_schema(data, schema) -> ValidationResult:
       """Normalize jsonschema output to standard format."""
   ```

2. **webui/src/lib/validation.ts** - Ajv wrapper with normalized output
   ```typescript
   import Ajv2020 from "ajv/dist/2020";

   export function validateAgainstSchema(data, schema): ValidationResult
   ```

3. **server/modules/io/validate.py** - Use contracts/validation.py
   - Add `output_state` option to return validation result instead of throwing

4. **server/modules/user/form.py** - Use contracts/validation.py for input validation

5. **webui/src/components/interactions/FormInteraction.tsx** - Use lib/validation.ts

### Package Dependencies

**Python (requirements.txt):**
```
jsonschema>=4.20.0  # Already likely present
```

**WebUI (package.json):**
```json
{
  "dependencies": {
    "ajv": "^8.12.0",
    "ajv-formats": "^2.1.1"
  }
}
```

## Implementation Steps

### Phase 1: Create Validation Wrappers

1. Create `contracts/validation.py` with normalized interface
2. Create `webui/src/lib/validation.ts` with same interface
3. Add unit tests for both ensuring identical behavior

### Phase 2: Update Server Modules

1. Update `io.validate` to use `contracts/validation.py`
2. Add `output_state` option for non-throwing validation
3. Update `user.form` to use shared validation

### Phase 3: Update WebUI

1. Replace ad-hoc validation with `lib/validation.ts`
2. Add real-time validation on field blur
3. Normalize error display format

### Phase 4: Update TUI (Optional)

1. TUI can use `contracts/validation.py` for text input validation
2. Pattern validation can coexist with schema validation

## Priority

**Medium**

**Justification:**
- Workarounds exist but add complexity
- Using standard libraries reduces maintenance burden
- Ensures consistent validation across all clients
- Foundation for future form types

## Testing Plan

1. Create test schema covering all JSON Schema 2020-12 features used
2. Run identical test cases through Python and TypeScript validators
3. Verify error format matches between platforms
4. Test edge cases: empty values, type coercion, nested objects
5. Integration test with user.form module
6. End-to-end test WebUI form submission

## References

- [JSON Schema Draft 2020-12 Specification](https://json-schema.org/draft/2020-12)
- [Python jsonschema Documentation](https://python-jsonschema.readthedocs.io/)
- [Ajv JSON Schema Validator](https://ajv.js.org/)
- [Ajv TypeScript Guide](https://ajv.js.org/guide/typescript.html)
