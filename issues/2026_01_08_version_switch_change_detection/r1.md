# Issue: Version Switch Missing Change Detection Logic

<!--i think we go for solution 1, but in lesser priority, when we come to fix this, will do it fully. until that, lets not touch it. -->

## Summary

When a user resumes a workflow run after a new workflow version is uploaded, the system should detect whether changes occurred before, at, or after the current step and handle accordingly. This logic is specified in R11 but not implemented.

## Architecture Reference

- **R11 Part 3**: "Workflow Version Switch with Change Detection" - Full specification
- **R10 Feedback Point 2**: "Version switch too simple - Need to detect WHERE changes are"

## Expected Behavior (from R11)

### Change Detection Logic

```python
def detect_workflow_changes(
    old_workflow: dict,
    new_workflow: dict,
    current_step_id: str,
    current_module_name: str
) -> dict:
    """
    Compare workflows and categorize changes relative to current position.

    Returns:
        {
            "changes_before_current": [...],  # Changes that affect past execution
            "changes_at_current": [...],      # Changes to current step/module
            "changes_after_current": [...],   # Changes that only affect future
            "can_proceed_safely": bool
        }
    """
```

### Resume Flow Behavior

1. If changes are **only after** current step → proceed automatically
2. If changes are **before or at** current step → warn user, let them decide
3. User can choose: "Continue with new version" or "Stay on current version"

### API Response for Confirmation Required

```json
{
  "status": "confirm_required",
  "message": "Workflow has been updated with changes to completed steps.",
  "changes": {
    "before_current": [...],
    "at_current": [],
    "after_current": [...]
  },
  "options": [
    {"value": "switch", "label": "Continue with new version"},
    {"value": "keep_current", "label": "Stay on current version"}
  ]
}
```

## Actual Behavior

### Current Implementation (server/api/workflow_processor.py)

The `resume_workflow_with_update()` function exists but:
1. Does NOT detect where changes occurred
2. Does NOT categorize changes (before/at/after current step)
3. Does NOT prompt user for confirmation when changes affect completed steps
4. Simply switches to new resolution if client capabilities match

### Missing Components

1. `detect_workflow_changes()` function - not implemented
2. `compare_steps()` helper function - not implemented
3. `confirm_version_switch()` handler - not implemented
4. Change categorization logic - not implemented

## Root Cause Analysis

### Why the Discrepancy Exists

1. **Incremental Development**: The resolution switching mechanism was implemented first (R8-R9), with change detection deferred to R11.

2. **Complexity**: Change detection requires comparing module structures across workflows, which is non-trivial.

3. **Lower Priority**: Basic resume functionality works; change detection is an enhancement for edge cases.

### Current Workaround

Users who upload a new workflow version mid-run:
- Resume always uses new version (if capabilities match)
- No warning about potentially invalidated state
- May encounter unexpected behavior if changes affected completed steps

## Impact

### User Experience Impact

1. **Silent State Invalidation**: Changes to completed steps may invalidate existing state without warning
2. **Unexpected Behavior**: User may see inconsistent results if new version expects different state
3. **No Rollback Option**: User cannot choose to stay on current version

### Risk Level

**Low to Medium**:
- Only affects users who update workflows mid-run
- Basic resume functionality works correctly
- Most users complete runs before updating workflows

## Proposed Solution(s)

### Solution 1: Implement Full R11 Specification

Add complete change detection as specified:

1. **Add `detect_workflow_changes()` function**
   - Compare old and new workflow step by step
   - Categorize changes by position relative to current step
   - Return structured change information

2. **Modify resume flow**
   - Call change detection before switching resolution
   - If `can_proceed_safely` is True, proceed automatically
   - If False, return confirmation-required response

3. **Add confirmation endpoint**
   - `/workflow/{run_id}/confirm-version-switch`
   - Accept user's choice (switch or keep_current)
   - Apply chosen behavior

### Solution 2: Simple Warning (Minimal)

Add a simple check without full categorization:

```python
def resume_with_version_check(workflow_run_id, client_capabilities):
    # Check if version changed
    if new_source_id != current_source_id:
        # Log warning
        logger.warning(f"Workflow version changed during run {workflow_run_id}")

        # Return advisory in response
        return {
            "action": "proceed_with_warning",
            "warning": "Workflow has been updated since this run started. Some state may be affected.",
            "workflow": new_workflow
        }
```

This doesn't block execution but informs the user.

## Files Affected

1. **server/api/workflow_processor.py** - Add change detection logic to resume flow
2. **server/api/routes/workflow.py** - Add confirmation endpoint if implementing full solution
3. **webui/src/components/WorkflowRunner.tsx** - Handle confirmation-required response
4. **tui/workflow_runner.py** - Handle confirmation-required response

## Priority

**Low**

**Justification:**
- Edge case scenario (update workflow mid-run)
- Basic functionality works
- No data loss - just potential for unexpected behavior
- Can be implemented as enhancement after critical issues resolved

## Testing Plan

1. Start workflow run, pause mid-execution
2. Upload new workflow version with changes before current step
3. Resume and verify confirmation prompt appears
4. Test "switch" choice - verify new version used
5. Test "keep_current" choice - verify old version continues
6. Test with changes only after current step - verify auto-proceed
