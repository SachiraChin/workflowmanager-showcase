# Issue: Execution Groups Not Displayed Correctly in Workflow State Tree - R2

## Summary

When a workflow contains `pipeline.execution_groups` modules, the WebUI Workflow State tree view cannot display grouped modules correctly. Modules from execution groups should be shown nested under their parent group with x.y numbering.

## R1 Feedback Incorporated

1. **Build tree from raw definition** - Start from raw workflow structure (what user created), find expanded modules in flattened definition
2. **Generic expansion detection** - Use `_metadata.expanded_from` instead of checking specific module IDs
3. **Consolidate into _metadata** - Move `_group_origin` inside `_metadata` for consistency

---

## Plan of Action (POA)

### Phase 0: Server-side Metadata Consolidation

**File:** `server/engine/execution_groups.py`

Refactor `_group_origin` to be inside `_metadata` with generic `expanded_from` field:

**Before (lines 177-185):**
```python
for i, inner_module in enumerate(selected_group.get("modules", [])):
    inner_copy = copy.deepcopy(inner_module)
    inner_copy["_group_origin"] = {
        "group_name": group_name,
        "path_name": selected_path_name,
        "requires": group_requires,
        "module_index": i
    }
    new_modules.append(inner_copy)
```

**After:**
```python
for i, inner_module in enumerate(selected_group.get("modules", [])):
    inner_copy = copy.deepcopy(inner_module)
    # Add expansion metadata (generic field for any meta-module)
    inner_copy["_metadata"] = {
        **inner_copy.get("_metadata", {}),
        "expanded_from": group_name,    # Generic - parent module name
        "expanded_index": i,            # Order within expansion
        # Detailed context for this specific expansion type
        "_group_origin": {
            "group_name": group_name,
            "path_name": selected_path_name,
            "requires": group_requires,
        }
    }
    new_modules.append(inner_copy)
```

**Also update validator module (lines 221-234):**
```python
return {
    "module_id": "io.validate",
    "name": f"_{group_name}_validator",
    "inputs": {
        "schema": output_schema,
        "state_keys": state_keys
    },
    "_metadata": {
        "expanded_from": group_name,
        "expanded_index": -1,  # Indicates auto-generated at end
        "_group_origin": {
            "group_name": group_name,
            "path_name": path_name,
            "is_group_exit": True,
            "auto_generated": True
        }
    }
}
```

**Breaking change:** Requires deleting existing resolved workflow versions (they have old `_group_origin` format).

---

### Phase 1: Types Update

**File:** `webui/src/lib/types.ts`

```typescript
// Add to types
export interface GroupOrigin {
  group_name: string;
  path_name: string;
  requires?: Array<{ capability: string; priority: number }>;
  is_group_exit?: boolean;
  auto_generated?: boolean;
}

export interface ModuleMetadata {
  expanded_from?: string;      // Parent module name this was expanded from
  expanded_index?: number;     // Order within expansion
  _group_origin?: GroupOrigin; // Detailed expansion context
  [key: string]: unknown;      // Allow other metadata
}

// Update ModuleConfig
export interface ModuleConfig {
  module_id: string;
  name?: string;
  inputs?: Record<string, unknown>;
  outputs_to_state?: Record<string, string>;
  retryable?: Record<string, unknown>;
  comment?: string;
  _metadata?: ModuleMetadata;  // NEW
}
```

---

### Phase 2: API Response Update

**File:** `webui/src/lib/api.ts`

```typescript
async getWorkflowDefinition(workflowRunId: string): Promise<{
  workflow_run_id: string;
  version_id: string;
  definition: WorkflowDefinition;
  raw_definition?: WorkflowDefinition;  // NEW - present for resolved versions
}>
```

---

### Phase 3: Context Update

**File:** `webui/src/contexts/WorkflowStateContext.tsx`

1. Store both definitions:
```typescript
interface WorkflowStateContextValue {
  // ... existing fields
  workflowDefinition: WorkflowDefinition | null;     // flattened
  rawWorkflowDefinition: WorkflowDefinition | null;  // raw (NEW)
  getModuleConfig: (stepId: string, moduleName: string) => ModuleConfig | null;
  getRawModuleConfig: (stepId: string, moduleName: string) => ModuleConfig | null;  // NEW
}
```

2. Update fetch to store both:
```typescript
api.getWorkflowDefinition(workflowRunId).then((response) => {
  setWorkflowDefinition(response.definition);
  setRawWorkflowDefinition(response.raw_definition || null);
});
```

3. Add `getRawModuleConfig` for looking up group configs from raw definition

---

### Phase 4: StateTreeView Grouping Logic

**File:** `webui/src/components/workflow/state/StateTreeView.tsx`

**Algorithm - Build from raw definition:**

```typescript
interface ModuleTreeNode {
  module: ModuleConfig;
  isGroup: boolean;
  children: ModuleConfig[];  // Expanded modules (from flattened)
  groupIndex: number;        // Position in step (for numbering)
}

function buildModuleTree(
  rawModules: ModuleConfig[],
  flattenedModules: ModuleConfig[]
): ModuleTreeNode[] {
  return rawModules.map((rawModule, index) => {
    // Find modules expanded from this raw module
    const children = flattenedModules
      .filter(m => m._metadata?.expanded_from === rawModule.name)
      .sort((a, b) =>
        (a._metadata?.expanded_index ?? 0) - (b._metadata?.expanded_index ?? 0)
      );

    return {
      module: rawModule,
      isGroup: children.length > 0,
      children,
      groupIndex: index,
    };
  });
}
```

**Numbering:**
- Regular modules: `{index + 1}.` (e.g., "1.", "2.")
- Group nodes: `{index + 1}.` (e.g., "1.")
- Grouped child modules: `{groupIndex + 1}.{childIndex + 1}` (e.g., "1.1", "1.2")

**Config lookup:**
- Group node gear → `getRawModuleConfig(stepId, groupName)` - shows execution_groups definition
- Child module gear → `getModuleConfig(stepId, moduleName)` - shows resolved module from flattened
- Regular module gear → `getRawModuleConfig(stepId, moduleName)` - shows raw module config

---

### Phase 5: Tree Rendering Updates

**File:** `webui/src/components/workflow/state/StateTreeView.tsx`

1. Add `[group]` badge for group nodes
2. Update `TreeNode` to handle nested children
3. Pass `isGroupChild` and `parentIndex` props for x.y numbering
4. Update gear icon handler to use correct config lookup

---

## Files Affected

| File | Changes |
|------|---------|
| `server/engine/execution_groups.py` | Move `_group_origin` into `_metadata`, add `expanded_from` |
| `webui/src/lib/types.ts` | Add `GroupOrigin`, `ModuleMetadata`, update `ModuleConfig` |
| `webui/src/lib/api.ts` | Add `raw_definition` to response type |
| `webui/src/contexts/WorkflowStateContext.tsx` | Store both definitions, add `getRawModuleConfig` |
| `webui/src/components/workflow/state/StateTreeView.tsx` | Build grouped tree, nested rendering, x.y numbering |

---

## Database Cleanup Required

Before testing, delete all resolved workflow versions (they have old `_group_origin` format at top level instead of inside `_metadata`).

---

## Testing Checklist

- [ ] Modules without groups display normally with simple numbering
- [ ] Group modules show as expandable nodes with `[group]` badge
- [ ] Child modules nested under group with x.y numbering
- [ ] Gear on group shows execution_groups config (paths, requires, etc.)
- [ ] Gear on child module shows resolved module config (inputs, outputs)
- [ ] Gear on regular module shows raw config
- [ ] Search works across grouped structure
- [ ] Auto-generated validator modules shown with indicator
