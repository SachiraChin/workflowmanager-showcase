# Issue: Flawed Workflow Version Selection Logic

## Summary

The current workflow version selection logic is fundamentally flawed. The API automatically picks the "latest" workflow version, but with the introduction of flattened versions (from resolution selection), this causes the wrong version to be selected and resolution matching to fail.

## Root Cause

`get_latest_workflow_version` returns whichever version was created most recently, regardless of `source_type`. This means it can return a flattened version instead of the original source version. When this happens:

1. The workflow run is created with a flattened version ID as `current_workflow_version_id`
2. Resolution selection looks for resolutions where `source_workflow_version_id` matches
3. No match is found because resolutions have the ORIGINAL source version as `source_workflow_version_id`, not the flattened version
4. Workflow runs with the wrong path (e.g., TUI path instead of WebUI path)

## Operator Requirements

> why are we using workflow_template_name here? user see the list of workflows in ui, that list come from server. here's the big issue, from the beginning, this logic was flawed where api automatically picks the latest workflow version when. but now we have different types of versions, it come to make things worse for us.
>
> so, lets fix these one by one. in UI, user can select any any raw version of the workflow. UI should be
> - {workflow-template-name}
>   |- version-{created_date(users tz):yyyy-MM-dd hh:mm:ss (PM/AM)}
>   |- version-{created_date(users tz):yyyy-MM-dd hh:mm:ss (PM/AM)}
>
> note, this api returns data, ui decide how to render it. for now, lets show latest 20 workflow versions. also note, the versions are ONLY raw versions, or old full version. Flattened ones not sent here.
>
> - User select specific version, send that to server.
> - no auto pick or assume workflow version, server KNOWS its workflow without other versions, or raw version with other flattened versions
> - if there are no flattend versions, server start workflow with provided version, if flattened, server pick correct flattened verision, and start the workflow with that.

## Implementation Plan

### 1. API Changes

**New/Modified Endpoints:**

- `GET /workflow-templates` - Returns templates with their raw versions (latest 20)
  - Each template includes list of source versions (exclude `source_type: flattened`)
  - Include `workflow_version_id`, `created_at`, `content_hash` for each version

- `POST /workflow/start` - Require explicit `workflow_version_id`
  - Remove auto-pick logic
  - Server validates the version exists and is a source version (not flattened)
  - Server handles resolution selection internally using the provided version

### 2. Server Logic Changes

When starting a workflow with a specific version:
1. Validate the provided `workflow_version_id` is a source version (not flattened)
2. Check if resolutions exist for this version
3. If no resolutions exist: start workflow with the provided version as-is
4. If resolutions exist: select appropriate flattened version based on capabilities, start with that

### 3. WebUI Changes

- Update workflow template selector to show versions
- Display format: `version-{created_date:yyyy-MM-dd hh:mm:ss (PM/AM)}` (user's timezone)
- Send selected `workflow_version_id` in start request

## Files Affected

- `server/api/workflow_api.py` - Modify start endpoint, update template listing
- `server/api/database_history.py` - Add method to get source versions for template
- `server/api/models.py` - Update request models
- `webui/src/hooks/useWorkflowExecution.ts` - Send version ID
- `webui/src/components/workflow/WorkflowSelector.tsx` - Show version picker
- `webui/src/lib/types.ts` - Update types

## Priority

**Critical** - This blocks correct resolution selection for WebUI vs TUI paths.
