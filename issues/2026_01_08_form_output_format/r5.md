# Issue: user.form Output Format Missing `_item` and `_index`

## Summary

The `user.form` module does not include `_item` (original data item) and `_index` (position in source array) in its output. This document focuses ONLY on the output enrichment concern - validation is a separate concern handled elsewhere.

## Architecture Reference

- [R5 Part 4](../architecture/2026_01_06_aesthetic_selection_ux/r5.md): "Generic `user.form` Module" - Output structure specification
- [R5 Part 7](../architecture/2026_01_06_aesthetic_selection_ux/r5.md): "Complete Example" - Shows webui_path with only 2 modules

## Scope Clarification

This issue is **ONLY** about output enrichment:
- Add `_item` (original data object) to each output item
- Add `_index` (position in source array) to each output item

This issue is **NOT** about validation:
- Client-side validation → handled by WebUI using `input_schema` + Ajv (see unified_validation issue)
- Server-side validation → handled by `io.validate` module at group exit
- `user.form` should NOT contain validation logic

## The Generic Module Principle

All modules must work everywhere. This means:

```
┌─────────────────────────────────────────────────────────────────┐
│                         user.form                               │
│                                                                 │
│  Responsibility: Collect user input, enrich with context        │
│                                                                 │
│  Input:  data[], schema                                         │
│  Output: form_data[] with _item, _index                         │
│                                                                 │
│  Does NOT: Validate, filter, transform, compute                 │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        io.validate                              │
│                                                                 │
│  Responsibility: Validate state against schema                  │
│                                                                 │
│  Auto-added at group exit OR explicitly placed                  │
└─────────────────────────────────────────────────────────────────┘
```

## Validation Strategy (Separate Concern)

### Where Validation Happens

| Layer | What Validates | How |
|-------|---------------|-----|
| Client (WebUI) | Input before submit | Ajv + `input_schema` |
| Client (TUI) | Text patterns | `validation_pattern` regex |
| Server (io.validate) | State at group exit | jsonschema + `output_schema` |

### Why NOT in user.form

1. **Duplication**: Client already validates before submit
2. **Inflexibility**: Hardcoded validation can't be customized per workflow
3. **Violation**: Modules should be single-responsibility
4. **Inconsistency**: Other user.* modules don't embed validation

## Proposed Solution

### Minimal user.form Changes

```python
def execute_with_response(
    self,
    inputs: Dict[str, Any],
    context,
    response: InteractionResponse
) -> Dict[str, Any]:
    """
    Process form response.

    Responsibility: Enrich form_data with _item and _index.
    Does NOT validate - that's io.validate's job.
    """
    if response.cancelled:
        raise ModuleExecutionError(
            self.module_id,
            "User cancelled form input",
            None
        )

    form_data = response.form_data
    data = inputs.get('data', [])

    # Normalize to list
    if isinstance(form_data, dict):
        # Dict keyed by index → convert to list
        form_data = [form_data.get(str(i), {}) for i in range(len(data))]
    elif not isinstance(form_data, list):
        form_data = []

    # Enrich each item with _item and _index
    enriched = []
    for i, item_data in enumerate(form_data):
        enriched.append({
            "_item": data[i] if i < len(data) else None,
            "_index": i,
            **item_data
        })

    return {"form_data": enriched}
```

**What this does:**
- Normalizes form_data to list
- Adds `_item` and `_index` to each item
- Returns enriched data

**What this does NOT do:**
- Validate required fields (client's job)
- Validate schema compliance (io.validate's job)
- Filter items (transform.reshape's job)
- Check lengths (not needed if client sends correct data)

### Validation via io.validate at Group Exit

The execution group already auto-adds `io.validate` at exit:

```json
{
  "module_id": "io.validate",
  "name": "_aesthetic_selection_group_validator",
  "inputs": {
    "schema": { /* output_schema from group */ },
    "state_keys": ["aesthetic_selections", "total_concepts_required"]
  }
}
```

This validates that the group produced correct output, regardless of which path (webui/tui) was taken.

### Client-Side Validation (WebUI)

WebUI validates BEFORE submit using `input_schema`:

```typescript
// In FormInteraction.tsx
import { validateData } from '@/lib/validation';

const handleSubmit = () => {
  const result = validateData(formData, inputSchema);
  if (!result.valid) {
    setErrors(result.errors);
    return; // Don't submit
  }
  submitResponse(formData);
};
```

This is documented in the `unified_validation` issue.

## Before/After

### Module Input

```json
{
  "data": [
    {"id": "futuristic", "label": "Futuristic"},
    {"id": "mystical", "label": "Mystical"}
  ],
  "schema": { "input_schema": { ... } }
}
```

### Client Response

```json
{
  "form_data": [
    {"count": 2, "mode": "w"},
    {"count": 0, "mode": "e"}
  ]
}
```

### Module Output (Enriched)

```json
{
  "form_data": [
    {
      "_item": {"id": "futuristic", "label": "Futuristic"},
      "_index": 0,
      "count": 2,
      "mode": "w"
    },
    {
      "_item": {"id": "mystical", "label": "Mystical"},
      "_index": 1,
      "count": 0,
      "mode": "e"
    }
  ]
}
```

## Files Affected

1. **server/modules/user/form.py**
   - Remove `_validate_item` method
   - Add `_item` and `_index` enrichment
   - Simplify to single responsibility

2. **workflows/oms/.../07_aesthetic_selection_group.json**
   - Simplify webui_path after fix
   - Ensure `output_schema` is defined for io.validate

## Priority

**Critical**

## Testing Plan

1. Test user.form outputs `_item` and `_index`
2. Verify existing `_validate_item` is removed
3. Test io.validate catches invalid state at group exit
4. Test WebUI validates before submit (separate test)
5. End-to-end test full flow
