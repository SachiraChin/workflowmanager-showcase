# Issue: user.form Output Format Missing `_item` and `_index`

## Summary

The `user.form` module does not include `_item` (original data item) and `_index` (position in source array) in its output, as specified in the architecture documents. This causes the webui_path in aesthetic selection to require 5+ modules instead of the expected 2 modules.

## Architecture Reference

- **R5 Part 4**: "Generic `user.form` Module" - Section "Generic Output Structure"
- **R5 Part 7**: "Complete Example" - Shows webui_path with only 2 modules (user.form + transform.reshape)
- **R9 Part 8**: References the user.form module design from R5

## Expected Behavior (from R5)

### Per-Item Group Output Structure

```json
{
  "form_result": {
    "aesthetics": [
      {
        "_item": { "id": "futuristic", "label": "Futuristic", "description": "..." },
        "_index": 0,
        "count": 2,
        "mode": "w"
      },
      {
        "_item": { "id": "mystical", "label": "Mystical", "description": "..." },
        "_index": 1,
        "count": 0,
        "mode": "e"
      }
    ]
  }
}
```

**Key fields per item:**
- `_item`: Original item from data source (full object)
- `_index`: Position in original data array
- User input values (`count`, `mode`, etc.)

### Expected webui_path Module Count: 2

1. `user.form` - Collects input and outputs with `_item`/`_index`
2. `transform.reshape` - Transforms to workflow-specific format

## Actual Behavior

### Current user.form Output (from server/modules/user/form.py:216-218)

```python
return {
    "form_data": form_data
}
```

The `form_data` is passed directly from client response without enrichment:
- No `_item` field added
- No `_index` field added

### Actual webui_path Module Count: 5+

From `workflows/oms/steps/1_user_input/modules/07_aesthetic_selection_group.json`:

1. `user.form` (get_aesthetic_form) - Collects raw input
2. `transform.reshape` (reshape_form_data) - Manual reshape with index/item access via Jinja
3. `transform.extract` (filter_and_sum) - Filter and calculate totals
4. `io.write_state` (set_valid_state) - Set validation flags
5. `transform.render_template_array` (render_aesthetic_sections) - Render prompts

**Modules 2-4 exist because user.form output lacks `_item`/`_index`:**
- reshape_form_data manually accesses `aesthetics[$index]` from context_vars
- filter_and_sum extracts `_include` items that should be excluded by user.form's `filter_output`
- io.write_state sets validation state that should be part of io.validate auto-generation

## Root Cause Analysis

### Why the Discrepancy Exists

1. **Incomplete Implementation**: The user.form module was implemented with basic functionality but without the output enrichment specified in R5.

2. **Implementation Focus**: The implementation focused on the client interaction flow (request/response) rather than the output transformation responsibility.

3. **Workaround in Workflow**: The workflow author added extra modules to compensate for missing functionality, masking the underlying issue.

### Code Location

**server/modules/user/form.py:180-218** - `execute_with_response` method:
- Line 196: Gets `form_data` from response
- Lines 199-204: Handles dict/list conversion
- Lines 216-218: Returns `form_data` without enrichment

**Missing logic:**
```python
# Should be added before return
data = inputs.get('data', [])
enriched_form_data = []
for i, item_data in enumerate(form_data):
    enriched_item = {
        "_item": data[i] if i < len(data) else None,
        "_index": i,
        **item_data
    }
    enriched_form_data.append(enriched_item)
```

## Impact

### Immediate Impact

1. **Workflow Complexity**: webui_path requires 5+ modules instead of 2
2. **Maintenance Burden**: More modules to maintain and debug
3. **Error Prone**: Manual index management in Jinja templates (`aesthetics[$index]`)
4. **Inconsistency**: webui_path and tui_path have different module structures despite producing same output

### Architecture Violation

The design principle from R5 states:
> "user.form outputs clean, generic data structure. Any workflow-specific transformation happens in a separate transform.* module."

Current implementation violates this by requiring multiple transform modules to compensate for incomplete user.form output.

## Proposed Solution(s)

### Solution 1: Enrich Output in user.form Module (Recommended)

<!--I agree with solution 1, but dont think "enriched_items" is correct naming format. can you check other modules and see what they use for situations like this. Also, add examples on before and after json files so I can understand what server has before processing and what client gets after processing-->

Modify `server/modules/user/form.py` to add `_item` and `_index` to each output item.

```python
def execute_with_response(self, inputs, context, response):
    # ... existing validation code ...

    data = inputs.get('data', [])

    # Enrich each item with _item and _index
    enriched_form_data = []
    for i, item_data in enumerate(form_data):
        enriched_item = {
            "_item": data[i] if i < len(data) else None,
            "_index": i,
        }
        # Add user input values
        enriched_item.update(item_data)
        enriched_form_data.append(enriched_item)

    return {
        "form_data": enriched_form_data
    }
```

**Benefits:**
- Matches architecture specification
- Reduces workflow complexity
- Single source of truth for output format

### Solution 2: Add filter_output Support

Also implement `filter_output.exclude_when` from R5:

```python
def _apply_filter(self, enriched_data, filter_config):
    """Apply filter_output configuration."""
    if not filter_config:
        return enriched_data

    exclude_when = filter_config.get("exclude_when", {})
    if not exclude_when:
        return enriched_data

    return [
        item for item in enriched_data
        if not all(item.get(k) == v for k, v in exclude_when.items())
    ]
```

This would eliminate the need for `transform.extract` to filter items.

## Files Affected

1. **server/modules/user/form.py** - Add output enrichment logic
2. **workflows/oms/steps/1_user_input/modules/07_aesthetic_selection_group.json** - Simplify webui_path after fix
3. **webui/src/components/interactions/FormInteraction.tsx** - May need to verify client sends correct format

## Priority

**Critical**

**Justification:**
- Direct violation of architecture specification (R5)
- Causes 2.5x module bloat in workflows (5 modules instead of 2)
- Foundation issue that affects all user.form usage
- Fixing this enables proper workflow simplification

## Testing Plan

1. Unit test user.form module with sample data
2. Verify output contains `_item` and `_index` for each item
3. Test filter_output.exclude_when functionality
4. Update aesthetic_selection_group.json to use simplified structure
5. End-to-end test WebUI aesthetic selection flow
